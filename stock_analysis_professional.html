<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“ä¸šé‡åŒ–è‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: #0a0e27;
            color: #fff;
            padding: 10px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .header {
                padding: 20px 15px !important;
            }
            .header h1 {
                font-size: 22px !important;
            }
            .header p {
                font-size: 11px !important;
            }
            .search-section {
                padding: 15px !important;
            }
            .search-bar {
                flex-direction: column;
                gap: 10px !important;
            }
            .search-input {
                min-width: 100% !important;
                font-size: 16px !important;
                padding: 12px !important;
            }
            select {
                width: 100%;
                font-size: 16px !important;
                padding: 12px !important;
            }
            button {
                width: 100%;
                padding: 14px !important;
                font-size: 15px !important;
            }
            .category-btn {
                padding: 12px !important;
                font-size: 14px !important;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            .stat-card {
                padding: 15px !important;
            }
            .stat-value {
                font-size: 24px !important;
            }
            .chart-grid {
                grid-template-columns: 1fr !important;
            }
            .stock-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            .stock-item {
                padding: 12px !important;
            }
            .stock-name {
                font-size: 13px !important;
            }
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            .tab {
                white-space: nowrap;
                font-size: 13px;
                padding: 12px 20px;
                min-width: 120px;
            }
            .card {
                padding: 15px !important;
            }
            .card h2 {
                font-size: 18px !important;
            }
            .chart-container {
                height: 400px !important;
                padding: 10px !important;
            }
            .chart-container.large {
                height: 500px !important;
            }
            .chart-container.small {
                height: 350px !important;
            }
            .info-box {
                padding: 12px !important;
                font-size: 13px !important;
            }
            .company-info {
                grid-template-columns: 1fr !important;
            }
            .fundamentals-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .header h1 {
                font-size: 28px !important;
            }
            .stats-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            .chart-grid {
                grid-template-columns: 1fr !important;
            }
            .stock-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            .chart-container {
                height: 500px !important;
            }
            .chart-container.large {
                height: 650px !important;
            }
            .chart-container.small {
                height: 400px !important;
            }
            .company-info {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            .fundamentals-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        @media (min-width: 1025px) and (max-width: 1440px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .stock-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            .company-info {
                grid-template-columns: repeat(3, 1fr);
            }
            .fundamentals-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1441px) {
            .stats-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            .chart-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .stock-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            .company-info {
                grid-template-columns: repeat(4, 1fr);
            }
            .fundamentals-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .search-section {
            background: #1a1f3a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .search-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 300px;
            background: #0f1429;
            border: 2px solid #2d3561;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
        }
        .search-input:focus {
            outline: none;
            border-color: #4facfe;
        }
        select {
            background: #0f1429;
            border: 2px solid #2d3561;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        select:focus {
            outline: none;
            border-color: #4facfe;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #4facfe;
        }
        .loading.active {
            display: block;
        }
        .spinner {
            border: 4px solid #2d3561;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* æ·»åŠ è§¦æ‘¸ä¼˜åŒ– */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        button, .tab, .stock-item, .category-btn {
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        .period-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .period-btn {
            padding: 10px 18px;
            font-size: 13px;
            min-width: auto;
            flex: 0 0 auto;
        }
        
        .period-btn-active {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
        }
        
        @media (max-width: 768px) {
            .period-buttons {
                gap: 6px;
            }
            .period-btn {
                padding: 10px 14px !important;
                font-size: 12px !important;
                flex: 1 1 calc(33.333% - 6px);
                min-width: 0;
            }
        }
        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #2d3561;
        }
        .stat-card.bullish {
            background: linear-gradient(135deg, #134e48 0%, #267871 100%);
        }
        .stat-card.bearish {
            background: linear-gradient(135deg, #7b1e3d 0%, #a32952 100%);
        }
        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-change {
            font-size: 13px;
            opacity: 0.9;
        }
        .card {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .card h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #4facfe;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-container {
            background: #0f1429;
            border-radius: 8px;
            padding: 15px;
            height: 650px;
        }
        .chart-container.small {
            height: 500px;
        }
        .chart-container.large {
            height: 850px;
        }
        #candlestickChart {
            min-height: 800px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
        }
        .signals {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .signal {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid;
        }
        .signal.buy {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }
        .signal.sell {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        .signal.neutral {
            background: rgba(250, 204, 21, 0.2);
            border-color: #facc15;
            color: #facc15;
        }
        .indicator-panel {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .indicator-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #2d3561;
        }
        .indicator-row:last-child {
            border-bottom: none;
        }
        .indicator-name {
            color: #aaa;
            font-size: 14px;
        }
        .indicator-value {
            font-size: 15px;
            font-weight: bold;
        }
        .bullish-text {
            color: #22c55e;
        }
        .bearish-text {
            color: #ef4444;
        }
        .neutral-text {
            color: #facc15;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            background: #1a1f3a;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #2d3561;
            transition: all 0.3s;
            font-size: 14px;
        }
        .tab:hover {
            background: #2d3561;
            border-color: #4facfe;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        .info-box {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            margin-bottom: 15px;
        }
        .info-box h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #4facfe;
        }
        .info-box p {
            font-size: 14px;
            color: #aaa;
            line-height: 1.6;
        }
        .company-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .company-info-item {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
        }
        .company-info-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .company-info-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .error.active {
            display: block;
        }
        .category-btn {
            flex: 1;
            background: #1a1f3a;
            border: 2px solid #2d3561;
            color: #aaa;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .category-btn:hover {
            border-color: #4facfe;
            background: #2d3561;
        }
        .category-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }
        .category-content {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .stock-item {
            background: #0f1429;
            border: 2px solid #2d3561;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .stock-item:hover {
            border-color: #4facfe;
            background: #1a1f3a;
            transform: translateY(-2px);
        }
        .stock-item.selected {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        .stock-name {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        .stock-code {
            font-size: 12px;
            color: #888;
        }
        .fundamentals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .fundamental-item {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #4facfe;
        }
        .fundamental-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .fundamental-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        .financial-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .financial-table th {
            background: #0f1429;
            padding: 12px;
            text-align: left;
            color: #4facfe;
            font-size: 13px;
            border-bottom: 2px solid #2d3561;
        }
        .financial-table td {
            padding: 12px;
            border-bottom: 1px solid #2d3561;
            font-size: 14px;
        }
        .financial-table tr:hover {
            background: #0f1429;
        }
        .news-item {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #4facfe;
            cursor: pointer;
            transition: all 0.3s;
        }
        .news-item:hover {
            background: #1a1f3a;
            border-left-color: #22c55e;
            transform: translateX(5px);
        }
        .news-title {
            font-size: 15px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .news-meta {
            font-size: 12px;
            color: #888;
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
        }
        .news-summary {
            font-size: 13px;
            color: #aaa;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ä¸“ä¸šé‡åŒ–è‚¡ç¥¨åˆ†æç³»ç»Ÿ</h1>
            <p style="color: #aaa;">å®æ—¶æ•°æ®è·å– Â· å…¨é‡æŠ€æœ¯æŒ‡æ ‡ Â· Kçº¿å›¾åˆ†æ Â· åŸºæœ¬é¢ç ”ç©¶</p>
        </div>

        <div class="search-section">
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <button onclick="switchCategory('stock')" id="stockCategoryBtn" class="category-btn active">
                        ğŸ“Š è‚¡ç¥¨å¸‚åœº
                    </button>
                    <button onclick="switchCategory('fund')" id="fundCategoryBtn" class="category-btn">
                        ğŸ’¼ åŸºé‡‘å¸‚åœº
                    </button>
                </div>
            </div>

            <div id="stockCategory" class="category-content">
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 10px;">ğŸ“ˆ çƒ­é—¨è‚¡ç¥¨</h3>
                    <div class="stock-grid" id="stockGrid"></div>
                </div>
            </div>

            <div id="fundCategory" class="category-content" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 10px;">ğŸ’¼ çƒ­é—¨åŸºé‡‘</h3>
                    <div class="stock-grid" id="fundGrid"></div>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #2d3561;">
                <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 15px;">ğŸ” è‡ªå®šä¹‰æœç´¢</h3>
                <div class="search-bar">
                    <input type="text" class="search-input" id="stockCode" placeholder="è¾“å…¥è‚¡ç¥¨/åŸºé‡‘ä»£ç ï¼ˆå¦‚ï¼šAAPL, 600519.SS, 000001.SZï¼‰" />
                    <select id="dataSource">
                        <option value="yahoo">Yahoo Financeï¼ˆå…¨çƒå¸‚åœºï¼‰</option>
                        <option value="sina">æ–°æµªè´¢ç»ï¼ˆAè‚¡å®æ—¶ï¼‰</option>
                        <option value="eastmoney">ä¸œæ–¹è´¢å¯Œï¼ˆAè‚¡ä¸“ä¸šï¼‰</option>
                        <option value="tencent">è…¾è®¯è´¢ç»ï¼ˆå›½å†…æ•°æ®ï¼‰</option>
                        <option value="netease">ç½‘æ˜“è´¢ç»ï¼ˆAè‚¡æ¸¯è‚¡ï¼‰</option>
                        <option value="alphavantage">Alpha Vantageï¼ˆå›½é™…ï¼‰</option>
                        <option value="finnhub">Finnhubï¼ˆå…¨çƒè‚¡ç¥¨ï¼‰</option>
                        <option value="polygon">Polygon.ioï¼ˆç¾è‚¡ä¸“ä¸šï¼‰</option>
                        <option value="twelvedata">Twelve Dataï¼ˆå…¨å¸‚åœºï¼‰</option>
                        <option value="iexcloud">IEX Cloudï¼ˆç¾è‚¡ï¼‰</option>
                    </select>
                    <select id="klineType">
                        <option value="1m">1åˆ†é’Ÿ</option>
                        <option value="5m">5åˆ†é’Ÿ</option>
                        <option value="15m">15åˆ†é’Ÿ</option>
                        <option value="30m">30åˆ†é’Ÿ</option>
                        <option value="60m">60åˆ†é’Ÿ</option>
                        <option value="120m">120åˆ†é’Ÿ</option>
                        <option value="1d" selected>æ—¥K</option>
                        <option value="1wk">å‘¨K</option>
                        <option value="1mo">æœˆK</option>
                    </select>
                    <select id="timeRange">
                        <option value="1d">1å¤©</option>
                        <option value="5d">5å¤©</option>
                        <option value="1mo">1ä¸ªæœˆ</option>
                        <option value="3mo" selected>3ä¸ªæœˆ</option>
                        <option value="6mo">6ä¸ªæœˆ</option>
                        <option value="1y">1å¹´</option>
                        <option value="2y">2å¹´</option>
                        <option value="5y">5å¹´</option>
                    </select>
                    <button onclick="fetchStockData()" id="searchBtn">ğŸ” è·å–æ•°æ®</button>
                </div>
                <div style="margin-top: 15px;">
                    <h4 style="color: #4facfe; font-size: 14px; margin-bottom: 10px;">âš¡ å¿«é€Ÿå‘¨æœŸåˆ‡æ¢</h4>
                    <div class="period-buttons">
                        <button onclick="quickSelectPeriod('1m', '1d')" class="period-btn">1åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('5m', '1d')" class="period-btn">5åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('15m', '5d')" class="period-btn">15åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('30m', '5d')" class="period-btn">30åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('60m', '1mo')" class="period-btn">60åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('120m', '1mo')" class="period-btn">120åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('1d', '3mo')" class="period-btn period-btn-active">æ—¥K</button>
                        <button onclick="quickSelectPeriod('1wk', '1y')" class="period-btn">å‘¨K</button>
                        <button onclick="quickSelectPeriod('1mo', '5y')" class="period-btn">æœˆK</button>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #888;">
                    <strong>æç¤ºï¼š</strong>
                    ç¾è‚¡ç›´æ¥è¾“å…¥ä»£ç ï¼ˆå¦‚ AAPLï¼‰ï¼Œ
                    Aè‚¡ä¸Šæµ·åŠ  .SSï¼ˆå¦‚ 600519.SSï¼‰ï¼Œ
                    æ·±åœ³åŠ  .SZï¼ˆå¦‚ 000001.SZï¼‰ï¼Œ
                    æ¸¯è‚¡åŠ  .HKï¼ˆå¦‚ 0700.HKï¼‰
                    <br>
                    <span style="color: #facc15;">ğŸ’¡ å¿«é€Ÿå‘¨æœŸåˆ‡æ¢ï¼šå…ˆé€‰æ‹©è‚¡ç¥¨ï¼Œç„¶åç‚¹å‡»ä¸Šæ–¹çš„å‘¨æœŸæŒ‰é’®å³å¯å¿«é€Ÿåˆ‡æ¢ä¸åŒå‘¨æœŸçš„Kçº¿å›¾</span>
                </div>
            </div>
        </div>

        <div id="errorMsg" class="error"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div id="results" style="display: none;">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="card" id="companyInfoCard">
                <h2>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h2>
                <div class="company-info" id="companyInfo"></div>
            </div>

            <!-- åŸºæœ¬é¢æ•°æ® -->
            <div class="card" id="fundamentalsCard">
                <h2>ğŸ’° åŸºæœ¬é¢åˆ†æ</h2>
                <div class="fundamentals-grid" id="fundamentalsData"></div>
            </div>

            <!-- è´¢æŠ¥æ•°æ® -->
            <div class="card" id="financialReportsCard">
                <h2>ğŸ“Š è´¢åŠ¡æŠ¥è¡¨</h2>
                <div id="financialReports"></div>
            </div>

            <!-- æœ€æ–°æ–°é—» -->
            <div class="card" id="newsCard">
                <h2>ğŸ“° ç›¸å…³æ–°é—»</h2>
                <div id="newsList"></div>
            </div>

            <!-- å®æ—¶æ•°æ® -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- å½“å‰å‘¨æœŸä¿¡æ¯ -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">å½“å‰å‘¨æœŸ</div>
                        <div style="font-size: 24px; font-weight: bold; margin-top: 5px;" id="currentPeriodDisplay">æ—¥Kçº¿ - 3ä¸ªæœˆ</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; opacity: 0.9;">æ•°æ®æ¡æ•°</div>
                        <div style="font-size: 24px; font-weight: bold; margin-top: 5px;" id="dataCountDisplay">-</div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯ä¿¡å· -->
            <div class="card">
                <h2>ğŸ¯ ç»¼åˆæŠ€æœ¯ä¿¡å·</h2>
                <div class="signals" id="signals"></div>
                <div class="indicator-panel" id="indicatorPanel"></div>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('overview')">ğŸ“ˆ å¸‚åœºæ€»è§ˆ</div>
                <div class="tab" onclick="switchTab('technical')">ğŸ“Š æŠ€æœ¯æŒ‡æ ‡</div>
                <div class="tab" onclick="switchTab('volume')">ğŸ“¦ é‡ä»·åˆ†æ</div>
                <div class="tab" onclick="switchTab('pattern')">ğŸ” å½¢æ€è¯†åˆ«</div>
            </div>

            <!-- æ€»è§ˆ -->
            <div id="overview" class="content active">
                <div class="card">
                    <h2>ğŸ“Š Kçº¿å›¾ä¸å‡çº¿ç³»ç»Ÿ</h2>
                    <div class="chart-container large">
                        <div id="candlestickChart"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ å¸ƒæ—å¸¦åˆ†æï¼ˆBollinger Bandsï¼‰</h2>
                    <div class="chart-container">
                        <div id="bollingerChart"></div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯æŒ‡æ ‡ -->
            <div id="technical" class="content">
                <div class="chart-grid">
                    <div class="card">
                        <h2>ğŸ“‰ MACDæŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>å¹³æ»‘å¼‚åŒç§»åŠ¨å¹³å‡çº¿ï¼Œç”¨äºåˆ¤æ–­ä¹°å–æ—¶æœºã€‚DIFä¸Šç©¿DEAä¸ºé‡‘å‰ï¼ˆä¹°å…¥ï¼‰ï¼Œä¸‹ç©¿ä¸ºæ­»å‰ï¼ˆå–å‡ºï¼‰ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="macdChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š KDJéšæœºæŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>éšæœºæ‘†åŠ¨æŒ‡æ ‡ï¼ŒKå€¼>80è¶…ä¹°ï¼Œ<20è¶…å–ã€‚Jå€¼æœ€æ•æ„Ÿï¼Œå¯æå‰å‘ç°è½¬æŠ˜ç‚¹ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="kdjChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“ˆ RSIç›¸å¯¹å¼ºå¼±æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>ç›¸å¯¹å¼ºå¼±æŒ‡æ•°ï¼Œ>70è¶…ä¹°åŒºåŸŸï¼Œ<30è¶…å–åŒºåŸŸã€‚50ä¸ºå¼ºå¼±åˆ†ç•Œçº¿ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="rsiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š å¨å»‰æŒ‡æ ‡ï¼ˆWRï¼‰</h2>
                        <div class="info-box">
                            <p>å¨å»‰è¶…ä¹°è¶…å–æŒ‡æ ‡ï¼Œ>-20ä¸ºè¶…ä¹°ï¼Œ<-80ä¸ºè¶…å–ã€‚ä¸ä»·æ ¼å½¢æˆèƒŒç¦»æ—¶ä¸ºåè½¬ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="wrChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“‰ CCIé¡ºåŠ¿æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>å•†å“è·¯å¾„æŒ‡æ ‡ï¼Œ>100ä¸ºè¶…ä¹°ï¼Œ<-100ä¸ºè¶…å–ã€‚ç©¿è¶Š0è½´ä¸ºè¶‹åŠ¿æ”¹å˜ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="cciChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š DMIè¶‹å‘æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>åŠ¨å‘æŒ‡æ ‡ï¼ŒPDIä¸Šç©¿MDIçœ‹å¤šï¼Œä¸‹ç©¿çœ‹ç©ºã€‚ADX>25è¡¨ç¤ºè¶‹åŠ¿å¼ºåŠ²ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="dmiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ¯ SARæŠ›ç‰©çº¿æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>ç‚¹ä½åœ¨ä»·æ ¼ä¸‹æ–¹ä¸ºçœ‹æ¶¨ï¼Œä¸Šæ–¹ä¸ºçœ‹è·Œã€‚SARè½¬å‘æ—¶æä¾›æ˜ç¡®çš„æ­¢æŸæˆ–åè½¬ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="sarChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š TRIXæŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>ä¸‰é‡æŒ‡æ•°å¹³æ»‘ç§»åŠ¨å¹³å‡ï¼Œè¿‡æ»¤çŸ­æœŸå™ªéŸ³ã€‚ä¸Šç©¿é›¶è½´çœ‹å¤šï¼Œä¸‹ç©¿çœ‹ç©ºã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="trixChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š ATRæ³¢åŠ¨ç‡æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>è¡¡é‡å¸‚åœºæ³¢åŠ¨æ€§ï¼Œå€¼è¶Šå¤§æ³¢åŠ¨è¶Šå‰§çƒˆã€‚å¸¸ç”¨äºè®¾ç½®åŠ¨æ€æ­¢æŸä½ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="atrChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š StochéšæœºæŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>å¿«é€ŸéšæœºæŒ‡æ ‡ï¼ŒKçº¿å’ŒDçº¿ã€‚>80è¶…ä¹°ï¼Œ<20è¶…å–ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="stochChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š MOMåŠ¨é‡æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>è¡¡é‡ä»·æ ¼å˜åŒ–é€Ÿåº¦ã€‚ç©¿è¶Šé›¶è½´ä¸ºè¶‹åŠ¿æ”¹å˜ï¼Œä¸ä»·æ ¼èƒŒç¦»ä¸ºåè½¬ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="momChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ’° MFIèµ„é‡‘æµé‡æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>æˆäº¤é‡åŠ æƒçš„RSIï¼Œè¡¡é‡èµ„é‡‘æµå…¥æµå‡ºåŠ›åº¦ã€‚>80è¶…ä¹°ï¼Œ<20è¶…å–ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="mfiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“ˆ ä¸€ç›®å‡è¡¡è¡¨ (Ichimoku)</h2>
                        <div class="info-box">
                            <p>ç»¼åˆè¶‹åŠ¿ç³»ç»Ÿï¼ŒåŒ…å«è½¬æ¢çº¿ã€åŸºå‡†çº¿ã€å…ˆè¡Œå¸¦ï¼ˆäº‘å±‚ï¼‰ã€‚ä»·æ ¼åœ¨äº‘å±‚ä¸Šæ–¹ä¸ºå¤šå¤´ï¼Œä¸‹æ–¹ä¸ºç©ºå¤´ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="ichimokuChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é‡ä»·åˆ†æ -->
            <div id="volume" class="content">
                <div class="card">
                    <h2>ğŸ“¦ æˆäº¤é‡åˆ†æ</h2>
                    <div class="info-box">
                        <p>ä»·æ¶¨é‡å¢ä¸ºæ­£å¸¸ä¸Šæ¶¨ï¼Œä»·æ¶¨é‡ç¼©éœ€è°¨æ…ã€‚ä»·è·Œé‡å¢ä¸ºæ€è·Œï¼Œä»·è·Œé‡ç¼©ä¸ºè‡ªç„¶å›è°ƒã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š OBVèƒ½é‡æ½®</h2>
                    <div class="info-box">
                        <p>ç´¯ç§¯èƒ½é‡çº¿ï¼Œä»·å‡é‡å¢OBVä¸Šå‡ï¼Œä»·è·Œé‡å¢OBVä¸‹é™ã€‚OBVä¸ä»·æ ¼èƒŒç¦»ä¸ºåè½¬ä¿¡å·ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="obvChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ é‡æ¯”åˆ†æ</h2>
                    <div class="info-box">
                        <p>å½“æ—¥æ¯åˆ†é’Ÿå¹³å‡æˆäº¤é‡ä¸è¿‡å»5æ—¥æ¯åˆ†é’Ÿå¹³å‡æˆäº¤é‡çš„æ¯”å€¼ã€‚>1æ”¾é‡ï¼Œ<1ç¼©é‡ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="volumeRatioChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š VRæˆäº¤é‡æ¯”ç‡</h2>
                    <div class="info-box">
                        <p>æˆäº¤é‡ä¸ä»·æ ¼å˜åŠ¨å…³ç³»ã€‚VR>160è¶…ä¹°ï¼Œ<40è¶…å–ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="vrChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ BRARäººæ°”æ„æ„¿æŒ‡æ ‡</h2>
                    <div class="info-box">
                        <p>BRåæ˜ äººæ°”ï¼ŒARåæ˜ æ„æ„¿ã€‚BRã€AR>150è¶…ä¹°ï¼Œ<50è¶…å–ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="brarChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>âš¡ CRèƒ½é‡æŒ‡æ ‡</h2>
                    <div class="info-box">
                        <p>è¡¡é‡äººæ°”ä¸ä»·æ ¼åŠ¨é‡ã€‚>300è¶…ä¹°ï¼Œ<40è¶…å–ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="crChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š A/D Lineé›†æ•£çº¿</h2>
                    <div class="info-box">
                        <p>è¡¡é‡èµ„é‡‘æµå…¥æµå‡ºã€‚ADLä¸ä»·æ ¼åŒå‘è¿åŠ¨ç¡®è®¤è¶‹åŠ¿ï¼ŒèƒŒç¦»é¢„ç¤ºåè½¬ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="adlChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- å½¢æ€è¯†åˆ« -->
            <div id="pattern" class="content">
                <div class="card">
                    <h2>ğŸ” Kçº¿å½¢æ€è¯†åˆ«</h2>
                    <div id="patternResults"></div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š æ”¯æ’‘å‹åŠ›ä½</h2>
                    <div class="chart-container small">
                        <div id="supportResistanceChart"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ è¶‹åŠ¿çº¿åˆ†æ</h2>
                    <div id="trendAnalysis"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let stockData = null;
        let currentSymbol = '';

        // çƒ­é—¨è‚¡ç¥¨åˆ—è¡¨ï¼ˆæ‰©å±•ç‰ˆï¼‰
        const stockList = [
            // ç¾è‚¡ç§‘æŠ€
            { name: 'è‹¹æœ', code: 'AAPL', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'å¾®è½¯', code: 'MSFT', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'è°·æ­Œ', code: 'GOOGL', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'äºšé©¬é€Š', code: 'AMZN', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'ç‰¹æ–¯æ‹‰', code: 'TSLA', market: 'ç¾è‚¡', category: 'æ±½è½¦' },
            { name: 'è‹±ä¼Ÿè¾¾', code: 'NVDA', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'è„¸ä¹¦', code: 'META', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'å¥ˆé£', code: 'NFLX', market: 'ç¾è‚¡', category: 'åª’ä½“' },
            { name: 'è‹±ç‰¹å°”', code: 'INTC', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'AMD', code: 'AMD', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'å°ç§¯ç”µ', code: 'TSM', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'è¿ªå£«å°¼', code: 'DIS', market: 'ç¾è‚¡', category: 'åª’ä½“' },
            { name: 'å¯å£å¯ä¹', code: 'KO', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'ç™¾äº‹å¯ä¹', code: 'PEP', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'éº¦å½“åŠ³', code: 'MCD', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'è€å…‹', code: 'NKE', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'æ˜Ÿå·´å…‹', code: 'SBUX', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'æ³¢éŸ³', code: 'BA', market: 'ç¾è‚¡', category: 'å·¥ä¸š' },
            { name: 'åŸƒå…‹æ£®ç¾å­š', code: 'XOM', market: 'ç¾è‚¡', category: 'èƒ½æº' },
            { name: 'é›ªä½›é¾™', code: 'CVX', market: 'ç¾è‚¡', category: 'èƒ½æº' },
            // ç¾è‚¡é‡‘è
            { name: 'æ‘©æ ¹å¤§é€š', code: 'JPM', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'ç¾å›½é“¶è¡Œ', code: 'BAC', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'å¯Œå›½é“¶è¡Œ', code: 'WFC', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'é«˜ç››', code: 'GS', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'ä¼¯å…‹å¸Œå°”', code: 'BRK-B', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'ç»´è¨', code: 'V', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'ä¸‡äº‹è¾¾', code: 'MA', market: 'ç¾è‚¡', category: 'é‡‘è' },
            // Aè‚¡ä¸»æ¿
            { name: 'è´µå·èŒ…å°', code: '600519.SS', market: 'Aè‚¡', category: 'æ¶ˆè´¹' },
            { name: 'ä¸­å›½å¹³å®‰', code: '601318.SS', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'æ‹›å•†é“¶è¡Œ', code: '600036.SS', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'äº”ç²®æ¶²', code: '000858.SZ', market: 'Aè‚¡', category: 'æ¶ˆè´¹' },
            { name: 'ç¾çš„é›†å›¢', code: '000333.SZ', market: 'Aè‚¡', category: 'å®¶ç”µ' },
            { name: 'æ ¼åŠ›ç”µå™¨', code: '000651.SZ', market: 'Aè‚¡', category: 'å®¶ç”µ' },
            { name: 'ä¸­å›½ç§»åŠ¨', code: '600941.SS', market: 'Aè‚¡', category: 'é€šä¿¡' },
            { name: 'å·¥å•†é“¶è¡Œ', code: '601398.SS', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'å»ºè®¾é“¶è¡Œ', code: '601939.SS', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'ä¸­å›½çŸ³æ²¹', code: '601857.SS', market: 'Aè‚¡', category: 'èƒ½æº' },
            { name: 'ä¸­å›½çŸ³åŒ–', code: '600028.SS', market: 'Aè‚¡', category: 'èƒ½æº' },
            { name: 'æµ·å¤©å‘³ä¸š', code: '603288.SS', market: 'Aè‚¡', category: 'æ¶ˆè´¹' },
            { name: 'æ’ç‘åŒ»è¯', code: '600276.SS', market: 'Aè‚¡', category: 'åŒ»è¯' },
            { name: 'è¯æ˜åº·å¾·', code: '603259.SS', market: 'Aè‚¡', category: 'åŒ»è¯' },
            { name: 'éš†åŸºç»¿èƒ½', code: '601012.SS', market: 'Aè‚¡', category: 'æ–°èƒ½æº' },
            { name: 'ä¸‰ä¸€é‡å·¥', code: '600031.SS', market: 'Aè‚¡', category: 'æœºæ¢°' },
            // åˆ›ä¸šæ¿/ç§‘åˆ›æ¿
            { name: 'å®å¾·æ—¶ä»£', code: '300750.SZ', market: 'Aè‚¡', category: 'æ–°èƒ½æº' },
            { name: 'æ¯”äºšè¿ª', code: '002594.SZ', market: 'Aè‚¡', category: 'æ±½è½¦' },
            { name: 'è¿ˆç‘åŒ»ç–—', code: '300760.SZ', market: 'Aè‚¡', category: 'åŒ»ç–—' },
            { name: 'ä¸œæ–¹è´¢å¯Œ', code: '300059.SZ', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'æ±‡å·æŠ€æœ¯', code: '300124.SZ', market: 'Aè‚¡', category: 'å·¥æ§' },
            // æ¸¯è‚¡
            { name: 'è…¾è®¯æ§è‚¡', code: '0700.HK', market: 'æ¸¯è‚¡', category: 'ç§‘æŠ€' },
            { name: 'é˜¿é‡Œå·´å·´', code: '9988.HK', market: 'æ¸¯è‚¡', category: 'ç§‘æŠ€' },
            { name: 'ç¾å›¢', code: '3690.HK', market: 'æ¸¯è‚¡', category: 'äº’è”ç½‘' },
            { name: 'äº¬ä¸œ', code: '9618.HK', market: 'æ¸¯è‚¡', category: 'ç”µå•†' },
            { name: 'å°ç±³é›†å›¢', code: '1810.HK', market: 'æ¸¯è‚¡', category: 'ç§‘æŠ€' },
            { name: 'æ¯”äºšè¿ªè‚¡ä»½', code: '1211.HK', market: 'æ¸¯è‚¡', category: 'æ±½è½¦' },
            { name: 'ä¸­å›½ç§»åŠ¨', code: '0941.HK', market: 'æ¸¯è‚¡', category: 'é€šä¿¡' }
        ];

        // çƒ­é—¨åŸºé‡‘åˆ—è¡¨ï¼ˆæ‰©å±•ç‰ˆ - ä½¿ç”¨ETFä»£ç ï¼‰
        const fundList = [
            // ç¾å›½å®½åŸºæŒ‡æ•°ETF
            { name: 'æ ‡æ™®500ETF', code: 'SPY', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'çº³æ–¯è¾¾å…‹100ETF', code: 'QQQ', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'é“ç¼æ–¯ETF', code: 'DIA', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'ç½—ç´ 2000ETF', code: 'IWM', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'æ ‡æ™®400ä¸­ç›˜ETF', code: 'MDY', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            // ç¾å›½è¡Œä¸šETF
            { name: 'ç§‘æŠ€è‚¡ETF', code: 'XLK', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'é‡‘èè‚¡ETF', code: 'XLF', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'åŒ»ç–—è‚¡ETF', code: 'XLV', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'èƒ½æºè‚¡ETF', code: 'XLE', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'æ¶ˆè´¹ETF', code: 'XLP', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'å·¥ä¸šETF', code: 'XLI', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'æˆ¿åœ°äº§ETF', code: 'XLRE', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'å…¬ç”¨äº‹ä¸šETF', code: 'XLU', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'ææ–™ETF', code: 'XLB', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'é€šä¿¡ETF', code: 'XLC', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            // ç¾å›½ä¸»é¢˜ETF
            { name: 'åŠå¯¼ä½“ETF', code: 'SOXX', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'ç”Ÿç‰©ç§‘æŠ€ETF', code: 'IBB', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'äº‘è®¡ç®—ETF', code: 'SKYY', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'ç½‘ç»œå®‰å…¨ETF', code: 'HACK', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'æ¸…æ´èƒ½æºETF', code: 'ICLN', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'ç”µåŠ¨è½¦ETF', code: 'DRIV', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            // å›½é™…å¸‚åœºETF
            { name: 'æ–°å…´å¸‚åœºETF', code: 'EEM', market: 'ç¾å›½', category: 'å›½é™…' },
            { name: 'ä¸­å›½ETF', code: 'FXI', market: 'ç¾å›½', category: 'å›½é™…' },
            { name: 'æ¬§æ´²ETF', code: 'VGK', market: 'ç¾å›½', category: 'å›½é™…' },
            { name: 'æ—¥æœ¬ETF', code: 'EWJ', market: 'ç¾å›½', category: 'å›½é™…' },
            { name: 'å°åº¦ETF', code: 'INDA', market: 'ç¾å›½', category: 'å›½é™…' },
            // å•†å“ETF
            { name: 'é»„é‡‘ETF', code: 'GLD', market: 'ç¾å›½', category: 'å•†å“' },
            { name: 'ç™½é“¶ETF', code: 'SLV', market: 'ç¾å›½', category: 'å•†å“' },
            { name: 'çŸ³æ²¹ETF', code: 'USO', market: 'ç¾å›½', category: 'å•†å“' },
            { name: 'å¤©ç„¶æ°”ETF', code: 'UNG', market: 'ç¾å›½', category: 'å•†å“' },
            // å€ºåˆ¸ETF
            { name: 'ç¾å›½å›½å€ºETF', code: 'TLT', market: 'ç¾å›½', category: 'å€ºåˆ¸' },
            { name: 'å…¬å¸å€ºETF', code: 'LQD', market: 'ç¾å›½', category: 'å€ºåˆ¸' },
            { name: 'é«˜æ”¶ç›Šå€ºETF', code: 'HYG', market: 'ç¾å›½', category: 'å€ºåˆ¸' },
            // ä¸­å›½å®½åŸºETF
            { name: 'æ²ªæ·±300ETF', code: '510300.SS', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'ä¸­è¯500ETF', code: '510500.SS', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'åˆ›ä¸šæ¿ETF', code: '159915.SZ', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'ç§‘åˆ›50ETF', code: '588000.SS', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'ä¸Šè¯50ETF', code: '510050.SS', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'æ·±è¯100ETF', code: '159901.SZ', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            // ä¸­å›½è¡Œä¸šETF
            { name: 'æ¶ˆè´¹ETF', code: '159928.SZ', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'åŒ»è¯ETF', code: '512010.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'åˆ¸å•†ETF', code: '512000.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'é“¶è¡ŒETF', code: '512800.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'å†›å·¥ETF', code: '512660.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'èŠ¯ç‰‡ETF', code: '512760.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'æ–°èƒ½æºè½¦ETF', code: '515030.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'å…‰ä¼ETF', code: '515790.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            // ä¸­å›½å…¶ä»–ETF
            { name: 'æ’ç”ŸETF', code: '159920.SZ', market: 'ä¸­å›½', category: 'æ¸¯è‚¡' },
            { name: 'çº¢åˆ©ETF', code: '510880.SS', market: 'ä¸­å›½', category: 'ç­–ç•¥' },
            { name: 'Hè‚¡ETF', code: '510900.SS', market: 'ä¸­å›½', category: 'æ¸¯è‚¡' }
        ];

        // åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            initStockGrid();
            initFundGrid();
        };

        // åˆå§‹åŒ–è‚¡ç¥¨åˆ—è¡¨
        function initStockGrid() {
            const grid = document.getElementById('stockGrid');
            grid.innerHTML = stockList.map(stock => `
                <div class="stock-item" onclick="selectStock('${stock.code}', '${stock.name}')">
                    <div class="stock-name">${stock.name}</div>
                    <div class="stock-code">${stock.code}</div>
                    <div class="stock-code">${stock.market}</div>
                </div>
            `).join('');
        }

        // åˆå§‹åŒ–åŸºé‡‘åˆ—è¡¨
        function initFundGrid() {
            const grid = document.getElementById('fundGrid');
            grid.innerHTML = fundList.map(fund => `
                <div class="stock-item" onclick="selectStock('${fund.code}', '${fund.name}')">
                    <div class="stock-name">${fund.name}</div>
                    <div class="stock-code">${fund.code}</div>
                    <div class="stock-code">${fund.market}</div>
                </div>
            `).join('');
        }

        // åˆ‡æ¢åˆ†ç±»
        function switchCategory(category) {
            document.getElementById('stockCategoryBtn').classList.remove('active');
            document.getElementById('fundCategoryBtn').classList.remove('active');
            document.getElementById('stockCategory').style.display = 'none';
            document.getElementById('fundCategory').style.display = 'none';

            if (category === 'stock') {
                document.getElementById('stockCategoryBtn').classList.add('active');
                document.getElementById('stockCategory').style.display = 'block';
            } else {
                document.getElementById('fundCategoryBtn').classList.add('active');
                document.getElementById('fundCategory').style.display = 'block';
            }
        }

        // é€‰æ‹©è‚¡ç¥¨/åŸºé‡‘
        function selectStock(code, name) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.stock-item').forEach(item => {
                item.classList.remove('selected');
            });
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            event.currentTarget.classList.add('selected');
            
            // è®¾ç½®ä»£ç å¹¶è·å–æ•°æ®
            document.getElementById('stockCode').value = code;
            currentSymbol = code;
            fetchStockData();
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            // å¤„ç†æ¢è¡Œç¬¦
            errorDiv.innerHTML = message.replace(/\n/g, '<br>');
            errorDiv.classList.add('active');
            
            // æ»šåŠ¨åˆ°é”™è¯¯ä½ç½®
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 10ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => errorDiv.classList.remove('active'), 10000);
        }

        // å¿«é€Ÿé€‰æ‹©å‘¨æœŸ
        function quickSelectPeriod(klineType, range) {
            if (!document.getElementById('stockCode').value.trim()) {
                showError('è¯·å…ˆé€‰æ‹©æˆ–è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            document.getElementById('klineType').value = klineType;
            document.getElementById('timeRange').value = range;
            fetchStockData();
        }

        // è·å–è‚¡ç¥¨æ•°æ®
        async function fetchStockData() {
            const stockCode = document.getElementById('stockCode').value.trim();
            const dataSource = document.getElementById('dataSource').value;
            const timeRange = document.getElementById('timeRange').value;
            const klineType = document.getElementById('klineType').value;

            if (!stockCode) {
                showError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            console.log('=== å¼€å§‹è·å–æ•°æ® ===');
            console.log('è‚¡ç¥¨ä»£ç :', stockCode);
            console.log('æ•°æ®æº:', dataSource);
            console.log('Kçº¿å‘¨æœŸ:', klineType);
            console.log('æ—¶é—´èŒƒå›´:', timeRange);

            // æ ¹æ®Kçº¿ç±»å‹è°ƒæ•´æ—¶é—´èŒƒå›´
            let adjustedRange = timeRange;
            if (klineType.includes('m')) {
                // åˆ†æ—¶æ•°æ®ï¼Œé™åˆ¶æ—¶é—´èŒƒå›´
                if (!['1d', '5d', '1mo'].includes(timeRange)) {
                    adjustedRange = '5d';
                    console.log('âš ï¸ åˆ†æ—¶æ•°æ®è‡ªåŠ¨è°ƒæ•´æ—¶é—´èŒƒå›´ä¸º5å¤©');
                }
            }

            document.getElementById('loading').classList.add('active');
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('results').style.display = 'none';

            try {
                let data;
                if (dataSource === 'yahoo') {
                    data = await fetchFromYahoo(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'sina') {
                    data = await fetchFromSina(stockCode);
                } else if (dataSource === 'eastmoney') {
                    data = await fetchFromEastMoney(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'tencent') {
                    data = await fetchFromTencent(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'netease') {
                    data = await fetchFromNetease(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'alphavantage') {
                    data = await fetchFromAlphaVantage(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'finnhub') {
                    data = await fetchFromFinnhub(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'polygon') {
                    data = await fetchFromPolygon(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'twelvedata') {
                    data = await fetchFromTwelveData(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'iexcloud') {
                    data = await fetchFromIEXCloud(stockCode, adjustedRange, klineType);
                } else {
                    showError('è¯¥æ•°æ®æºæš‚æœªå®ç°ï¼Œè¯·é€‰æ‹©å…¶ä»–æ•°æ®æº');
                    return;
                }

                if (data && data.length > 0) {
                    stockData = data;
                    analyzeAndDisplay(data);
                    // æ¸…é™¤é”™è¯¯ä¿¡æ¯
                    document.getElementById('errorMsg').classList.remove('active');
                } else {
                    showError('æœªèƒ½è·å–æ•°æ®ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®');
                }
            } catch (error) {
                console.error('Error:', error);
                let errorMsg = error.message || 'æ•°æ®è·å–å¤±è´¥';
                
                // æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º
                if (errorMsg.includes('HTTP error')) {
                    errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•';
                } else if (errorMsg.includes('æœªæ‰¾åˆ°æ•°æ®')) {
                    errorMsg = `è‚¡ç¥¨ä»£ç "${stockCode}"å¯èƒ½ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥ï¼š\n- ç¾è‚¡ç›´æ¥è¾“å…¥ä»£ç ï¼ˆå¦‚ AAPLï¼‰\n- Aè‚¡ä¸Šæµ·åŠ  .SSï¼ˆå¦‚ 600519.SSï¼‰\n- Aè‚¡æ·±åœ³åŠ  .SZï¼ˆå¦‚ 000001.SZï¼‰\n- æ¸¯è‚¡åŠ  .HKï¼ˆå¦‚ 0700.HKï¼‰`;
                }
                
                showError(errorMsg);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('searchBtn').disabled = false;
            }
        }

        // æ•°æ®æºé…ç½®ï¼ˆåªä¿ç•™æœ€ç¨³å®šçš„ï¼‰
        const dataSources = [
            {
                name: 'Yahoo Finance via CORS Proxy',
                fetch: async (symbol, range) => {
                    const period1 = Math.floor(Date.now() / 1000) - getRangeSeconds(range);
                    const period2 = Math.floor(Date.now() / 1000);
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=1d`;
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return await response.json();
                }
            }
        ];

        // å¤šæ•°æ®æºé…ç½®ï¼ˆæ›´å¤šé€‰æ‹©ï¼‰
        const multiDataSources = [
            {
                name: 'AllOrigins Proxy',
                getUrl: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
            },
            {
                name: 'CORS Anywhere',
                getUrl: (url) => `https://cors-anywhere.herokuapp.com/${url}`
            },
            {
                name: 'ThingProxy',
                getUrl: (url) => `https://thingproxy.freeboard.io/fetch/${url}`
            },
            {
                name: 'CORS.SH',
                getUrl: (url) => `https://cors.sh/${url}`
            }
        ];

        // è·å–æ•°æ®ï¼ˆæ”¯æŒæ‰€æœ‰Kçº¿å‘¨æœŸï¼Œå¤šæ•°æ®æºï¼‰
        async function fetchFromYahoo(symbol, range, interval = '1d') {
            const klineTypeMap = {
                '1m': '1åˆ†é’Ÿ',
                '5m': '5åˆ†é’Ÿ',
                '15m': '15åˆ†é’Ÿ',
                '30m': '30åˆ†é’Ÿ',
                '60m': '60åˆ†é’Ÿ',
                '120m': '120åˆ†é’Ÿ',
                '1d': 'æ—¥K',
                '1wk': 'å‘¨K',
                '1mo': 'æœˆK'
            };
            
            console.log(`ğŸ“Š æ­£åœ¨è·å– ${symbol} çš„${klineTypeMap[interval]}æ•°æ®...`);
            
            const period1 = Math.floor(Date.now() / 1000) - getRangeSeconds(range);
            const period2 = Math.floor(Date.now() / 1000);
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=${interval}`;
            
            // å°è¯•å¤šä¸ªæ•°æ®æº
            for (let i = 0; i < multiDataSources.length; i++) {
                try {
                    const source = multiDataSources[i];
                    console.log(`ğŸ”„ å°è¯•æ•°æ®æº ${i + 1}/${multiDataSources.length}: ${source.name}`);
                    
                    const proxyUrl = source.getUrl(yahooUrl);
                    const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const json = await response.json();
                    
                    if (json.chart && json.chart.result && json.chart.result[0]) {
                        const result = json.chart.result[0];
                        
                        if (!result.timestamp || result.timestamp.length === 0) {
                            throw new Error('æ²¡æœ‰å¯ç”¨çš„å†å²æ•°æ®');
                        }
                        
                        const timestamps = result.timestamp;
                        const quotes = result.indicators.quote[0];
                        
                        // æ ¹æ®å‘¨æœŸæ ¼å¼åŒ–æ—¶é—´
                        const formatTime = (timestamp) => {
                            const date = new Date(timestamp * 1000);
                            if (interval.includes('m')) {
                                // åˆ†é’Ÿçº§åˆ«æ˜¾ç¤º æœˆ-æ—¥ æ—¶:åˆ†
                                return date.toLocaleString('zh-CN', { 
                                    month: '2-digit', 
                                    day: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                }).replace(/\//g, '-');
                            } else if (interval === '1wk') {
                                return date.toISOString().split('T')[0];
                            } else if (interval === '1mo') {
                                return date.toISOString().substring(0, 7);
                            } else {
                                return date.toISOString().split('T')[0];
                            }
                        };
                        
                        const data = timestamps.map((time, i) => ({
                            date: formatTime(time),
                            timestamp: time,
                            open: quotes.open[i] || quotes.close[i],
                            high: quotes.high[i] || quotes.close[i],
                            low: quotes.low[i] || quotes.close[i],
                            close: quotes.close[i],
                            volume: quotes.volume[i] || 0
                        })).filter(d => d.close !== null && d.close !== undefined);
                        
                        if (data.length === 0) {
                            throw new Error('è¿‡æ»¤åæ²¡æœ‰æœ‰æ•ˆæ•°æ®');
                        }
                        
                        console.log(`âœ… æˆåŠŸï¼ä½¿ç”¨ ${source.name}ï¼Œè·å– ${data.length} æ¡${klineTypeMap[interval]}æ•°æ®`);
                        
                        // æ›´æ–°å‘¨æœŸæ˜¾ç¤º
                        const rangeMap = {
                            '1d': '1å¤©', '5d': '5å¤©', '1mo': '1ä¸ªæœˆ', '3mo': '3ä¸ªæœˆ',
                            '6mo': '6ä¸ªæœˆ', '1y': '1å¹´', '2y': '2å¹´', '5y': '5å¹´'
                        };
                        document.getElementById('currentPeriodDisplay').textContent = 
                            `${klineTypeMap[interval]} - ${rangeMap[range] || range}`;
                        document.getElementById('dataCountDisplay').textContent = data.length + ' æ¡';
                        
                        // é™é»˜è·å–åŸºæœ¬é¢ä¿¡æ¯ï¼ˆä»…æ—¥KåŠä»¥ä¸Šå‘¨æœŸï¼‰
                        if (!interval.includes('m')) {
                            fetchCompanyInfo(symbol).catch(() => {
                                displayBasicInfo(symbol);
                            });
                            
                            // è·å–è´¢æŠ¥æ•°æ®
                            fetchFinancialReports(symbol).catch(err => {
                                console.warn('è·å–è´¢æŠ¥å¤±è´¥:', err);
                                document.getElementById('financialReports').innerHTML = '<div class="info-box"><p>è´¢æŠ¥æ•°æ®åŠ è½½ä¸­...</p></div>';
                            });
                            
                            // è·å–ç›¸å…³æ–°é—»
                            fetchNews(symbol).catch(err => {
                                console.warn('è·å–æ–°é—»å¤±è´¥:', err);
                                document.getElementById('newsList').innerHTML = '<div class="info-box"><p>æ–°é—»åŠ è½½ä¸­...</p></div>';
                            });
                        } else {
                            displayBasicInfo(symbol);
                            document.getElementById('financialReports').innerHTML = '<div class="info-box"><p>è´¢æŠ¥æ•°æ®ä»…åœ¨æ—¥KåŠä»¥ä¸Šå‘¨æœŸæ˜¾ç¤º</p></div>';
                            document.getElementById('newsList').innerHTML = '<div class="info-box"><p>æ–°é—»ä»…åœ¨æ—¥KåŠä»¥ä¸Šå‘¨æœŸæ˜¾ç¤º</p></div>';
                        }
                        
                        return data;
                    } else if (json.chart && json.chart.error) {
                        throw new Error(json.chart.error.description || 'æ•°æ®è·å–å¤±è´¥');
                    }
                    
                    throw new Error('æœªæ‰¾åˆ°æ•°æ®');
                } catch (error) {
                    console.warn(`âŒ ${multiDataSources[i].name} å¤±è´¥:`, error.message);
                    
                    // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªæ•°æ®æºï¼Œç»§ç»­å°è¯•
                    if (i < multiDataSources.length - 1) {
                        console.log('ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ•°æ®æº...');
                        continue;
                    }
                }
            }
            
            throw new Error('æ‰€æœ‰æ•°æ®æºéƒ½æ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
        }

        // è·å–å…¬å¸åŸºæœ¬é¢ä¿¡æ¯ï¼ˆå¸¦å¤šæ•°æ®æºï¼Œé™é»˜å¤±è´¥ï¼‰
        async function fetchCompanyInfo(symbol) {
            // åªä½¿ç”¨æˆåŠŸç‡é«˜çš„ä»£ç†
            const fundamentalSources = [
                {
                    name: 'Yahoo Quote via Proxy 1',
                    fetch: async () => {
                        const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail,defaultKeyStatistics,financialData,price`;
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                        const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return await response.json();
                    }
                }
            ];
            
            for (let i = 0; i < fundamentalSources.length; i++) {
                try {
                    const json = await fundamentalSources[i].fetch();
                    
                    if (json.quoteSummary && json.quoteSummary.result && json.quoteSummary.result[0]) {
                        const data = json.quoteSummary.result[0];
                        console.log(`âœ… åŸºæœ¬é¢æ•°æ®è·å–æˆåŠŸ`);
                        displayCompanyInfo(data, symbol);
                        displayFundamentals(data);
                        return;
                    }
                } catch (error) {
                    // é™é»˜å¤±è´¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    displayBasicInfo(symbol);
                }
            }
        }

        // æ˜¾ç¤ºå…¬å¸åŸºæœ¬ä¿¡æ¯
        function displayCompanyInfo(data, symbol) {
            const price = data.price || {};
            const summary = data.summaryDetail || {};
            
            const html = `
                <div class="company-info-item">
                    <div class="company-info-label">è‚¡ç¥¨åç§°</div>
                    <div class="company-info-value">${price.shortName || symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">è‚¡ç¥¨ä»£ç </div>
                    <div class="company-info-value">${symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">äº¤æ˜“æ‰€</div>
                    <div class="company-info-value">${price.exchangeName || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">è´§å¸</div>
                    <div class="company-info-value">${price.currency || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">å¸‚åœºç±»å‹</div>
                    <div class="company-info-value">${price.quoteType || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">52å‘¨æœ€é«˜</div>
                    <div class="company-info-value">${summary.fiftyTwoWeekHigh?.fmt || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">52å‘¨æœ€ä½</div>
                    <div class="company-info-value">${summary.fiftyTwoWeekLow?.fmt || '-'}</div>
                </div>
            `;
            
            document.getElementById('companyInfo').innerHTML = html;
        }

        // æ˜¾ç¤ºåŸºæœ¬é¢æ•°æ®
        function displayFundamentals(data) {
            const stats = data.defaultKeyStatistics || {};
            const financial = data.financialData || {};
            const summary = data.summaryDetail || {};
            
            const fundamentals = [
                {
                    label: 'å¸‚ç›ˆç‡ (P/E)',
                    value: stats.trailingPE?.fmt || summary.trailingPE?.fmt || '-',
                    desc: 'è‚¡ä»·ä¸æ¯è‚¡æ”¶ç›Šçš„æ¯”ç‡'
                },
                {
                    label: 'å¸‚å‡€ç‡ (P/B)',
                    value: stats.priceToBook?.fmt || '-',
                    desc: 'è‚¡ä»·ä¸æ¯è‚¡å‡€èµ„äº§çš„æ¯”ç‡'
                },
                {
                    label: 'å¸‚å€¼',
                    value: summary.marketCap?.fmt || '-',
                    desc: 'å…¬å¸æ€»å¸‚å€¼'
                },
                {
                    label: 'æ¯è‚¡æ”¶ç›Š (EPS)',
                    value: stats.trailingEps?.fmt || '-',
                    desc: 'å…¬å¸ç›ˆåˆ©èƒ½åŠ›æŒ‡æ ‡'
                },
                {
                    label: 'è‚¡æ¯ç‡',
                    value: summary.dividendYield?.fmt ? (parseFloat(summary.dividendYield.raw) * 100).toFixed(2) + '%' : '-',
                    desc: 'å¹´åº¦è‚¡æ¯/è‚¡ä»·'
                },
                {
                    label: 'å‡€èµ„äº§æ”¶ç›Šç‡ (ROE)',
                    value: financial.returnOnEquity?.fmt || '-',
                    desc: 'å‡€åˆ©æ¶¦/å‡€èµ„äº§'
                },
                {
                    label: 'æ€»èµ„äº§æ”¶ç›Šç‡ (ROA)',
                    value: financial.returnOnAssets?.fmt || '-',
                    desc: 'å‡€åˆ©æ¶¦/æ€»èµ„äº§'
                },
                {
                    label: 'è¥ä¸šæ”¶å…¥',
                    value: financial.totalRevenue?.fmt || '-',
                    desc: 'å…¬å¸æ€»è¥æ”¶'
                },
                {
                    label: 'æ¯›åˆ©ç‡',
                    value: financial.grossMargins?.fmt || '-',
                    desc: 'æ¯›åˆ©æ¶¦/è¥ä¸šæ”¶å…¥'
                },
                {
                    label: 'å‡€åˆ©ç‡',
                    value: financial.profitMargins?.fmt || '-',
                    desc: 'å‡€åˆ©æ¶¦/è¥ä¸šæ”¶å…¥'
                },
                {
                    label: 'è¥æ”¶å¢é•¿ç‡',
                    value: financial.revenueGrowth?.fmt || '-',
                    desc: 'åŒæ¯”è¥æ”¶å¢é•¿'
                },
                {
                    label: 'è‡ªç”±ç°é‡‘æµ',
                    value: financial.freeCashflow?.fmt || '-',
                    desc: 'å…¬å¸å¯è‡ªç”±æ”¯é…ç°é‡‘'
                },
                {
                    label: 'æµé€šè‚¡',
                    value: stats.floatShares?.fmt || '-',
                    desc: 'å¯æµé€šçš„è‚¡ç¥¨æ•°é‡'
                },
                {
                    label: 'æ€»è‚¡æœ¬',
                    value: stats.sharesOutstanding?.fmt || '-',
                    desc: 'å…¬å¸å‘è¡Œçš„æ€»è‚¡æ•°'
                },
                {
                    label: 'èµ„äº§è´Ÿå€ºç‡',
                    value: financial.debtToEquity?.fmt || '-',
                    desc: 'æ€»è´Ÿå€º/è‚¡ä¸œæƒç›Š'
                },
                {
                    label: 'æµåŠ¨æ¯”ç‡',
                    value: financial.currentRatio?.fmt || '-',
                    desc: 'æµåŠ¨èµ„äº§/æµåŠ¨è´Ÿå€º'
                }
            ];
            
            const html = fundamentals.map(item => `
                <div class="fundamental-item">
                    <div class="fundamental-label">${item.label}</div>
                    <div class="fundamental-value">${item.value}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">${item.desc}</div>
                </div>
            `).join('');
            
            document.getElementById('fundamentalsData').innerHTML = html;
        }

        // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ï¼ˆå½“æ— æ³•è·å–è¯¦ç»†ä¿¡æ¯æ—¶ï¼‰
        function displayBasicInfo(symbol) {
            const html = `
                <div class="company-info-item">
                    <div class="company-info-label">è‚¡ç¥¨ä»£ç </div>
                    <div class="company-info-value">${symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">æç¤º</div>
                    <div class="company-info-value">åŸºæœ¬é¢æ•°æ®åŠ è½½ä¸­æˆ–æš‚æ— æ•°æ®</div>
                </div>
            `;
            document.getElementById('companyInfo').innerHTML = html;
            document.getElementById('fundamentalsData').innerHTML = '<div class="info-box"><p>æš‚æ—¶æ— æ³•è·å–åŸºæœ¬é¢æ•°æ®</p></div>';
        }

        // è·å–è´¢åŠ¡æŠ¥è¡¨æ•°æ®
        async function fetchFinancialReports(symbol) {
            try {
                console.log('ğŸ“Š è·å–è´¢åŠ¡æŠ¥è¡¨...');
                
                // ä½¿ç”¨Yahoo Financeçš„è´¢åŠ¡æŠ¥è¡¨API
                const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=incomeStatementHistory,balanceSheetHistory,cashflowStatementHistory`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const json = await response.json();
                
                if (json.quoteSummary && json.quoteSummary.result && json.quoteSummary.result[0]) {
                    const data = json.quoteSummary.result[0];
                    displayFinancialReports(data);
                    console.log('âœ… è´¢åŠ¡æŠ¥è¡¨è·å–æˆåŠŸ');
                } else {
                    throw new Error('æ— è´¢æŠ¥æ•°æ®');
                }
            } catch (error) {
                console.warn('è´¢æŠ¥è·å–å¤±è´¥:', error);
                document.getElementById('financialReports').innerHTML = `
                    <div class="info-box">
                        <p>æš‚æ—¶æ— æ³•è·å–è¯¦ç»†è´¢æŠ¥æ•°æ®</p>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">æç¤ºï¼šå¯ä»¥è®¿é—® Yahoo Finance æˆ–å…¬å¸å®˜ç½‘æŸ¥çœ‹å®Œæ•´è´¢æŠ¥</p>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºè´¢åŠ¡æŠ¥è¡¨
        function displayFinancialReports(data) {
            let html = '';
            
            // åˆ©æ¶¦è¡¨
            if (data.incomeStatementHistory && data.incomeStatementHistory.incomeStatementHistory) {
                const statements = data.incomeStatementHistory.incomeStatementHistory.slice(0, 3);
                html += '<h3 style="color: #4facfe; margin-bottom: 10px;">ğŸ“ˆ åˆ©æ¶¦è¡¨ï¼ˆæœ€è¿‘3æœŸï¼‰</h3>';
                html += '<table class="financial-table"><thead><tr><th>é¡¹ç›®</th>';
                statements.forEach(s => {
                    const date = new Date(s.endDate.raw * 1000).toISOString().split('T')[0];
                    html += `<th>${date}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                const items = [
                    { key: 'totalRevenue', label: 'è¥ä¸šæ”¶å…¥' },
                    { key: 'grossProfit', label: 'æ¯›åˆ©æ¶¦' },
                    { key: 'operatingIncome', label: 'è¥ä¸šåˆ©æ¶¦' },
                    { key: 'netIncome', label: 'å‡€åˆ©æ¶¦' },
                    { key: 'ebitda', label: 'EBITDA' }
                ];
                
                items.forEach(item => {
                    html += `<tr><td>${item.label}</td>`;
                    statements.forEach(s => {
                        const value = s[item.key];
                        html += `<td>${value ? value.fmt : '-'}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            // èµ„äº§è´Ÿå€ºè¡¨
            if (data.balanceSheetHistory && data.balanceSheetHistory.balanceSheetStatements) {
                const statements = data.balanceSheetHistory.balanceSheetStatements.slice(0, 3);
                html += '<h3 style="color: #4facfe; margin: 20px 0 10px 0;">ğŸ’° èµ„äº§è´Ÿå€ºè¡¨ï¼ˆæœ€è¿‘3æœŸï¼‰</h3>';
                html += '<table class="financial-table"><thead><tr><th>é¡¹ç›®</th>';
                statements.forEach(s => {
                    const date = new Date(s.endDate.raw * 1000).toISOString().split('T')[0];
                    html += `<th>${date}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                const items = [
                    { key: 'totalAssets', label: 'æ€»èµ„äº§' },
                    { key: 'totalLiab', label: 'æ€»è´Ÿå€º' },
                    { key: 'totalStockholderEquity', label: 'è‚¡ä¸œæƒç›Š' },
                    { key: 'cash', label: 'ç°é‡‘' },
                    { key: 'totalCurrentAssets', label: 'æµåŠ¨èµ„äº§' }
                ];
                
                items.forEach(item => {
                    html += `<tr><td>${item.label}</td>`;
                    statements.forEach(s => {
                        const value = s[item.key];
                        html += `<td>${value ? value.fmt : '-'}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            // ç°é‡‘æµé‡è¡¨
            if (data.cashflowStatementHistory && data.cashflowStatementHistory.cashflowStatements) {
                const statements = data.cashflowStatementHistory.cashflowStatements.slice(0, 3);
                html += '<h3 style="color: #4facfe; margin: 20px 0 10px 0;">ğŸ’µ ç°é‡‘æµé‡è¡¨ï¼ˆæœ€è¿‘3æœŸï¼‰</h3>';
                html += '<table class="financial-table"><thead><tr><th>é¡¹ç›®</th>';
                statements.forEach(s => {
                    const date = new Date(s.endDate.raw * 1000).toISOString().split('T')[0];
                    html += `<th>${date}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                const items = [
                    { key: 'totalCashFromOperatingActivities', label: 'ç»è¥æ´»åŠ¨ç°é‡‘æµ' },
                    { key: 'totalCashFromFinancingActivities', label: 'èèµ„æ´»åŠ¨ç°é‡‘æµ' },
                    { key: 'totalCashflowsFromInvestingActivities', label: 'æŠ•èµ„æ´»åŠ¨ç°é‡‘æµ' },
                    { key: 'freeCashflow', label: 'è‡ªç”±ç°é‡‘æµ' }
                ];
                
                items.forEach(item => {
                    html += `<tr><td>${item.label}</td>`;
                    statements.forEach(s => {
                        const value = s[item.key];
                        html += `<td>${value ? value.fmt : '-'}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            if (html) {
                document.getElementById('financialReports').innerHTML = html;
            } else {
                document.getElementById('financialReports').innerHTML = '<div class="info-box"><p>æš‚æ— è´¢æŠ¥æ•°æ®</p></div>';
            }
        }

        // è·å–ç›¸å…³æ–°é—»
        async function fetchNews(symbol) {
            try {
                console.log('ğŸ“° è·å–ç›¸å…³æ–°é—»...');
                
                // ä½¿ç”¨å¤šä¸ªæ–°é—»æº
                const newsSources = [
                    {
                        name: 'Yahoo Finance News',
                        fetch: async () => {
                            const url = `https://query1.finance.yahoo.com/v1/finance/search?q=${symbol}&quotesCount=0&newsCount=10`;
                            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                            const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
                            return await response.json();
                        },
                        parse: (json) => {
                            if (json.news && json.news.length > 0) {
                                return json.news.map(item => ({
                                    title: item.title,
                                    summary: item.summary || 'æš‚æ— æ‘˜è¦',
                                    source: item.publisher,
                                    date: new Date(item.providerPublishTime * 1000).toLocaleDateString('zh-CN'),
                                    url: item.link
                                }));
                            }
                            return [];
                        }
                    },
                    {
                        name: 'Finnhub News',
                        fetch: async () => {
                            // å¤‡ç”¨æ–°é—»æºï¼ˆéœ€è¦API Keyæ—¶å¯é…ç½®ï¼‰
                            return { status: 'ok', articles: [] };
                        },
                        parse: () => []
                    }
                ];
                
                for (let source of newsSources) {
                    try {
                        const json = await source.fetch();
                        const news = source.parse(json);
                        
                        if (news && news.length > 0) {
                            displayNews(news);
                            console.log(`âœ… æ–°é—»è·å–æˆåŠŸï¼Œæ¥æºï¼š${source.name}`);
                            return;
                        }
                    } catch (err) {
                        console.warn(`${source.name} å¤±è´¥:`, err);
                        continue;
                    }
                }
                
                throw new Error('æ‰€æœ‰æ–°é—»æºéƒ½å¤±è´¥');
            } catch (error) {
                console.warn('æ–°é—»è·å–å¤±è´¥:', error);
                document.getElementById('newsList').innerHTML = `
                    <div class="info-box">
                        <h3>ğŸ“° æš‚æ—¶æ— æ³•è·å–æ–°é—»</h3>
                        <p style="margin-top: 10px;">å»ºè®®è®¿é—®ä»¥ä¸‹ç½‘ç«™æŸ¥çœ‹ç›¸å…³æ–°é—»ï¼š</p>
                        <ul style="margin-top: 10px; color: #aaa; line-height: 2;">
                            <li>Yahoo Finance: <a href="https://finance.yahoo.com/quote/${symbol}" target="_blank" style="color: #4facfe;">æŸ¥çœ‹</a></li>
                            <li>Google Finance: <a href="https://www.google.com/finance/quote/${symbol.split('.')[0]}:${symbol.includes('.') ? symbol.split('.')[1] : 'NASDAQ'}" target="_blank" style="color: #4facfe;">æŸ¥çœ‹</a></li>
                        </ul>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ–°é—»
        function displayNews(news) {
            let html = '';
            
            news.slice(0, 10).forEach(item => {
                html += `
                    <div class="news-item" onclick="window.open('${item.url}', '_blank')">
                        <div class="news-title">${item.title}</div>
                        <div class="news-meta">
                            <span>ğŸ“… ${item.date}</span>
                            <span>ğŸ“° ${item.source}</span>
                        </div>
                        <div class="news-summary">${item.summary}</div>
                    </div>
                `;
            });
            
            document.getElementById('newsList').innerHTML = html || '<div class="info-box"><p>æš‚æ— æ–°é—»</p></div>';
        }

        // ä»æ–°æµªè´¢ç»è·å–æ•°æ®
        async function fetchFromSina(symbol) {
            try {
                console.log('ğŸ“Š æ–°æµªè´¢ç»æ•°æ®æº');
                let sinaCode = symbol.replace('.SS', '').replace('.SZ', '');
                if (symbol.includes('.SS')) {
                    sinaCode = 'sh' + sinaCode;
                } else if (symbol.includes('.SZ')) {
                    sinaCode = 'sz' + sinaCode;
                } else {
                    sinaCode = 'sh' + sinaCode;
                }
                
                // ä½¿ç”¨ä»£ç†è®¿é—®æ–°æµª
                const url = `https://money.finance.sina.com.cn/quotes_service/api/json_v2.php/CN_MarketData.getKLineData?symbol=${sinaCode}&scale=240&ma=5,10,20,60&datalen=1000`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const text = await response.text();
                const jsonData = JSON.parse(text);
                
                if (jsonData && jsonData.length > 0) {
                    const data = jsonData.map(item => ({
                        date: item.day,
                        open: parseFloat(item.open),
                        high: parseFloat(item.high),
                        low: parseFloat(item.low),
                        close: parseFloat(item.close),
                        volume: parseFloat(item.volume)
                    }));
                    
                    console.log(`âœ… æ–°æµªè´¢ç»è·å–æˆåŠŸï¼Œ${data.length} æ¡æ•°æ®`);
                    displayBasicInfo(symbol);
                    return data;
                }
                throw new Error('æ–°æµªè´¢ç»æš‚æ— æ•°æ®');
            } catch (error) {
                console.error('æ–°æµªè´¢ç»é”™è¯¯:', error);
                throw error;
            }
        }

        // ä¸œæ–¹è´¢å¯Œæ•°æ®æº
        async function fetchFromEastMoney(symbol, range, interval) {
            try {
                console.log('ğŸ“Š ä¸œæ–¹è´¢å¯Œæ•°æ®æº');
                // è½¬æ¢ä»£ç æ ¼å¼
                let emCode = symbol.replace('.SS', '').replace('.SZ', '').replace('.HK', '');
                let market = '1'; // ä¸Šæµ·
                if (symbol.includes('.SZ')) market = '0'; // æ·±åœ³
                if (symbol.includes('.HK')) market = '116'; // æ¸¯è‚¡
                
                // ä¸œæ–¹è´¢å¯ŒAPIï¼ˆé€šè¿‡ä»£ç†ï¼‰
                const klineMap = { '1m': '1', '5m': '5', '15m': '15', '30m': '30', '60m': '60', '1d': '101', '1wk': '102', '1mo': '103' };
                const ktype = klineMap[interval] || '101';
                
                const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${market}.${emCode}&klt=${ktype}&fqt=1&lmt=500&fields1=f1,f2,f3,f4,f5&fields2=f51,f52,f53,f54,f55,f56,f57`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const json = await response.json();
                
                if (json.data && json.data.klines && json.data.klines.length > 0) {
                    const data = json.data.klines.map(item => {
                        const parts = item.split(',');
                        return {
                            date: parts[0],
                            open: parseFloat(parts[1]),
                            close: parseFloat(parts[2]),
                            high: parseFloat(parts[3]),
                            low: parseFloat(parts[4]),
                            volume: parseFloat(parts[5])
                        };
                    });
                    
                    console.log(`âœ… ä¸œæ–¹è´¢å¯Œè·å–æˆåŠŸï¼Œ${data.length} æ¡æ•°æ®`);
                    displayBasicInfo(symbol);
                    return data;
                }
                throw new Error('ä¸œæ–¹è´¢å¯Œæš‚æ— æ•°æ®');
            } catch (error) {
                console.error('ä¸œæ–¹è´¢å¯Œé”™è¯¯:', error);
                throw error;
            }
        }

        // è…¾è®¯è´¢ç»æ•°æ®æº
        async function fetchFromTencent(symbol, range, interval) {
            try {
                console.log('ğŸ“Š è…¾è®¯è´¢ç»æ•°æ®æº');
                // è½¬æ¢ä»£ç 
                let qqCode = symbol.replace('.SS', '').replace('.SZ', '');
                let prefix = 'sh';
                if (symbol.includes('.SZ')) prefix = 'sz';
                
                const url = `https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?param=${prefix}${qqCode},day,,500`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const json = await response.json();
                
                if (json.data && json.data[`${prefix}${qqCode}`] && json.data[`${prefix}${qqCode}`].day) {
                    const klines = json.data[`${prefix}${qqCode}`].day;
                    const data = klines.map(item => ({
                        date: item[0],
                        open: parseFloat(item[1]),
                        close: parseFloat(item[2]),
                        high: parseFloat(item[3]),
                        low: parseFloat(item[4]),
                        volume: parseFloat(item[5])
                    }));
                    
                    console.log(`âœ… è…¾è®¯è´¢ç»è·å–æˆåŠŸï¼Œ${data.length} æ¡æ•°æ®`);
                    displayBasicInfo(symbol);
                    return data;
                }
                throw new Error('è…¾è®¯è´¢ç»æš‚æ— æ•°æ®');
            } catch (error) {
                console.error('è…¾è®¯è´¢ç»é”™è¯¯:', error);
                throw error;
            }
        }

        // ç½‘æ˜“è´¢ç»æ•°æ®æº
        async function fetchFromNetease(symbol, range, interval) {
            try {
                console.log('ğŸ“Š ç½‘æ˜“è´¢ç»æ•°æ®æº');
                let code = symbol.replace('.SS', '').replace('.SZ', '');
                let prefix = '0';
                if (symbol.includes('.SS')) prefix = '1';
                
                const today = new Date();
                const start = new Date(today.getTime() - getRangeSeconds(range) * 1000);
                const startDate = start.toISOString().split('T')[0].replace(/-/g, '');
                const endDate = today.toISOString().split('T')[0].replace(/-/g, '');
                
                const url = `https://img1.money.126.net/data/hs/kline/day/history/${today.getFullYear()}/${prefix}${code}.json`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const json = await response.json();
                
                if (json.data && json.data.length > 0) {
                    const data = json.data.map(item => ({
                        date: item[0],
                        open: parseFloat(item[1]),
                        high: parseFloat(item[2]),
                        low: parseFloat(item[3]),
                        close: parseFloat(item[4]),
                        volume: parseFloat(item[5])
                    }));
                    
                    console.log(`âœ… ç½‘æ˜“è´¢ç»è·å–æˆåŠŸï¼Œ${data.length} æ¡æ•°æ®`);
                    displayBasicInfo(symbol);
                    return data;
                }
                throw new Error('ç½‘æ˜“è´¢ç»æš‚æ— æ•°æ®');
            } catch (error) {
                console.error('ç½‘æ˜“è´¢ç»é”™è¯¯:', error);
                throw error;
            }
        }

        // Alpha Vantageæ•°æ®æºï¼ˆå…è´¹ä½†éœ€è¦API Keyï¼‰
        async function fetchFromAlphaVantage(symbol, range, interval) {
            try {
                console.log('ğŸ“Š Alpha Vantageæ•°æ®æºï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
                showError('Alpha Vantageéœ€è¦API Keyã€‚è¯·è®¿é—® https://www.alphavantage.co ç”³è¯·å…è´¹API Keyï¼Œç„¶ååœ¨ä»£ç ä¸­é…ç½®ã€‚å½“å‰ä½¿ç”¨Yahoo Financeæ•°æ®æºã€‚');
                // å›é€€åˆ°Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('Alpha Vantageé”™è¯¯:', error);
                throw error;
            }
        }

        // Finnhubæ•°æ®æº
        async function fetchFromFinnhub(symbol, range, interval) {
            try {
                console.log('ğŸ“Š Finnhubæ•°æ®æºï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
                showError('Finnhubéœ€è¦API Keyã€‚è¯·è®¿é—® https://finnhub.io ç”³è¯·å…è´¹API Keyã€‚å½“å‰ä½¿ç”¨Yahoo Financeæ•°æ®æºã€‚');
                // å›é€€åˆ°Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('Finnhubé”™è¯¯:', error);
                throw error;
            }
        }

        // Polygon.ioæ•°æ®æº
        async function fetchFromPolygon(symbol, range, interval) {
            try {
                console.log('ğŸ“Š Polygon.ioæ•°æ®æºï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
                showError('Polygon.ioéœ€è¦API Keyã€‚è¯·è®¿é—® https://polygon.io ç”³è¯·ã€‚å½“å‰ä½¿ç”¨Yahoo Financeæ•°æ®æºã€‚');
                // å›é€€åˆ°Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('Polygon.ioé”™è¯¯:', error);
                throw error;
            }
        }

        // Twelve Dataæ•°æ®æº
        async function fetchFromTwelveData(symbol, range, interval) {
            try {
                console.log('ğŸ“Š Twelve Dataæ•°æ®æºï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
                showError('Twelve Dataéœ€è¦API Keyã€‚è¯·è®¿é—® https://twelvedata.com ç”³è¯·ã€‚å½“å‰ä½¿ç”¨Yahoo Financeæ•°æ®æºã€‚');
                // å›é€€åˆ°Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('Twelve Dataé”™è¯¯:', error);
                throw error;
            }
        }

        // IEX Cloudæ•°æ®æº
        async function fetchFromIEXCloud(symbol, range, interval) {
            try {
                console.log('ğŸ“Š IEX Cloudæ•°æ®æºï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰');
                showError('IEX Cloudéœ€è¦API Keyã€‚è¯·è®¿é—® https://iexcloud.io ç”³è¯·ã€‚å½“å‰ä½¿ç”¨Yahoo Financeæ•°æ®æºã€‚');
                // å›é€€åˆ°Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('IEX Cloudé”™è¯¯:', error);
                throw error;
            }
        }

        function getRangeSeconds(range) {
            const ranges = {
                '1d': 1 * 24 * 3600,
                '5d': 5 * 24 * 3600,
                '1mo': 30 * 24 * 3600,
                '3mo': 90 * 24 * 3600,
                '6mo': 180 * 24 * 3600,
                '1y': 365 * 24 * 3600,
                '2y': 730 * 24 * 3600,
                '5y': 1825 * 24 * 3600
            };
            return ranges[range] || ranges['3mo'];
        }

        // åˆ†æå¹¶æ˜¾ç¤ºæ•°æ®
        function analyzeAndDisplay(data) {
            // è®¡ç®—æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡
            const indicators = calculateAllIndicators(data);
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('results').style.display = 'block';
            
            // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
            displayStats(data, indicators);
            
            // æ˜¾ç¤ºæŠ€æœ¯ä¿¡å·
            displaySignals(data, indicators);
            
            // ç»˜åˆ¶æ‰€æœ‰å›¾è¡¨
            drawAllCharts(data, indicators);
            
            // å½¢æ€è¯†åˆ«
            displayPatterns(data);
            
            // æ»šåŠ¨åˆ°ç»“æœ
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // è®¡ç®—æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡ï¼ˆå®Œæ•´ç‰ˆï¼‰
        function calculateAllIndicators(data) {
            return {
                // å‡çº¿ç³»ç»Ÿ
                ma5: calculateMA(data, 5),
                ma10: calculateMA(data, 10),
                ma20: calculateMA(data, 20),
                ma30: calculateMA(data, 30),
                ma60: calculateMA(data, 60),
                ma120: calculateMA(data, 120),
                ema12: calculateEMA(data, 12),
                ema26: calculateEMA(data, 26),
                // è¶‹åŠ¿æŒ‡æ ‡
                macd: calculateMACD(data),
                bollinger: calculateBollinger(data, 20, 2),
                sar: calculateSAR(data),
                trix: calculateTRIX(data),
                // æ‘†åŠ¨æŒ‡æ ‡
                kdj: calculateKDJ(data),
                rsi: calculateRSI(data, 14),
                rsi6: calculateRSI(data, 6),
                rsi12: calculateRSI(data, 12),
                wr: calculateWR(data, 14),
                cci: calculateCCI(data, 14),
                stoch: calculateStoch(data, 14),
                mom: calculateMOM(data, 10),
                // è¶‹å‘æŒ‡æ ‡
                dmi: calculateDMI(data, 14),
                // æˆäº¤é‡èƒ½é‡æŒ‡æ ‡
                obv: calculateOBV(data),
                volumeRatio: calculateVolumeRatio(data),
                vr: calculateVR(data),
                mfi: calculateMFI(data, 14),
                adl: calculateADL(data),
                // æ³¢åŠ¨ç‡æŒ‡æ ‡
                atr: calculateATR(data, 14),
                // äººæ°”æŒ‡æ ‡
                brar: calculateBRAR(data),
                cr: calculateCR(data),
                // ä¸€ç›®å‡è¡¡è¡¨
                ichimoku: calculateIchimoku(data)
            };
        }

        // è®¡ç®—MA
        function calculateMA(data, period) {
            const closes = data.map(d => d.close);
            return closes.map((_, i) => {
                if (i < period - 1) return null;
                const slice = closes.slice(i - period + 1, i + 1);
                if (slice.length === 0) return null;
                const sum = slice.reduce((a, b) => a + b, 0);
                return sum / period;
            });
        }

        // è®¡ç®—EMA
        function calculateEMA(data, period) {
            const closes = data.map(d => d.close);
            const k = 2 / (period + 1);
            const ema = [closes[0]];
            for (let i = 1; i < closes.length; i++) {
                ema.push(closes[i] * k + ema[i - 1] * (1 - k));
            }
            return ema;
        }

        // è®¡ç®—MACD
        function calculateMACD(data) {
            const closes = data.map(d => d.close);
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            const dif = ema12.map((val, i) => val - ema26[i]);
            
            // è®¡ç®—DEA (DIFçš„9æ—¥EMA)
            const k = 2 / 10;
            const dea = [dif[0]];
            for (let i = 1; i < dif.length; i++) {
                dea.push(dif[i] * k + dea[i - 1] * (1 - k));
            }
            
            const macd = dif.map((val, i) => (val - dea[i]) * 2);
            return { dif, dea, macd };
        }

        // è®¡ç®—KDJ
        function calculateKDJ(data, period = 9) {
            const rsv = [];
            const k = [50];
            const d = [50];
            const j = [];

            for (let i = 0; i < data.length; i++) {
                const start = Math.max(0, i - period + 1);
                const slice = data.slice(start, i + 1);
                const high = Math.max(...slice.map(d => d.high));
                const low = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                rsv[i] = high === low ? 50 : ((close - low) / (high - low)) * 100;
                
                if (i > 0) {
                    k[i] = k[i - 1] * 2/3 + rsv[i] * 1/3;
                    d[i] = d[i - 1] * 2/3 + k[i] * 1/3;
                }
                j[i] = 3 * k[i] - 2 * d[i];
            }
            
            return { k, d, j };
        }

        // è®¡ç®—RSI
        function calculateRSI(data, period = 14) {
            const closes = data.map(d => d.close);
            const rsi = [];
            
            for (let i = 0; i < closes.length; i++) {
                if (i < period) {
                    rsi.push(null);
                    continue;
                }
                
                let gains = 0, losses = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    const change = closes[j] - closes[j - 1];
                    if (change > 0) gains += change;
                    else losses -= change;
                }
                
                const avgGain = gains / period;
                const avgLoss = losses / period;
                const rs = avgGain / (avgLoss || 1);
                rsi.push(100 - (100 / (1 + rs)));
            }
            
            return rsi;
        }

        // è®¡ç®—å¸ƒæ—å¸¦
        function calculateBollinger(data, period = 20, stdDev = 2) {
            const closes = data.map(d => d.close);
            const middle = [];
            const upper = [];
            const lower = [];

            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    middle.push(null);
                    upper.push(null);
                    lower.push(null);
                    continue;
                }

                const slice = closes.slice(i - period + 1, i + 1);
                if (slice.length === 0) {
                    middle.push(null);
                    upper.push(null);
                    lower.push(null);
                    continue;
                }
                const mean = slice.reduce((a, b) => a + b, 0) / period;
                const variance = slice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / period;
                const std = Math.sqrt(variance);

                middle.push(mean);
                upper.push(mean + stdDev * std);
                lower.push(mean - stdDev * std);
            }

            return { middle, upper, lower };
        }

        // è®¡ç®—å¨å»‰æŒ‡æ ‡
        function calculateWR(data, period = 14) {
            const wr = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    wr.push(null);
                    continue;
                }
                
                const slice = data.slice(i - period + 1, i + 1);
                const highest = Math.max(...slice.map(d => d.high));
                const lowest = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                wr.push(((highest - close) / (highest - lowest)) * -100);
            }
            return wr;
        }

        // è®¡ç®—CCI
        function calculateCCI(data, period = 14) {
            const cci = [];
            const tp = data.map(d => (d.high + d.low + d.close) / 3);
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    cci.push(null);
                    continue;
                }
                
                const slice = tp.slice(i - period + 1, i + 1);
                if (slice.length === 0) {
                    cci.push(null);
                    continue;
                }
                const ma = slice.reduce((a, b) => a + b, 0) / period;
                const md = slice.reduce((sum, val) => sum + Math.abs(val - ma), 0) / period;
                
                cci.push((tp[i] - ma) / (0.015 * md));
            }
            return cci;
        }

        // è®¡ç®—DMI
        function calculateDMI(data, period = 14) {
            const pdi = [];
            const mdi = [];
            const adx = [];
            const dx = [];
            
            if (data.length < period + 1) {
                return { 
                    pdi: data.map(() => null), 
                    mdi: data.map(() => null), 
                    adx: data.map(() => null) 
                };
            }
            
            let trSum = 0, pdmSum = 0, mdmSum = 0;
            
            for (let i = 1; i < data.length; i++) {
                const tr = Math.max(
                    data[i].high - data[i].low,
                    Math.abs(data[i].high - data[i - 1].close),
                    Math.abs(data[i].low - data[i - 1].close)
                );
                
                const pdm = Math.max(data[i].high - data[i - 1].high, 0);
                const mdm = Math.max(data[i - 1].low - data[i].low, 0);
                
                if (i < period) {
                    trSum += tr;
                    pdmSum += pdm;
                    mdmSum += mdm;
                    pdi.push(null);
                    mdi.push(null);
                    adx.push(null);
                    continue;
                }
                
                if (i === period) {
                    trSum += tr;
                    pdmSum += pdm;
                    mdmSum += mdm;
                } else {
                    trSum = trSum - trSum / period + tr;
                    pdmSum = pdmSum - pdmSum / period + pdm;
                    mdmSum = mdmSum - mdmSum / period + mdm;
                }
                
                const pdiVal = (pdmSum / (trSum || 1)) * 100;
                const mdiVal = (mdmSum / (trSum || 1)) * 100;
                const dxVal = Math.abs(pdiVal - mdiVal) / ((pdiVal + mdiVal) || 1) * 100;
                
                pdi.push(pdiVal);
                mdi.push(mdiVal);
                dx.push(dxVal);
                
                if (i >= period * 2 - 1) {
                    const adxSlice = dx.slice(i - period + 1, i + 1).filter(v => v !== null);
                    if (adxSlice.length > 0) {
                        adx.push(adxSlice.reduce((a, b) => a + b, 0) / adxSlice.length);
                    } else {
                        adx.push(null);
                    }
                } else {
                    adx.push(null);
                }
            }
            
            return { pdi, mdi, adx };
        }

        // è®¡ç®—OBV
        function calculateOBV(data) {
            const obv = [0];
            for (let i = 1; i < data.length; i++) {
                if (data[i].close > data[i - 1].close) {
                    obv.push(obv[i - 1] + data[i].volume);
                } else if (data[i].close < data[i - 1].close) {
                    obv.push(obv[i - 1] - data[i].volume);
                } else {
                    obv.push(obv[i - 1]);
                }
            }
            return obv;
        }

        // è®¡ç®—é‡æ¯”
        function calculateVolumeRatio(data) {
            const ratio = [];
            for (let i = 0; i < data.length; i++) {
                if (i < 5) {
                    ratio.push(null);
                    continue;
                }
                const avgVolume = data.slice(i - 5, i).reduce((sum, d) => sum + d.volume, 0) / 5;
                ratio.push(data[i].volume / (avgVolume || 1));
            }
            return ratio;
        }

        // è®¡ç®—SAR (æŠ›ç‰©çº¿æŒ‡æ ‡)
        function calculateSAR(data, af = 0.02, maxAf = 0.2) {
            const sar = [];
            if (data.length < 2) return data.map(() => null);
            
            let isUpTrend = data[1].close > data[0].close;
            let currentSar = isUpTrend ? data[0].low : data[0].high;
            let ep = isUpTrend ? data[0].high : data[0].low;
            let currentAf = af;
            
            sar.push(currentSar);
            
            for (let i = 1; i < data.length; i++) {
                const prevSar = currentSar;
                currentSar = prevSar + currentAf * (ep - prevSar);
                
                if (isUpTrend) {
                    currentSar = Math.min(currentSar, data[i - 1].low, i > 1 ? data[i - 2].low : data[i - 1].low);
                    if (data[i].low < currentSar) {
                        isUpTrend = false;
                        currentSar = ep;
                        ep = data[i].low;
                        currentAf = af;
                    } else {
                        if (data[i].high > ep) {
                            ep = data[i].high;
                            currentAf = Math.min(currentAf + af, maxAf);
                        }
                    }
                } else {
                    currentSar = Math.max(currentSar, data[i - 1].high, i > 1 ? data[i - 2].high : data[i - 1].high);
                    if (data[i].high > currentSar) {
                        isUpTrend = true;
                        currentSar = ep;
                        ep = data[i].high;
                        currentAf = af;
                    } else {
                        if (data[i].low < ep) {
                            ep = data[i].low;
                            currentAf = Math.min(currentAf + af, maxAf);
                        }
                    }
                }
                
                sar.push(currentSar);
            }
            
            return sar;
        }

        // è®¡ç®—TRIX (ä¸‰é‡æŒ‡æ•°å¹³æ»‘ç§»åŠ¨å¹³å‡)
        function calculateTRIX(data, period = 12) {
            const closes = data.map(d => d.close);
            const ema1 = calculateEMAFromArray(closes, period);
            const ema2 = calculateEMAFromArray(ema1, period);
            const ema3 = calculateEMAFromArray(ema2, period);
            
            const trix = ema3.map((val, i) => {
                if (i === 0 || !ema3[i - 1] || ema3[i - 1] === 0) return null;
                return ((val - ema3[i - 1]) / ema3[i - 1]) * 100;
            });
            
            return trix;
        }

        // è¾…åŠ©å‡½æ•°ï¼šä»æ•°ç»„è®¡ç®—EMA
        function calculateEMAFromArray(arr, period) {
            const k = 2 / (period + 1);
            const ema = [];
            let prevEma = null;
            
            for (let i = 0; i < arr.length; i++) {
                if (arr[i] === null || arr[i] === undefined) {
                    ema.push(null);
                } else if (prevEma === null) {
                    ema.push(arr[i]);
                    prevEma = arr[i];
                } else {
                    const val = arr[i] * k + prevEma * (1 - k);
                    ema.push(val);
                    prevEma = val;
                }
            }
            return ema;
        }

        // è®¡ç®—Stoch (éšæœºæŒ‡æ ‡)
        function calculateStoch(data, period = 14) {
            const k = [];
            const d = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    k.push(null);
                    d.push(null);
                    continue;
                }
                
                const slice = data.slice(i - period + 1, i + 1);
                const high = Math.max(...slice.map(d => d.high));
                const low = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                const kVal = high === low ? 50 : ((close - low) / (high - low)) * 100;
                k.push(kVal);
                
                // Dæ˜¯Kçš„3æ—¥SMA
                if (i >= period + 1) {
                    const kSlice = k.slice(i - 2, i + 1).filter(v => v !== null);
                    const dVal = kSlice.reduce((a, b) => a + b, 0) / kSlice.length;
                    d.push(dVal);
                } else {
                    d.push(null);
                }
            }
            
            return { k, d };
        }

        // è®¡ç®—VR (æˆäº¤é‡æ¯”ç‡)
        function calculateVR(data, period = 26) {
            const vr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    vr.push(null);
                    continue;
                }
                
                let upVolume = 0;
                let downVolume = 0;
                let flatVolume = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    if (data[j].close > data[j - 1].close) {
                        upVolume += data[j].volume;
                    } else if (data[j].close < data[j - 1].close) {
                        downVolume += data[j].volume;
                    } else {
                        flatVolume += data[j].volume;
                    }
                }
                
                vr.push((upVolume + flatVolume / 2) / (downVolume + flatVolume / 2 || 1) * 100);
            }
            
            return vr;
        }

        // è®¡ç®—ATR (å¹³å‡çœŸå®æ³¢å¹…)
        function calculateATR(data, period = 14) {
            const tr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    tr.push(data[i].high - data[i].low);
                } else {
                    const high = data[i].high;
                    const low = data[i].low;
                    const prevClose = data[i - 1].close;
                    
                    tr.push(Math.max(
                        high - low,
                        Math.abs(high - prevClose),
                        Math.abs(low - prevClose)
                    ));
                }
            }
            
            const atr = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    atr.push(null);
                } else if (i === period - 1) {
                    const slice = tr.slice(0, period);
                    atr.push(slice.reduce((a, b) => a + b, 0) / period);
                } else {
                    atr.push((atr[i - 1] * (period - 1) + tr[i]) / period);
                }
            }
            
            return atr;
        }

        // è®¡ç®—BRAR (äººæ°”æ„æ„¿æŒ‡æ ‡)
        function calculateBRAR(data, period = 26) {
            const br = [];
            const ar = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    br.push(null);
                    ar.push(null);
                    continue;
                }
                
                let sumHC = 0;  // æœ€é«˜-æ˜¨æ”¶
                let sumCL = 0;  // æ˜¨æ”¶-æœ€ä½
                let sumHO = 0;  // æœ€é«˜-ä»Šå¼€
                let sumOL = 0;  // ä»Šå¼€-æœ€ä½
                
                for (let j = i - period + 1; j <= i; j++) {
                    sumHC += data[j].high - data[j - 1].close;
                    sumCL += data[j - 1].close - data[j].low;
                    sumHO += data[j].high - data[j].open;
                    sumOL += data[j].open - data[j].low;
                }
                
                br.push(sumHC / (sumCL || 1) * 100);
                ar.push((sumHO + sumOL) / (sumHC + sumCL || 1) * 100);
            }
            
            return { br, ar };
        }

        // è®¡ç®—CR (èƒ½é‡æŒ‡æ ‡)
        function calculateCR(data, period = 26) {
            const cr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    cr.push(null);
                    continue;
                }
                
                let sumP = 0;
                let sumM = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    const mid = (data[j - 1].high + data[j - 1].low + data[j - 1].close) / 3;
                    sumP += Math.max(0, data[j].high - mid);
                    sumM += Math.max(0, mid - data[j].low);
                }
                
                cr.push(sumP / (sumM || 1) * 100);
            }
            
            return cr;
        }

        // è®¡ç®—MOM (åŠ¨é‡æŒ‡æ ‡)
        function calculateMOM(data, period = 10) {
            const closes = data.map(d => d.close);
            return closes.map((close, i) => {
                if (i < period) return null;
                return close - closes[i - period];
            });
        }

        // è®¡ç®—MFI (èµ„é‡‘æµé‡æŒ‡æ ‡ - Money Flow Index)
        function calculateMFI(data, period = 14) {
            const mfi = [];
            const typicalPrice = data.map(d => (d.high + d.low + d.close) / 3);
            const rawMoneyFlow = data.map((d, i) => typicalPrice[i] * d.volume);
            
            for (let i = 0; i < data.length; i++) {
                if (i < period) {
                    mfi.push(null);
                    continue;
                }
                
                let positiveFlow = 0;
                let negativeFlow = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    if (j === 0) continue;
                    if (typicalPrice[j] > typicalPrice[j - 1]) {
                        positiveFlow += rawMoneyFlow[j];
                    } else if (typicalPrice[j] < typicalPrice[j - 1]) {
                        negativeFlow += rawMoneyFlow[j];
                    }
                }
                
                if (negativeFlow === 0) {
                    mfi.push(100);
                } else {
                    const moneyRatio = positiveFlow / negativeFlow;
                    mfi.push(100 - (100 / (1 + moneyRatio)));
                }
            }
            
            return mfi;
        }

        // è®¡ç®—A/D Line (é›†æ•£çº¿ - Accumulation/Distribution Line)
        function calculateADL(data) {
            const adl = [0];
            
            for (let i = 1; i < data.length; i++) {
                const high = data[i].high;
                const low = data[i].low;
                const close = data[i].close;
                const volume = data[i].volume;
                
                let clv = 0;
                if (high !== low) {
                    clv = ((close - low) - (high - close)) / (high - low);
                }
                
                adl.push(adl[i - 1] + clv * volume);
            }
            
            return adl;
        }

        // è®¡ç®—Ichimoku (ä¸€ç›®å‡è¡¡è¡¨)
        function calculateIchimoku(data) {
            const tenkan = [];  // è½¬æ¢çº¿ (9æ—¥)
            const kijun = [];   // åŸºå‡†çº¿ (26æ—¥)
            const senkouA = []; // å…ˆè¡Œå¸¦A
            const senkouB = []; // å…ˆè¡Œå¸¦B (52æ—¥)
            const chikou = [];  // å»¶è¿Ÿçº¿
            
            for (let i = 0; i < data.length; i++) {
                // è½¬æ¢çº¿ (9æ—¥é«˜ä½ç‚¹ä¸­å€¼)
                if (i < 8) {
                    tenkan.push(null);
                } else {
                    const slice = data.slice(i - 8, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    tenkan.push((high + low) / 2);
                }
                
                // åŸºå‡†çº¿ (26æ—¥é«˜ä½ç‚¹ä¸­å€¼)
                if (i < 25) {
                    kijun.push(null);
                } else {
                    const slice = data.slice(i - 25, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    kijun.push((high + low) / 2);
                }
                
                // å…ˆè¡Œå¸¦A ((è½¬æ¢çº¿+åŸºå‡†çº¿)/2ï¼Œå‘å‰ç§»26æ—¥)
                if (tenkan[i] !== null && kijun[i] !== null) {
                    senkouA.push((tenkan[i] + kijun[i]) / 2);
                } else {
                    senkouA.push(null);
                }
                
                // å…ˆè¡Œå¸¦B (52æ—¥é«˜ä½ç‚¹ä¸­å€¼ï¼Œå‘å‰ç§»26æ—¥)
                if (i < 51) {
                    senkouB.push(null);
                } else {
                    const slice = data.slice(i - 51, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    senkouB.push((high + low) / 2);
                }
                
                // å»¶è¿Ÿçº¿ (å½“æ—¥æ”¶ç›˜ä»·ï¼Œå‘åç§»26æ—¥)
                chikou.push(data[i].close);
            }
            
            return { tenkan, kijun, senkouA, senkouB, chikou };
        }

        // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
        function displayStats(data, indicators) {
            const latest = data[data.length - 1];
            const previous = data[data.length - 2];
            const changePercent = ((latest.close - previous.close) / previous.close * 100);
            const amplitude = ((latest.high - latest.low) / previous.close * 100);
            const turnover = (latest.volume / 1000000).toFixed(2);

            const html = `
                <div class="stat-card ${changePercent > 0 ? 'bullish' : 'bearish'}">
                    <div class="stat-label">æœ€æ–°ä»·</div>
                    <div class="stat-value">Â¥${latest.close.toFixed(2)}</div>
                    <div class="stat-change">${changePercent > 0 ? 'â†‘' : 'â†“'} ${Math.abs(changePercent).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šå¼€</div>
                    <div class="stat-value">Â¥${latest.open.toFixed(2)}</div>
                    <div class="stat-change">æœ€é«˜ Â¥${latest.high.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€ä½</div>
                    <div class="stat-value">Â¥${latest.low.toFixed(2)}</div>
                    <div class="stat-change">æŒ¯å¹… ${amplitude.toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æˆäº¤é‡</div>
                    <div class="stat-value">${turnover}M</div>
                    <div class="stat-change">é‡æ¯” ${indicators.volumeRatio[indicators.volumeRatio.length - 1]?.toFixed(2) || '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">MA5</div>
                    <div class="stat-value">Â¥${indicators.ma5[indicators.ma5.length - 1]?.toFixed(2) || '-'}</div>
                    <div class="stat-change">5æ—¥å‡çº¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">MA20</div>
                    <div class="stat-value">Â¥${indicators.ma20[indicators.ma20.length - 1]?.toFixed(2) || '-'}</div>
                    <div class="stat-change">20æ—¥å‡çº¿</div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = html;
        }

        // æ˜¾ç¤ºæŠ€æœ¯ä¿¡å·
        function displaySignals(data, indicators) {
            const signals = [];
            const latest = data[data.length - 1];
            const currentRSI = indicators.rsi[indicators.rsi.length - 1];
            const currentMACD = indicators.macd.macd[indicators.macd.macd.length - 1];
            const currentK = indicators.kdj.k[indicators.kdj.k.length - 1];
            const currentD = indicators.kdj.d[indicators.kdj.d.length - 1];
            const ma5 = indicators.ma5[indicators.ma5.length - 1];
            const ma20 = indicators.ma20[indicators.ma20.length - 1];
            const ma60 = indicators.ma60[indicators.ma60.length - 1];

            // è¶‹åŠ¿ä¿¡å·
            let trendText = '';
            if (ma5 > ma20 && ma20 > ma60) {
                signals.push({ text: 'å¤šå¤´æ’åˆ—', type: 'buy' });
                trendText = '<span class="bullish-text">å¼ºåŠ¿ä¸Šæ¶¨</span>';
            } else if (ma5 < ma20 && ma20 < ma60) {
                signals.push({ text: 'ç©ºå¤´æ’åˆ—', type: 'sell' });
                trendText = '<span class="bearish-text">å¼±åŠ¿ä¸‹è·Œ</span>';
            } else {
                signals.push({ text: 'éœ‡è¡æ•´ç†', type: 'neutral' });
                trendText = '<span class="neutral-text">æ¨ªç›˜éœ‡è¡</span>';
            }

            // RSIä¿¡å·
            let rsiText = '';
            if (currentRSI < 30) {
                signals.push({ text: 'RSIè¶…å–', type: 'buy' });
                rsiText = `<span class="bullish-text">${currentRSI.toFixed(2)} (è¶…å–)</span>`;
            } else if (currentRSI > 70) {
                signals.push({ text: 'RSIè¶…ä¹°', type: 'sell' });
                rsiText = `<span class="bearish-text">${currentRSI.toFixed(2)} (è¶…ä¹°)</span>`;
            } else {
                rsiText = `<span class="neutral-text">${currentRSI.toFixed(2)}</span>`;
            }

            // MACDä¿¡å·
            let macdText = '';
            const prevMACD = indicators.macd.macd[indicators.macd.macd.length - 2];
            if (currentMACD > 0 && prevMACD < 0) {
                signals.push({ text: 'MACDé‡‘å‰', type: 'buy' });
                macdText = '<span class="bullish-text">é‡‘å‰</span>';
            } else if (currentMACD < 0 && prevMACD > 0) {
                signals.push({ text: 'MACDæ­»å‰', type: 'sell' });
                macdText = '<span class="bearish-text">æ­»å‰</span>';
            } else if (currentMACD > 0) {
                macdText = '<span class="bullish-text">å¤šå¤´</span>';
            } else {
                macdText = '<span class="bearish-text">ç©ºå¤´</span>';
            }

            // KDJä¿¡å·
            let kdjText = '';
            if (currentK < 20 && currentK > currentD) {
                signals.push({ text: 'KDJä½ä½é‡‘å‰', type: 'buy' });
                kdjText = '<span class="bullish-text">ä½ä½é‡‘å‰</span>';
            } else if (currentK > 80 && currentK < currentD) {
                signals.push({ text: 'KDJé«˜ä½æ­»å‰', type: 'sell' });
                kdjText = '<span class="bearish-text">é«˜ä½æ­»å‰</span>';
            } else if (currentK > 80) {
                kdjText = '<span class="bearish-text">è¶…ä¹°</span>';
            } else if (currentK < 20) {
                kdjText = '<span class="bullish-text">è¶…å–</span>';
            } else {
                kdjText = '<span class="neutral-text">ä¸­æ€§</span>';
            }

            // å¸ƒæ—å¸¦ä¿¡å·
            const upperBB = indicators.bollinger.upper[indicators.bollinger.upper.length - 1];
            const lowerBB = indicators.bollinger.lower[indicators.bollinger.lower.length - 1];
            const middleBB = indicators.bollinger.middle[indicators.bollinger.middle.length - 1];
            
            let bollingerText = '';
            if (latest.close > upperBB) {
                signals.push({ text: 'çªç ´ä¸Šè½¨', type: 'sell' });
                bollingerText = '<span class="bearish-text">ä¸Šè½¨ä¸Šæ–¹</span>';
            } else if (latest.close < lowerBB) {
                signals.push({ text: 'è§¦åŠä¸‹è½¨', type: 'buy' });
                bollingerText = '<span class="bullish-text">ä¸‹è½¨ä¸‹æ–¹</span>';
            } else if (latest.close > middleBB) {
                bollingerText = '<span class="neutral-text">ä¸­è½¨ä¸Šæ–¹</span>';
            } else {
                bollingerText = '<span class="neutral-text">ä¸­è½¨ä¸‹æ–¹</span>';
            }

            // æ˜¾ç¤ºä¿¡å·
            const signalsHTML = signals.map(s => 
                `<div class="signal ${s.type}">${s.text}</div>`
            ).join('');
            document.getElementById('signals').innerHTML = signalsHTML;

            // æ˜¾ç¤ºæŒ‡æ ‡é¢æ¿
            const panelHTML = `
                <div class="indicator-row">
                    <span class="indicator-name">è¶‹åŠ¿æ–¹å‘</span>
                    <span class="indicator-value">${trendText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">RSI(14)</span>
                    <span class="indicator-value">${rsiText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">MACD</span>
                    <span class="indicator-value">${macdText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">KDJ</span>
                    <span class="indicator-value">${kdjText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">å¸ƒæ—å¸¦</span>
                    <span class="indicator-value">${bollingerText}</span>
                </div>
            `;
            document.getElementById('indicatorPanel').innerHTML = panelHTML;
        }

        // ç»˜åˆ¶æ‰€æœ‰å›¾è¡¨
        function drawAllCharts(data, indicators) {
            // Kçº¿å’Œè¶‹åŠ¿
            drawCandlestickChart(data, indicators);
            drawBollingerChartLW(data, indicators);
            
            // è¶‹åŠ¿æŒ‡æ ‡
            drawMACDChart(data, indicators);
            drawSARChart(data, indicators);
            drawTRIXChart(data, indicators);
            
            // æ‘†åŠ¨æŒ‡æ ‡
            drawKDJChart(data, indicators);
            drawRSIChart(data, indicators);
            drawWRChart(data, indicators);
            drawCCIChart(data, indicators);
            drawStochChart(data, indicators);
            drawMOMChart(data, indicators);
            drawMFIChart(data, indicators);
            
            // è¶‹å‘æŒ‡æ ‡
            drawDMIChart(data, indicators);
            drawIchimokuChart(data, indicators);
            
            // æˆäº¤é‡æŒ‡æ ‡
            drawVolumeChart(data);
            drawOBVChart(data, indicators);
            drawVolumeRatioChart(data, indicators);
            drawVRChart(data, indicators);
            drawBRARChart(data, indicators);
            drawCRChart(data, indicators);
            drawADLChart(data, indicators);
            
            // æ³¢åŠ¨ç‡æŒ‡æ ‡
            drawATRChart(data, indicators);
            
            // å½¢æ€åˆ†æ
            drawSupportResistanceChart(data);
        }

        // Kçº¿å›¾ï¼ˆçœŸæ­£çš„èœ¡çƒ›å›¾ - ä½¿ç”¨Canvasç»˜åˆ¶ï¼‰
        function drawCandlestickChart(data, indicators) {
            const container = document.getElementById('candlestickChart');
            container.innerHTML = '<canvas id="candleCanvas"></canvas>';
            
            const canvas = document.getElementById('candleCanvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®canvaså°ºå¯¸ï¼ˆä½¿ç”¨é«˜åˆ†è¾¨ç‡ï¼‰
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            
            // è®¡ç®—ç»˜å›¾åŒºåŸŸï¼ˆä¼˜åŒ–paddingï¼Œæ‰©å¤§Kçº¿åŒºåŸŸï¼‰
            const padding = { top: 60, right: 80, bottom: 80, left: 70 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // è®¡ç®—ä»·æ ¼èŒƒå›´
            const allPrices = data.flatMap(d => [d.high, d.low]);
            const maxPrice = Math.max(...allPrices);
            const minPrice = Math.min(...allPrices);
            const priceRange = maxPrice - minPrice;
            
            // è¾…åŠ©å‡½æ•°ï¼šä»·æ ¼è½¬Yåæ ‡
            const priceToY = (price) => {
                return padding.top + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
            };
            
            // è¾…åŠ©å‡½æ•°ï¼šç´¢å¼•è½¬Xåæ ‡
            const indexToX = (index) => {
                const candleWidth = chartWidth / data.length;
                return padding.left + index * candleWidth + candleWidth / 2;
            };
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#0f1429';
            ctx.fillRect(0, 0, width, height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#2d3561';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartWidth, y);
                ctx.stroke();
                
                // ä»·æ ¼æ ‡ç­¾
                const price = maxPrice - (priceRange / 5) * i;
                ctx.fillStyle = '#aaa';
                ctx.font = '14px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(price.toFixed(2), padding.left - 10, y + 5);
            }
            
            // ç»˜åˆ¶Kçº¿ï¼ˆèœ¡çƒ›æ›´ç²—ï¼‰
            const candleWidth = Math.max(4, Math.min(12, chartWidth / data.length - 3));
            data.forEach((d, i) => {
                const x = indexToX(i);
                const openY = priceToY(d.open);
                const closeY = priceToY(d.close);
                const highY = priceToY(d.high);
                const lowY = priceToY(d.low);
                
                const isUp = d.close >= d.open;
                const color = isUp ? '#22c55e' : '#ef4444';
                
                // ç»˜åˆ¶å½±çº¿ï¼ˆä¸Šä¸‹å½±çº¿ï¼ŒåŠ ç²—ï¼‰
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // ç»˜åˆ¶å®ä½“ï¼ˆKçº¿ä¸»ä½“ï¼‰
                ctx.fillStyle = color;
                const bodyHeight = Math.abs(closeY - openY);
                const bodyY = Math.min(openY, closeY);
                
                // å¦‚æœå®ä½“å¤ªå°ï¼Œè‡³å°‘æ˜¾ç¤º2px
                if (bodyHeight < 2) {
                    ctx.fillRect(x - candleWidth / 2, bodyY - 1, candleWidth, 2);
                } else {
                    ctx.fillRect(x - candleWidth / 2, bodyY, candleWidth, bodyHeight);
                }
            });
            
            // ç»˜åˆ¶å‡çº¿ï¼ˆåŠ ç²—ï¼‰
            const maLines = [
                { data: indicators.ma5, color: '#22c55e', label: 'MA5', width: 2.5 },
                { data: indicators.ma10, color: '#f59e0b', label: 'MA10', width: 2.5 },
                { data: indicators.ma20, color: '#a855f7', label: 'MA20', width: 2.5 },
                { data: indicators.ma60, color: '#ec4899', label: 'MA60', width: 2.5 }
            ];
            
            maLines.forEach(ma => {
                ctx.strokeStyle = ma.color;
                ctx.lineWidth = ma.width;
                ctx.beginPath();
                let started = false;
                data.forEach((d, i) => {
                    if (ma.data[i] !== null) {
                        const x = indexToX(i);
                        const y = priceToY(ma.data[i]);
                        if (!started) {
                            ctx.moveTo(x, y);
                            started = true;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                });
                ctx.stroke();
            });
            
            // ç»˜åˆ¶å›¾ä¾‹ï¼ˆæ›´å¤§æ›´æ¸…æ™°ï¼‰
            let legendX = padding.left;
            const legendY = 30;
            maLines.forEach(ma => {
                ctx.fillStyle = ma.color;
                ctx.fillRect(legendX, legendY - 6, 20, 4);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(ma.label, legendX + 25, legendY);
                legendX += 100;
            });
            
            // ç»˜åˆ¶æ—¥æœŸï¼ˆæ›´æ¸…æ™°ï¼‰
            ctx.fillStyle = '#aaa';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            const dateStep = Math.ceil(data.length / 10);
            for (let i = 0; i < data.length; i += dateStep) {
                const x = indexToX(i);
                const date = data[i].date.substring(5); // åªæ˜¾ç¤ºæœˆ-æ—¥
                ctx.fillText(date, x, height - 25);
            }
            
            // ç»˜åˆ¶æ ‡é¢˜ï¼ˆæ›´å¤§ï¼‰
            ctx.fillStyle = '#4facfe';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Kçº¿å›¾ä¸å‡çº¿ç³»ç»Ÿ (çº¢æ¶¨ç»¿è·Œ)', padding.left, 20);
            
            // ä¿å­˜åˆ°chartså¯¹è±¡
            charts.candlestick = { canvas, redraw: () => drawCandlestickChart(data, indicators) };
            
            // å“åº”å¼ï¼ˆé˜²æŠ–ï¼‰
            let resizeTimeout;
            const resizeHandler = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (charts.candlestick && charts.candlestick.redraw) {
                        charts.candlestick.redraw();
                    }
                }, 250);
            };
            
            window.removeEventListener('resize', resizeHandler);
            window.addEventListener('resize', resizeHandler);
        }

        // å¸ƒæ—å¸¦å›¾è¡¨ï¼ˆä½¿ç”¨Chart.jsï¼‰
        function drawBollingerChartLW(data, indicators) {
            const container = document.getElementById('bollingerChart');
            container.innerHTML = '<canvas id="bollingerCanvas"></canvas>';
            
            const ctx = document.getElementById('bollingerCanvas').getContext('2d');
            if (charts.bollinger) charts.bollinger.destroy();

            const dates = data.map(d => d.date);

            charts.bollinger = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'ä¸Šè½¨',
                            data: indicators.bollinger.upper,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'ä¸­è½¨',
                            data: indicators.bollinger.middle,
                            borderColor: '#facc15',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'ä¸‹è½¨',
                            data: indicators.bollinger.lower,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // å…¶ä»–å›¾è¡¨å‡½æ•°ï¼ˆä½¿ç”¨Chart.jsï¼‰
        function drawMACDChart(data, indicators) {
            const ctx = document.getElementById('macdChart').getContext('2d');
            if (charts.macd) charts.macd.destroy();

            const dates = data.map(d => d.date);
            const colors = indicators.macd.macd.map(val => val >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)');

            charts.macd = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'MACD',
                            data: indicators.macd.macd,
                            backgroundColor: colors,
                            borderWidth: 0
                        },
                        {
                            label: 'DIF',
                            data: indicators.macd.dif,
                            type: 'line',
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'DEA',
                            data: indicators.macd.dea,
                            type: 'line',
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        function drawKDJChart(data, indicators) {
            const ctx = document.getElementById('kdjChart').getContext('2d');
            if (charts.kdj) charts.kdj.destroy();

            charts.kdj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'K',
                            data: indicators.kdj.k,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'D',
                            data: indicators.kdj.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'J',
                            data: indicators.kdj.j,
                            borderColor: '#a855f7',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        function drawRSIChart(data, indicators) {
            const ctx = document.getElementById('rsiChart').getContext('2d');
            if (charts.rsi) charts.rsi.destroy();

            charts.rsi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'RSI(6)',
                            data: indicators.rsi6,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'RSI(12)',
                            data: indicators.rsi12,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'RSI(14)',
                            data: indicators.rsi,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        function drawWRChart(data, indicators) {
            const ctx = document.getElementById('wrChart').getContext('2d');
            if (charts.wr) charts.wr.destroy();

            charts.wr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'WR(14)',
                        data: indicators.wr,
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: -100, max: 0 } } }
            });
        }

        function drawCCIChart(data, indicators) {
            const ctx = document.getElementById('cciChart').getContext('2d');
            if (charts.cci) charts.cci.destroy();

            charts.cci = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'CCI(14)',
                        data: indicators.cci,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawDMIChart(data, indicators) {
            const ctx = document.getElementById('dmiChart').getContext('2d');
            if (charts.dmi) charts.dmi.destroy();

            charts.dmi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'PDI',
                            data: indicators.dmi.pdi,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'MDI',
                            data: indicators.dmi.mdi,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'ADX',
                            data: indicators.dmi.adx,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        function drawVolumeChart(data) {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            if (charts.volume) charts.volume.destroy();

            const colors = data.map((d, i) => {
                if (i === 0) return '#4facfe';
                return d.close >= d.open ? '#22c55e' : '#ef4444';
            });

            charts.volume = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'æˆäº¤é‡',
                        data: data.map(d => d.volume),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawOBVChart(data, indicators) {
            const ctx = document.getElementById('obvChart').getContext('2d');
            if (charts.obv) charts.obv.destroy();

            charts.obv = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'OBV',
                        data: indicators.obv,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawVolumeRatioChart(data, indicators) {
            const ctx = document.getElementById('volumeRatioChart').getContext('2d');
            if (charts.volumeRatio) charts.volumeRatio.destroy();

            const colors = indicators.volumeRatio.map(r => {
                if (!r) return '#4facfe';
                return r > 1 ? '#22c55e' : '#ef4444';
            });

            charts.volumeRatio = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'é‡æ¯”',
                        data: indicators.volumeRatio,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawSupportResistanceChart(data) {
            const container = document.getElementById('supportResistanceChart');
            container.innerHTML = '<canvas id="supportResistanceCanvas"></canvas>';
            
            const ctx = document.getElementById('supportResistanceCanvas').getContext('2d');
            if (charts.supportResistance) charts.supportResistance.destroy();

            // è®¡ç®—æ”¯æ’‘å‹åŠ›ä½
            const highs = data.map(d => d.high);
            const lows = data.map(d => d.low);
            const resistance = Math.max(...highs.slice(-20));
            const support = Math.min(...lows.slice(-20));
            
            const dates = data.map(d => d.date);

            charts.supportResistance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            pointRadius: 0
                        },
                        {
                            label: 'å‹åŠ›ä½',
                            data: data.map(() => resistance),
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'æ”¯æ’‘ä½',
                            data: data.map(() => support),
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // å½¢æ€è¯†åˆ«
        function displayPatterns(data) {
            const patterns = [];
            const len = data.length;
            
            // æ£€æµ‹æœ€è¿‘çš„Kçº¿å½¢æ€
            if (len >= 3) {
                const d1 = data[len - 3];
                const d2 = data[len - 2];
                const d3 = data[len - 1];
                
                // æ—©æ™¨ä¹‹æ˜Ÿ
                if (d1.close < d1.open && 
                    Math.abs(d2.close - d2.open) < (d1.open - d1.close) * 0.3 &&
                    d3.close > d3.open &&
                    d3.close > (d1.open + d1.close) / 2) {
                    patterns.push({ name: 'æ—©æ™¨ä¹‹æ˜Ÿ', type: 'buy', desc: 'åº•éƒ¨åè½¬ä¿¡å·ï¼Œé¢„ç¤ºä¸Šæ¶¨' });
                }
                
                // é»„æ˜ä¹‹æ˜Ÿ
                if (d1.close > d1.open && 
                    Math.abs(d2.close - d2.open) < (d1.close - d1.open) * 0.3 &&
                    d3.close < d3.open &&
                    d3.close < (d1.open + d1.close) / 2) {
                    patterns.push({ name: 'é»„æ˜ä¹‹æ˜Ÿ', type: 'sell', desc: 'é¡¶éƒ¨åè½¬ä¿¡å·ï¼Œé¢„ç¤ºä¸‹è·Œ' });
                }
            }
            
            // é”¤å­çº¿
            if (len >= 1) {
                const d = data[len - 1];
                const body = Math.abs(d.close - d.open);
                const lowerShadow = Math.min(d.open, d.close) - d.low;
                const upperShadow = d.high - Math.max(d.open, d.close);
                
                if (lowerShadow > body * 2 && upperShadow < body * 0.3) {
                    patterns.push({ name: 'é”¤å­çº¿', type: 'buy', desc: 'åº•éƒ¨åè½¬ä¿¡å·' });
                }
                
                if (upperShadow > body * 2 && lowerShadow < body * 0.3) {
                    patterns.push({ name: 'å€’é”¤å­çº¿', type: 'sell', desc: 'é¡¶éƒ¨åè½¬ä¿¡å·' });
                }
            }
            
            let html = '';
            if (patterns.length > 0) {
                html = patterns.map(p => `
                    <div class="signal ${p.type}" style="display: block; margin-bottom: 10px; padding: 15px;">
                        <strong>${p.name}</strong><br>
                        <span style="font-size: 13px; opacity: 0.9;">${p.desc}</span>
                    </div>
                `).join('');
            } else {
                html = '<div class="info-box"><p>æš‚æœªè¯†åˆ«åˆ°æ˜æ˜¾çš„Kçº¿å½¢æ€</p></div>';
            }
            
            document.getElementById('patternResults').innerHTML = html;
            
            // è¶‹åŠ¿åˆ†æ
            const ma20 = calculateMA(data, 20);
            const trend = ma20[ma20.length - 1] > ma20[ma20.length - 20] ? 'ä¸Šå‡' : 'ä¸‹é™';
            document.getElementById('trendAnalysis').innerHTML = `
                <div class="info-box">
                    <h3>è¶‹åŠ¿æ–¹å‘</h3>
                    <p>å½“å‰20æ—¥å‡çº¿å‘ˆ<strong>${trend}è¶‹åŠ¿</strong></p>
                    <p>MA20: ${ma20[ma20.length - 1]?.toFixed(2)}</p>
                </div>
            `;
        }

        // ç»˜åˆ¶SARå›¾è¡¨
        function drawSARChart(data, indicators) {
            const ctx = document.getElementById('sarChart').getContext('2d');
            if (charts.sar) charts.sar.destroy();

            charts.sar = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'SAR',
                            data: indicators.sar,
                            borderColor: '#f59e0b',
                            borderWidth: 0,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b',
                            showLine: false
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶TRIXå›¾è¡¨
        function drawTRIXChart(data, indicators) {
            const ctx = document.getElementById('trixChart').getContext('2d');
            if (charts.trix) charts.trix.destroy();

            charts.trix = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'TRIX',
                        data: indicators.trix,
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶Stochå›¾è¡¨
        function drawStochChart(data, indicators) {
            const ctx = document.getElementById('stochChart').getContext('2d');
            if (charts.stoch) charts.stoch.destroy();

            charts.stoch = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: '%K',
                            data: indicators.stoch.k,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '%D',
                            data: indicators.stoch.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        // ç»˜åˆ¶ATRå›¾è¡¨
        function drawATRChart(data, indicators) {
            const ctx = document.getElementById('atrChart').getContext('2d');
            if (charts.atr) charts.atr.destroy();

            charts.atr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'ATR(14)',
                        data: indicators.atr,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶VRå›¾è¡¨
        function drawVRChart(data, indicators) {
            const ctx = document.getElementById('vrChart').getContext('2d');
            if (charts.vr) charts.vr.destroy();

            charts.vr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'VR',
                        data: indicators.vr,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶BRARå›¾è¡¨
        function drawBRARChart(data, indicators) {
            const ctx = document.getElementById('brarChart').getContext('2d');
            if (charts.brar) charts.brar.destroy();

            charts.brar = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'BR',
                            data: indicators.brar.br,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'AR',
                            data: indicators.brar.ar,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶CRå›¾è¡¨
        function drawCRChart(data, indicators) {
            const ctx = document.getElementById('crChart').getContext('2d');
            if (charts.cr) charts.cr.destroy();

            charts.cr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'CR',
                        data: indicators.cr,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶MOMå›¾è¡¨
        function drawMOMChart(data, indicators) {
            const ctx = document.getElementById('momChart').getContext('2d');
            if (charts.mom) charts.mom.destroy();

            charts.mom = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'MOM(10)',
                        data: indicators.mom,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶MFIå›¾è¡¨
        function drawMFIChart(data, indicators) {
            const ctx = document.getElementById('mfiChart').getContext('2d');
            if (charts.mfi) charts.mfi.destroy();

            charts.mfi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'MFI(14)',
                        data: indicators.mfi,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        // ç»˜åˆ¶ADLå›¾è¡¨
        function drawADLChart(data, indicators) {
            const ctx = document.getElementById('adlChart').getContext('2d');
            if (charts.adl) charts.adl.destroy();

            charts.adl = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'A/D Line',
                        data: indicators.adl,
                        borderColor: '#14b8a6',
                        backgroundColor: 'rgba(20, 184, 166, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶Ichimokuå›¾è¡¨
        function drawIchimokuChart(data, indicators) {
            const ctx = document.getElementById('ichimokuChart').getContext('2d');
            if (charts.ichimoku) charts.ichimoku.destroy();

            charts.ichimoku = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'è½¬æ¢çº¿',
                            data: indicators.ichimoku.tenkan,
                            borderColor: '#ef4444',
                            borderWidth: 1.5,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'åŸºå‡†çº¿',
                            data: indicators.ichimoku.kijun,
                            borderColor: '#3b82f6',
                            borderWidth: 1.5,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'å…ˆè¡Œå¸¦A',
                            data: indicators.ichimoku.senkouA,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        {
                            label: 'å…ˆè¡Œå¸¦B',
                            data: indicators.ichimoku.senkouB,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 1,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // é€šç”¨å›¾è¡¨é…ç½®
        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: '#aaa', font: { size: 11 } }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#2d3561' },
                        ticks: { color: '#aaa', maxTicksLimit: 12, font: { size: 10 } }
                    },
                    y: {
                        grid: { color: '#2d3561' },
                        ticks: { color: '#aaa', font: { size: 10 } }
                    }
                }
            };
        }
    </script>
</body>
</html>
