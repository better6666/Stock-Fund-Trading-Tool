<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业量化股票分析系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: #0a0e27;
            color: #fff;
            padding: 10px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .header {
                padding: 20px 15px !important;
            }
            .header h1 {
                font-size: 22px !important;
            }
            .header p {
                font-size: 11px !important;
            }
            .search-section {
                padding: 15px !important;
            }
            .search-bar {
                flex-direction: column;
                gap: 10px !important;
            }
            .search-input {
                min-width: 100% !important;
                font-size: 16px !important;
                padding: 12px !important;
            }
            select {
                width: 100%;
                font-size: 16px !important;
                padding: 12px !important;
            }
            button {
                width: 100%;
                padding: 14px !important;
                font-size: 15px !important;
            }
            .category-btn {
                padding: 12px !important;
                font-size: 14px !important;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            .stat-card {
                padding: 15px !important;
            }
            .stat-value {
                font-size: 24px !important;
            }
            .chart-grid {
                grid-template-columns: 1fr !important;
            }
            .stock-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            .stock-item {
                padding: 12px !important;
            }
            .stock-name {
                font-size: 13px !important;
            }
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            .tab {
                white-space: nowrap;
                font-size: 13px;
                padding: 12px 20px;
                min-width: 120px;
            }
            .card {
                padding: 15px !important;
            }
            .card h2 {
                font-size: 18px !important;
            }
            .chart-container {
                height: 400px !important;
                padding: 10px !important;
            }
            .chart-container.large {
                height: 500px !important;
            }
            .chart-container.small {
                height: 350px !important;
            }
            .info-box {
                padding: 12px !important;
                font-size: 13px !important;
            }
            .company-info {
                grid-template-columns: 1fr !important;
            }
            .fundamentals-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .header h1 {
                font-size: 28px !important;
            }
            .stats-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
            .chart-grid {
                grid-template-columns: 1fr !important;
            }
            .stock-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            .chart-container {
                height: 500px !important;
            }
            .chart-container.large {
                height: 650px !important;
            }
            .chart-container.small {
                height: 400px !important;
            }
            .company-info {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            .fundamentals-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        @media (min-width: 1025px) and (max-width: 1440px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .stock-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            .company-info {
                grid-template-columns: repeat(3, 1fr);
            }
            .fundamentals-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1441px) {
            .stats-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            .chart-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .stock-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            .company-info {
                grid-template-columns: repeat(4, 1fr);
            }
            .fundamentals-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .search-section {
            background: #1a1f3a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .search-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 300px;
            background: #0f1429;
            border: 2px solid #2d3561;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
        }
        .search-input:focus {
            outline: none;
            border-color: #4facfe;
        }
        select {
            background: #0f1429;
            border: 2px solid #2d3561;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        select:focus {
            outline: none;
            border-color: #4facfe;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #4facfe;
        }
        .loading.active {
            display: block;
        }
        .spinner {
            border: 4px solid #2d3561;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* 添加触摸优化 */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        button, .tab, .stock-item, .category-btn {
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        .period-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .period-btn {
            padding: 10px 18px;
            font-size: 13px;
            min-width: auto;
            flex: 0 0 auto;
        }
        
        .period-btn-active {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
        }
        
        @media (max-width: 768px) {
            .period-buttons {
                gap: 6px;
            }
            .period-btn {
                padding: 10px 14px !important;
                font-size: 12px !important;
                flex: 1 1 calc(33.333% - 6px);
                min-width: 0;
            }
        }
        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #2d3561;
        }
        .stat-card.bullish {
            background: linear-gradient(135deg, #134e48 0%, #267871 100%);
        }
        .stat-card.bearish {
            background: linear-gradient(135deg, #7b1e3d 0%, #a32952 100%);
        }
        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-change {
            font-size: 13px;
            opacity: 0.9;
        }
        .card {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .card h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #4facfe;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-container {
            background: #0f1429;
            border-radius: 8px;
            padding: 15px;
            height: 650px;
        }
        .chart-container.small {
            height: 500px;
        }
        .chart-container.large {
            height: 850px;
        }
        #candlestickChart {
            min-height: 800px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
        }
        .signals {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .signal {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid;
        }
        .signal.buy {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }
        .signal.sell {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        .signal.neutral {
            background: rgba(250, 204, 21, 0.2);
            border-color: #facc15;
            color: #facc15;
        }
        .indicator-panel {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .indicator-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #2d3561;
        }
        .indicator-row:last-child {
            border-bottom: none;
        }
        .indicator-name {
            color: #aaa;
            font-size: 14px;
        }
        .indicator-value {
            font-size: 15px;
            font-weight: bold;
        }
        .bullish-text {
            color: #22c55e;
        }
        .bearish-text {
            color: #ef4444;
        }
        .neutral-text {
            color: #facc15;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            background: #1a1f3a;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #2d3561;
            transition: all 0.3s;
            font-size: 14px;
        }
        .tab:hover {
            background: #2d3561;
            border-color: #4facfe;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        .info-box {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            margin-bottom: 15px;
        }
        .info-box h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #4facfe;
        }
        .info-box p {
            font-size: 14px;
            color: #aaa;
            line-height: 1.6;
        }
        .company-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .company-info-item {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
        }
        .company-info-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .company-info-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .error.active {
            display: block;
        }
        .category-btn {
            flex: 1;
            background: #1a1f3a;
            border: 2px solid #2d3561;
            color: #aaa;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .category-btn:hover {
            border-color: #4facfe;
            background: #2d3561;
        }
        .category-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }
        .category-content {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .stock-item {
            background: #0f1429;
            border: 2px solid #2d3561;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .stock-item:hover {
            border-color: #4facfe;
            background: #1a1f3a;
            transform: translateY(-2px);
        }
        .stock-item.selected {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        .stock-name {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        .stock-code {
            font-size: 12px;
            color: #888;
        }
        .fundamentals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .fundamental-item {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #4facfe;
        }
        .fundamental-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .fundamental-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        .financial-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .financial-table th {
            background: #0f1429;
            padding: 12px;
            text-align: left;
            color: #4facfe;
            font-size: 13px;
            border-bottom: 2px solid #2d3561;
        }
        .financial-table td {
            padding: 12px;
            border-bottom: 1px solid #2d3561;
            font-size: 14px;
        }
        .financial-table tr:hover {
            background: #0f1429;
        }
        .news-item {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #4facfe;
            cursor: pointer;
            transition: all 0.3s;
        }
        .news-item:hover {
            background: #1a1f3a;
            border-left-color: #22c55e;
            transform: translateX(5px);
        }
        .news-title {
            font-size: 15px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .news-meta {
            font-size: 12px;
            color: #888;
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
        }
        .news-summary {
            font-size: 13px;
            color: #aaa;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 专业量化股票分析系统</h1>
            <p style="color: #aaa;">实时数据获取 · 全量技术指标 · K线图分析 · 基本面研究</p>
        </div>

        <div class="search-section">
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <button onclick="switchCategory('stock')" id="stockCategoryBtn" class="category-btn active">
                        📊 股票市场
                    </button>
                    <button onclick="switchCategory('fund')" id="fundCategoryBtn" class="category-btn">
                        💼 基金市场
                    </button>
                </div>
            </div>

            <div id="stockCategory" class="category-content">
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 10px;">📈 热门股票</h3>
                    <div class="stock-grid" id="stockGrid"></div>
                </div>
            </div>

            <div id="fundCategory" class="category-content" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 10px;">💼 热门基金</h3>
                    <div class="stock-grid" id="fundGrid"></div>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #2d3561;">
                <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 15px;">🔍 自定义搜索</h3>
                <div class="search-bar">
                    <input type="text" class="search-input" id="stockCode" placeholder="输入股票/基金代码（如：AAPL, 600519.SS, 000001.SZ）" />
                    <select id="dataSource">
                        <option value="yahoo">Yahoo Finance（全球市场）</option>
                        <option value="sina">新浪财经（A股实时）</option>
                        <option value="eastmoney">东方财富（A股专业）</option>
                        <option value="tencent">腾讯财经（国内数据）</option>
                        <option value="netease">网易财经（A股港股）</option>
                        <option value="alphavantage">Alpha Vantage（国际）</option>
                        <option value="finnhub">Finnhub（全球股票）</option>
                        <option value="polygon">Polygon.io（美股专业）</option>
                        <option value="twelvedata">Twelve Data（全市场）</option>
                        <option value="iexcloud">IEX Cloud（美股）</option>
                    </select>
                    <select id="klineType">
                        <option value="1m">1分钟</option>
                        <option value="5m">5分钟</option>
                        <option value="15m">15分钟</option>
                        <option value="30m">30分钟</option>
                        <option value="60m">60分钟</option>
                        <option value="120m">120分钟</option>
                        <option value="1d" selected>日K</option>
                        <option value="1wk">周K</option>
                        <option value="1mo">月K</option>
                    </select>
                    <select id="timeRange">
                        <option value="1d">1天</option>
                        <option value="5d">5天</option>
                        <option value="1mo">1个月</option>
                        <option value="3mo" selected>3个月</option>
                        <option value="6mo">6个月</option>
                        <option value="1y">1年</option>
                        <option value="2y">2年</option>
                        <option value="5y">5年</option>
                    </select>
                    <button onclick="fetchStockData()" id="searchBtn">🔍 获取数据</button>
                </div>
                <div style="margin-top: 15px;">
                    <h4 style="color: #4facfe; font-size: 14px; margin-bottom: 10px;">⚡ 快速周期切换</h4>
                    <div class="period-buttons">
                        <button onclick="quickSelectPeriod('1m', '1d')" class="period-btn">1分钟</button>
                        <button onclick="quickSelectPeriod('5m', '1d')" class="period-btn">5分钟</button>
                        <button onclick="quickSelectPeriod('15m', '5d')" class="period-btn">15分钟</button>
                        <button onclick="quickSelectPeriod('30m', '5d')" class="period-btn">30分钟</button>
                        <button onclick="quickSelectPeriod('60m', '1mo')" class="period-btn">60分钟</button>
                        <button onclick="quickSelectPeriod('120m', '1mo')" class="period-btn">120分钟</button>
                        <button onclick="quickSelectPeriod('1d', '3mo')" class="period-btn period-btn-active">日K</button>
                        <button onclick="quickSelectPeriod('1wk', '1y')" class="period-btn">周K</button>
                        <button onclick="quickSelectPeriod('1mo', '5y')" class="period-btn">月K</button>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #888;">
                    <strong>提示：</strong>
                    美股直接输入代码（如 AAPL），
                    A股上海加 .SS（如 600519.SS），
                    深圳加 .SZ（如 000001.SZ），
                    港股加 .HK（如 0700.HK）
                    <br>
                    <span style="color: #facc15;">💡 快速周期切换：先选择股票，然后点击上方的周期按钮即可快速切换不同周期的K线图</span>
                </div>
            </div>
        </div>

        <div id="errorMsg" class="error"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>正在获取数据，请稍候...</p>
        </div>

        <div id="results" style="display: none;">
            <!-- 基本信息 -->
            <div class="card" id="companyInfoCard">
                <h2>📋 基本信息</h2>
                <div class="company-info" id="companyInfo"></div>
            </div>

            <!-- 基本面数据 -->
            <div class="card" id="fundamentalsCard">
                <h2>💰 基本面分析</h2>
                <div class="fundamentals-grid" id="fundamentalsData"></div>
            </div>

            <!-- 财报数据 -->
            <div class="card" id="financialReportsCard">
                <h2>📊 财务报表</h2>
                <div id="financialReports"></div>
            </div>

            <!-- 最新新闻 -->
            <div class="card" id="newsCard">
                <h2>📰 相关新闻</h2>
                <div id="newsList"></div>
            </div>

            <!-- 实时数据 -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- 当前周期信息 -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">当前周期</div>
                        <div style="font-size: 24px; font-weight: bold; margin-top: 5px;" id="currentPeriodDisplay">日K线 - 3个月</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; opacity: 0.9;">数据条数</div>
                        <div style="font-size: 24px; font-weight: bold; margin-top: 5px;" id="dataCountDisplay">-</div>
                    </div>
                </div>
            </div>

            <!-- 技术信号 -->
            <div class="card">
                <h2>🎯 综合技术信号</h2>
                <div class="signals" id="signals"></div>
                <div class="indicator-panel" id="indicatorPanel"></div>
            </div>

            <!-- 标签页 -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('overview')">📈 市场总览</div>
                <div class="tab" onclick="switchTab('technical')">📊 技术指标</div>
                <div class="tab" onclick="switchTab('volume')">📦 量价分析</div>
                <div class="tab" onclick="switchTab('pattern')">🔍 形态识别</div>
            </div>

            <!-- 总览 -->
            <div id="overview" class="content active">
                <div class="card">
                    <h2>📊 K线图与均线系统</h2>
                    <div class="chart-container large">
                        <div id="candlestickChart"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>📈 布林带分析（Bollinger Bands）</h2>
                    <div class="chart-container">
                        <div id="bollingerChart"></div>
                    </div>
                </div>
            </div>

            <!-- 技术指标 -->
            <div id="technical" class="content">
                <div class="chart-grid">
                    <div class="card">
                        <h2>📉 MACD指标</h2>
                        <div class="info-box">
                            <p>平滑异同移动平均线，用于判断买卖时机。DIF上穿DEA为金叉（买入），下穿为死叉（卖出）。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="macdChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📊 KDJ随机指标</h2>
                        <div class="info-box">
                            <p>随机摆动指标，K值>80超买，<20超卖。J值最敏感，可提前发现转折点。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="kdjChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📈 RSI相对强弱指标</h2>
                        <div class="info-box">
                            <p>相对强弱指数，>70超买区域，<30超卖区域。50为强弱分界线。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="rsiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📊 威廉指标（WR）</h2>
                        <div class="info-box">
                            <p>威廉超买超卖指标，>-20为超买，<-80为超卖。与价格形成背离时为反转信号。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="wrChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📉 CCI顺势指标</h2>
                        <div class="info-box">
                            <p>商品路径指标，>100为超买，<-100为超卖。穿越0轴为趋势改变信号。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="cciChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📊 DMI趋向指标</h2>
                        <div class="info-box">
                            <p>动向指标，PDI上穿MDI看多，下穿看空。ADX>25表示趋势强劲。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="dmiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>🎯 SAR抛物线指标</h2>
                        <div class="info-box">
                            <p>点位在价格下方为看涨，上方为看跌。SAR转向时提供明确的止损或反转信号。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="sarChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📊 TRIX指标</h2>
                        <div class="info-box">
                            <p>三重指数平滑移动平均，过滤短期噪音。上穿零轴看多，下穿看空。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="trixChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📊 ATR波动率指标</h2>
                        <div class="info-box">
                            <p>衡量市场波动性，值越大波动越剧烈。常用于设置动态止损位。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="atrChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📊 Stoch随机指标</h2>
                        <div class="info-box">
                            <p>快速随机指标，K线和D线。>80超买，<20超卖。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="stochChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📊 MOM动量指标</h2>
                        <div class="info-box">
                            <p>衡量价格变化速度。穿越零轴为趋势改变，与价格背离为反转信号。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="momChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>💰 MFI资金流量指标</h2>
                        <div class="info-box">
                            <p>成交量加权的RSI，衡量资金流入流出力度。>80超买，<20超卖。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="mfiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>📈 一目均衡表 (Ichimoku)</h2>
                        <div class="info-box">
                            <p>综合趋势系统，包含转换线、基准线、先行带（云层）。价格在云层上方为多头，下方为空头。</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="ichimokuChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 量价分析 -->
            <div id="volume" class="content">
                <div class="card">
                    <h2>📦 成交量分析</h2>
                    <div class="info-box">
                        <p>价涨量增为正常上涨，价涨量缩需谨慎。价跌量增为杀跌，价跌量缩为自然回调。</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>📊 OBV能量潮</h2>
                    <div class="info-box">
                        <p>累积能量线，价升量增OBV上升，价跌量增OBV下降。OBV与价格背离为反转信号。</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="obvChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>📈 量比分析</h2>
                    <div class="info-box">
                        <p>当日每分钟平均成交量与过去5日每分钟平均成交量的比值。>1放量，<1缩量。</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="volumeRatioChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>📊 VR成交量比率</h2>
                    <div class="info-box">
                        <p>成交量与价格变动关系。VR>160超买，<40超卖。</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="vrChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>📈 BRAR人气意愿指标</h2>
                    <div class="info-box">
                        <p>BR反映人气，AR反映意愿。BR、AR>150超买，<50超卖。</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="brarChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>⚡ CR能量指标</h2>
                    <div class="info-box">
                        <p>衡量人气与价格动量。>300超买，<40超卖。</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="crChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>📊 A/D Line集散线</h2>
                    <div class="info-box">
                        <p>衡量资金流入流出。ADL与价格同向运动确认趋势，背离预示反转。</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="adlChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 形态识别 -->
            <div id="pattern" class="content">
                <div class="card">
                    <h2>🔍 K线形态识别</h2>
                    <div id="patternResults"></div>
                </div>

                <div class="card">
                    <h2>📊 支撑压力位</h2>
                    <div class="chart-container small">
                        <div id="supportResistanceChart"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>📈 趋势线分析</h2>
                    <div id="trendAnalysis"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let stockData = null;
        let currentSymbol = '';

        // 热门股票列表（扩展版）
        const stockList = [
            // 美股科技
            { name: '苹果', code: 'AAPL', market: '美股', category: '科技' },
            { name: '微软', code: 'MSFT', market: '美股', category: '科技' },
            { name: '谷歌', code: 'GOOGL', market: '美股', category: '科技' },
            { name: '亚马逊', code: 'AMZN', market: '美股', category: '科技' },
            { name: '特斯拉', code: 'TSLA', market: '美股', category: '汽车' },
            { name: '英伟达', code: 'NVDA', market: '美股', category: '科技' },
            { name: '脸书', code: 'META', market: '美股', category: '科技' },
            { name: '奈飞', code: 'NFLX', market: '美股', category: '媒体' },
            { name: '英特尔', code: 'INTC', market: '美股', category: '科技' },
            { name: 'AMD', code: 'AMD', market: '美股', category: '科技' },
            { name: '台积电', code: 'TSM', market: '美股', category: '科技' },
            { name: '迪士尼', code: 'DIS', market: '美股', category: '媒体' },
            { name: '可口可乐', code: 'KO', market: '美股', category: '消费' },
            { name: '百事可乐', code: 'PEP', market: '美股', category: '消费' },
            { name: '麦当劳', code: 'MCD', market: '美股', category: '消费' },
            { name: '耐克', code: 'NKE', market: '美股', category: '消费' },
            { name: '星巴克', code: 'SBUX', market: '美股', category: '消费' },
            { name: '波音', code: 'BA', market: '美股', category: '工业' },
            { name: '埃克森美孚', code: 'XOM', market: '美股', category: '能源' },
            { name: '雪佛龙', code: 'CVX', market: '美股', category: '能源' },
            // 美股金融
            { name: '摩根大通', code: 'JPM', market: '美股', category: '金融' },
            { name: '美国银行', code: 'BAC', market: '美股', category: '金融' },
            { name: '富国银行', code: 'WFC', market: '美股', category: '金融' },
            { name: '高盛', code: 'GS', market: '美股', category: '金融' },
            { name: '伯克希尔', code: 'BRK-B', market: '美股', category: '金融' },
            { name: '维萨', code: 'V', market: '美股', category: '金融' },
            { name: '万事达', code: 'MA', market: '美股', category: '金融' },
            // A股主板
            { name: '贵州茅台', code: '600519.SS', market: 'A股', category: '消费' },
            { name: '中国平安', code: '601318.SS', market: 'A股', category: '金融' },
            { name: '招商银行', code: '600036.SS', market: 'A股', category: '金融' },
            { name: '五粮液', code: '000858.SZ', market: 'A股', category: '消费' },
            { name: '美的集团', code: '000333.SZ', market: 'A股', category: '家电' },
            { name: '格力电器', code: '000651.SZ', market: 'A股', category: '家电' },
            { name: '中国移动', code: '600941.SS', market: 'A股', category: '通信' },
            { name: '工商银行', code: '601398.SS', market: 'A股', category: '金融' },
            { name: '建设银行', code: '601939.SS', market: 'A股', category: '金融' },
            { name: '中国石油', code: '601857.SS', market: 'A股', category: '能源' },
            { name: '中国石化', code: '600028.SS', market: 'A股', category: '能源' },
            { name: '海天味业', code: '603288.SS', market: 'A股', category: '消费' },
            { name: '恒瑞医药', code: '600276.SS', market: 'A股', category: '医药' },
            { name: '药明康德', code: '603259.SS', market: 'A股', category: '医药' },
            { name: '隆基绿能', code: '601012.SS', market: 'A股', category: '新能源' },
            { name: '三一重工', code: '600031.SS', market: 'A股', category: '机械' },
            // 创业板/科创板
            { name: '宁德时代', code: '300750.SZ', market: 'A股', category: '新能源' },
            { name: '比亚迪', code: '002594.SZ', market: 'A股', category: '汽车' },
            { name: '迈瑞医疗', code: '300760.SZ', market: 'A股', category: '医疗' },
            { name: '东方财富', code: '300059.SZ', market: 'A股', category: '金融' },
            { name: '汇川技术', code: '300124.SZ', market: 'A股', category: '工控' },
            // 港股
            { name: '腾讯控股', code: '0700.HK', market: '港股', category: '科技' },
            { name: '阿里巴巴', code: '9988.HK', market: '港股', category: '科技' },
            { name: '美团', code: '3690.HK', market: '港股', category: '互联网' },
            { name: '京东', code: '9618.HK', market: '港股', category: '电商' },
            { name: '小米集团', code: '1810.HK', market: '港股', category: '科技' },
            { name: '比亚迪股份', code: '1211.HK', market: '港股', category: '汽车' },
            { name: '中国移动', code: '0941.HK', market: '港股', category: '通信' }
        ];

        // 热门基金列表（扩展版 - 使用ETF代码）
        const fundList = [
            // 美国宽基指数ETF
            { name: '标普500ETF', code: 'SPY', market: '美国', category: '宽基指数' },
            { name: '纳斯达克100ETF', code: 'QQQ', market: '美国', category: '宽基指数' },
            { name: '道琼斯ETF', code: 'DIA', market: '美国', category: '宽基指数' },
            { name: '罗素2000ETF', code: 'IWM', market: '美国', category: '宽基指数' },
            { name: '标普400中盘ETF', code: 'MDY', market: '美国', category: '宽基指数' },
            // 美国行业ETF
            { name: '科技股ETF', code: 'XLK', market: '美国', category: '行业' },
            { name: '金融股ETF', code: 'XLF', market: '美国', category: '行业' },
            { name: '医疗股ETF', code: 'XLV', market: '美国', category: '行业' },
            { name: '能源股ETF', code: 'XLE', market: '美国', category: '行业' },
            { name: '消费ETF', code: 'XLP', market: '美国', category: '行业' },
            { name: '工业ETF', code: 'XLI', market: '美国', category: '行业' },
            { name: '房地产ETF', code: 'XLRE', market: '美国', category: '行业' },
            { name: '公用事业ETF', code: 'XLU', market: '美国', category: '行业' },
            { name: '材料ETF', code: 'XLB', market: '美国', category: '行业' },
            { name: '通信ETF', code: 'XLC', market: '美国', category: '行业' },
            // 美国主题ETF
            { name: '半导体ETF', code: 'SOXX', market: '美国', category: '主题' },
            { name: '生物科技ETF', code: 'IBB', market: '美国', category: '主题' },
            { name: '云计算ETF', code: 'SKYY', market: '美国', category: '主题' },
            { name: '网络安全ETF', code: 'HACK', market: '美国', category: '主题' },
            { name: '清洁能源ETF', code: 'ICLN', market: '美国', category: '主题' },
            { name: '电动车ETF', code: 'DRIV', market: '美国', category: '主题' },
            // 国际市场ETF
            { name: '新兴市场ETF', code: 'EEM', market: '美国', category: '国际' },
            { name: '中国ETF', code: 'FXI', market: '美国', category: '国际' },
            { name: '欧洲ETF', code: 'VGK', market: '美国', category: '国际' },
            { name: '日本ETF', code: 'EWJ', market: '美国', category: '国际' },
            { name: '印度ETF', code: 'INDA', market: '美国', category: '国际' },
            // 商品ETF
            { name: '黄金ETF', code: 'GLD', market: '美国', category: '商品' },
            { name: '白银ETF', code: 'SLV', market: '美国', category: '商品' },
            { name: '石油ETF', code: 'USO', market: '美国', category: '商品' },
            { name: '天然气ETF', code: 'UNG', market: '美国', category: '商品' },
            // 债券ETF
            { name: '美国国债ETF', code: 'TLT', market: '美国', category: '债券' },
            { name: '公司债ETF', code: 'LQD', market: '美国', category: '债券' },
            { name: '高收益债ETF', code: 'HYG', market: '美国', category: '债券' },
            // 中国宽基ETF
            { name: '沪深300ETF', code: '510300.SS', market: '中国', category: '宽基指数' },
            { name: '中证500ETF', code: '510500.SS', market: '中国', category: '宽基指数' },
            { name: '创业板ETF', code: '159915.SZ', market: '中国', category: '宽基指数' },
            { name: '科创50ETF', code: '588000.SS', market: '中国', category: '宽基指数' },
            { name: '上证50ETF', code: '510050.SS', market: '中国', category: '宽基指数' },
            { name: '深证100ETF', code: '159901.SZ', market: '中国', category: '宽基指数' },
            // 中国行业ETF
            { name: '消费ETF', code: '159928.SZ', market: '中国', category: '行业' },
            { name: '医药ETF', code: '512010.SS', market: '中国', category: '行业' },
            { name: '券商ETF', code: '512000.SS', market: '中国', category: '行业' },
            { name: '银行ETF', code: '512800.SS', market: '中国', category: '行业' },
            { name: '军工ETF', code: '512660.SS', market: '中国', category: '行业' },
            { name: '芯片ETF', code: '512760.SS', market: '中国', category: '行业' },
            { name: '新能源车ETF', code: '515030.SS', market: '中国', category: '行业' },
            { name: '光伏ETF', code: '515790.SS', market: '中国', category: '行业' },
            // 中国其他ETF
            { name: '恒生ETF', code: '159920.SZ', market: '中国', category: '港股' },
            { name: '红利ETF', code: '510880.SS', market: '中国', category: '策略' },
            { name: 'H股ETF', code: '510900.SS', market: '中国', category: '港股' }
        ];

        // 初始化页面
        window.onload = function() {
            initStockGrid();
            initFundGrid();
        };

        // 初始化股票列表
        function initStockGrid() {
            const grid = document.getElementById('stockGrid');
            grid.innerHTML = stockList.map(stock => `
                <div class="stock-item" onclick="selectStock('${stock.code}', '${stock.name}')">
                    <div class="stock-name">${stock.name}</div>
                    <div class="stock-code">${stock.code}</div>
                    <div class="stock-code">${stock.market}</div>
                </div>
            `).join('');
        }

        // 初始化基金列表
        function initFundGrid() {
            const grid = document.getElementById('fundGrid');
            grid.innerHTML = fundList.map(fund => `
                <div class="stock-item" onclick="selectStock('${fund.code}', '${fund.name}')">
                    <div class="stock-name">${fund.name}</div>
                    <div class="stock-code">${fund.code}</div>
                    <div class="stock-code">${fund.market}</div>
                </div>
            `).join('');
        }

        // 切换分类
        function switchCategory(category) {
            document.getElementById('stockCategoryBtn').classList.remove('active');
            document.getElementById('fundCategoryBtn').classList.remove('active');
            document.getElementById('stockCategory').style.display = 'none';
            document.getElementById('fundCategory').style.display = 'none';

            if (category === 'stock') {
                document.getElementById('stockCategoryBtn').classList.add('active');
                document.getElementById('stockCategory').style.display = 'block';
            } else {
                document.getElementById('fundCategoryBtn').classList.add('active');
                document.getElementById('fundCategory').style.display = 'block';
            }
        }

        // 选择股票/基金
        function selectStock(code, name) {
            // 移除所有选中状态
            document.querySelectorAll('.stock-item').forEach(item => {
                item.classList.remove('selected');
            });
            // 添加选中状态
            event.currentTarget.classList.add('selected');
            
            // 设置代码并获取数据
            document.getElementById('stockCode').value = code;
            currentSymbol = code;
            fetchStockData();
        }

        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        // 显示错误
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            // 处理换行符
            errorDiv.innerHTML = message.replace(/\n/g, '<br>');
            errorDiv.classList.add('active');
            
            // 滚动到错误位置
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 10秒后自动隐藏
            setTimeout(() => errorDiv.classList.remove('active'), 10000);
        }

        // 快速选择周期
        function quickSelectPeriod(klineType, range) {
            if (!document.getElementById('stockCode').value.trim()) {
                showError('请先选择或输入股票代码');
                return;
            }
            
            document.getElementById('klineType').value = klineType;
            document.getElementById('timeRange').value = range;
            fetchStockData();
        }

        // 获取股票数据
        async function fetchStockData() {
            const stockCode = document.getElementById('stockCode').value.trim();
            const dataSource = document.getElementById('dataSource').value;
            const timeRange = document.getElementById('timeRange').value;
            const klineType = document.getElementById('klineType').value;

            if (!stockCode) {
                showError('请输入股票代码');
                return;
            }

            console.log('=== 开始获取数据 ===');
            console.log('股票代码:', stockCode);
            console.log('数据源:', dataSource);
            console.log('K线周期:', klineType);
            console.log('时间范围:', timeRange);

            // 根据K线类型调整时间范围
            let adjustedRange = timeRange;
            if (klineType.includes('m')) {
                // 分时数据，限制时间范围
                if (!['1d', '5d', '1mo'].includes(timeRange)) {
                    adjustedRange = '5d';
                    console.log('⚠️ 分时数据自动调整时间范围为5天');
                }
            }

            document.getElementById('loading').classList.add('active');
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('results').style.display = 'none';

            try {
                let data;
                if (dataSource === 'yahoo') {
                    data = await fetchFromYahoo(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'sina') {
                    data = await fetchFromSina(stockCode);
                } else if (dataSource === 'eastmoney') {
                    data = await fetchFromEastMoney(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'tencent') {
                    data = await fetchFromTencent(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'netease') {
                    data = await fetchFromNetease(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'alphavantage') {
                    data = await fetchFromAlphaVantage(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'finnhub') {
                    data = await fetchFromFinnhub(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'polygon') {
                    data = await fetchFromPolygon(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'twelvedata') {
                    data = await fetchFromTwelveData(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'iexcloud') {
                    data = await fetchFromIEXCloud(stockCode, adjustedRange, klineType);
                } else {
                    showError('该数据源暂未实现，请选择其他数据源');
                    return;
                }

                if (data && data.length > 0) {
                    stockData = data;
                    analyzeAndDisplay(data);
                    // 清除错误信息
                    document.getElementById('errorMsg').classList.remove('active');
                } else {
                    showError('未能获取数据，请检查股票代码是否正确');
                }
            } catch (error) {
                console.error('Error:', error);
                let errorMsg = error.message || '数据获取失败';
                
                // 提供更友好的错误提示
                if (errorMsg.includes('HTTP error')) {
                    errorMsg = '网络连接失败，请检查网络或稍后重试';
                } else if (errorMsg.includes('未找到数据')) {
                    errorMsg = `股票代码"${stockCode}"可能不正确，请检查：\n- 美股直接输入代码（如 AAPL）\n- A股上海加 .SS（如 600519.SS）\n- A股深圳加 .SZ（如 000001.SZ）\n- 港股加 .HK（如 0700.HK）`;
                }
                
                showError(errorMsg);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('searchBtn').disabled = false;
            }
        }

        // 数据源配置（只保留最稳定的）
        const dataSources = [
            {
                name: 'Yahoo Finance via CORS Proxy',
                fetch: async (symbol, range) => {
                    const period1 = Math.floor(Date.now() / 1000) - getRangeSeconds(range);
                    const period2 = Math.floor(Date.now() / 1000);
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=1d`;
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return await response.json();
                }
            }
        ];

        // 多数据源配置（更多选择）
        const multiDataSources = [
            {
                name: 'AllOrigins Proxy',
                getUrl: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
            },
            {
                name: 'CORS Anywhere',
                getUrl: (url) => `https://cors-anywhere.herokuapp.com/${url}`
            },
            {
                name: 'ThingProxy',
                getUrl: (url) => `https://thingproxy.freeboard.io/fetch/${url}`
            },
            {
                name: 'CORS.SH',
                getUrl: (url) => `https://cors.sh/${url}`
            }
        ];

        // 获取数据（支持所有K线周期，多数据源）
        async function fetchFromYahoo(symbol, range, interval = '1d') {
            const klineTypeMap = {
                '1m': '1分钟',
                '5m': '5分钟',
                '15m': '15分钟',
                '30m': '30分钟',
                '60m': '60分钟',
                '120m': '120分钟',
                '1d': '日K',
                '1wk': '周K',
                '1mo': '月K'
            };
            
            console.log(`📊 正在获取 ${symbol} 的${klineTypeMap[interval]}数据...`);
            
            const period1 = Math.floor(Date.now() / 1000) - getRangeSeconds(range);
            const period2 = Math.floor(Date.now() / 1000);
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=${interval}`;
            
            // 尝试多个数据源
            for (let i = 0; i < multiDataSources.length; i++) {
                try {
                    const source = multiDataSources[i];
                    console.log(`🔄 尝试数据源 ${i + 1}/${multiDataSources.length}: ${source.name}`);
                    
                    const proxyUrl = source.getUrl(yahooUrl);
                    const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const json = await response.json();
                    
                    if (json.chart && json.chart.result && json.chart.result[0]) {
                        const result = json.chart.result[0];
                        
                        if (!result.timestamp || result.timestamp.length === 0) {
                            throw new Error('没有可用的历史数据');
                        }
                        
                        const timestamps = result.timestamp;
                        const quotes = result.indicators.quote[0];
                        
                        // 根据周期格式化时间
                        const formatTime = (timestamp) => {
                            const date = new Date(timestamp * 1000);
                            if (interval.includes('m')) {
                                // 分钟级别显示 月-日 时:分
                                return date.toLocaleString('zh-CN', { 
                                    month: '2-digit', 
                                    day: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                }).replace(/\//g, '-');
                            } else if (interval === '1wk') {
                                return date.toISOString().split('T')[0];
                            } else if (interval === '1mo') {
                                return date.toISOString().substring(0, 7);
                            } else {
                                return date.toISOString().split('T')[0];
                            }
                        };
                        
                        const data = timestamps.map((time, i) => ({
                            date: formatTime(time),
                            timestamp: time,
                            open: quotes.open[i] || quotes.close[i],
                            high: quotes.high[i] || quotes.close[i],
                            low: quotes.low[i] || quotes.close[i],
                            close: quotes.close[i],
                            volume: quotes.volume[i] || 0
                        })).filter(d => d.close !== null && d.close !== undefined);
                        
                        if (data.length === 0) {
                            throw new Error('过滤后没有有效数据');
                        }
                        
                        console.log(`✅ 成功！使用 ${source.name}，获取 ${data.length} 条${klineTypeMap[interval]}数据`);
                        
                        // 更新周期显示
                        const rangeMap = {
                            '1d': '1天', '5d': '5天', '1mo': '1个月', '3mo': '3个月',
                            '6mo': '6个月', '1y': '1年', '2y': '2年', '5y': '5年'
                        };
                        document.getElementById('currentPeriodDisplay').textContent = 
                            `${klineTypeMap[interval]} - ${rangeMap[range] || range}`;
                        document.getElementById('dataCountDisplay').textContent = data.length + ' 条';
                        
                        // 静默获取基本面信息（仅日K及以上周期）
                        if (!interval.includes('m')) {
                            fetchCompanyInfo(symbol).catch(() => {
                                displayBasicInfo(symbol);
                            });
                            
                            // 获取财报数据
                            fetchFinancialReports(symbol).catch(err => {
                                console.warn('获取财报失败:', err);
                                document.getElementById('financialReports').innerHTML = '<div class="info-box"><p>财报数据加载中...</p></div>';
                            });
                            
                            // 获取相关新闻
                            fetchNews(symbol).catch(err => {
                                console.warn('获取新闻失败:', err);
                                document.getElementById('newsList').innerHTML = '<div class="info-box"><p>新闻加载中...</p></div>';
                            });
                        } else {
                            displayBasicInfo(symbol);
                            document.getElementById('financialReports').innerHTML = '<div class="info-box"><p>财报数据仅在日K及以上周期显示</p></div>';
                            document.getElementById('newsList').innerHTML = '<div class="info-box"><p>新闻仅在日K及以上周期显示</p></div>';
                        }
                        
                        return data;
                    } else if (json.chart && json.chart.error) {
                        throw new Error(json.chart.error.description || '数据获取失败');
                    }
                    
                    throw new Error('未找到数据');
                } catch (error) {
                    console.warn(`❌ ${multiDataSources[i].name} 失败:`, error.message);
                    
                    // 如果不是最后一个数据源，继续尝试
                    if (i < multiDataSources.length - 1) {
                        console.log('继续尝试下一个数据源...');
                        continue;
                    }
                }
            }
            
            throw new Error('所有数据源都无法访问，请检查网络或稍后重试');
        }

        // 获取公司基本面信息（带多数据源，静默失败）
        async function fetchCompanyInfo(symbol) {
            // 只使用成功率高的代理
            const fundamentalSources = [
                {
                    name: 'Yahoo Quote via Proxy 1',
                    fetch: async () => {
                        const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail,defaultKeyStatistics,financialData,price`;
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                        const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return await response.json();
                    }
                }
            ];
            
            for (let i = 0; i < fundamentalSources.length; i++) {
                try {
                    const json = await fundamentalSources[i].fetch();
                    
                    if (json.quoteSummary && json.quoteSummary.result && json.quoteSummary.result[0]) {
                        const data = json.quoteSummary.result[0];
                        console.log(`✅ 基本面数据获取成功`);
                        displayCompanyInfo(data, symbol);
                        displayFundamentals(data);
                        return;
                    }
                } catch (error) {
                    // 静默失败，不显示错误
                    displayBasicInfo(symbol);
                }
            }
        }

        // 显示公司基本信息
        function displayCompanyInfo(data, symbol) {
            const price = data.price || {};
            const summary = data.summaryDetail || {};
            
            const html = `
                <div class="company-info-item">
                    <div class="company-info-label">股票名称</div>
                    <div class="company-info-value">${price.shortName || symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">股票代码</div>
                    <div class="company-info-value">${symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">交易所</div>
                    <div class="company-info-value">${price.exchangeName || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">货币</div>
                    <div class="company-info-value">${price.currency || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">市场类型</div>
                    <div class="company-info-value">${price.quoteType || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">52周最高</div>
                    <div class="company-info-value">${summary.fiftyTwoWeekHigh?.fmt || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">52周最低</div>
                    <div class="company-info-value">${summary.fiftyTwoWeekLow?.fmt || '-'}</div>
                </div>
            `;
            
            document.getElementById('companyInfo').innerHTML = html;
        }

        // 显示基本面数据
        function displayFundamentals(data) {
            const stats = data.defaultKeyStatistics || {};
            const financial = data.financialData || {};
            const summary = data.summaryDetail || {};
            
            const fundamentals = [
                {
                    label: '市盈率 (P/E)',
                    value: stats.trailingPE?.fmt || summary.trailingPE?.fmt || '-',
                    desc: '股价与每股收益的比率'
                },
                {
                    label: '市净率 (P/B)',
                    value: stats.priceToBook?.fmt || '-',
                    desc: '股价与每股净资产的比率'
                },
                {
                    label: '市值',
                    value: summary.marketCap?.fmt || '-',
                    desc: '公司总市值'
                },
                {
                    label: '每股收益 (EPS)',
                    value: stats.trailingEps?.fmt || '-',
                    desc: '公司盈利能力指标'
                },
                {
                    label: '股息率',
                    value: summary.dividendYield?.fmt ? (parseFloat(summary.dividendYield.raw) * 100).toFixed(2) + '%' : '-',
                    desc: '年度股息/股价'
                },
                {
                    label: '净资产收益率 (ROE)',
                    value: financial.returnOnEquity?.fmt || '-',
                    desc: '净利润/净资产'
                },
                {
                    label: '总资产收益率 (ROA)',
                    value: financial.returnOnAssets?.fmt || '-',
                    desc: '净利润/总资产'
                },
                {
                    label: '营业收入',
                    value: financial.totalRevenue?.fmt || '-',
                    desc: '公司总营收'
                },
                {
                    label: '毛利率',
                    value: financial.grossMargins?.fmt || '-',
                    desc: '毛利润/营业收入'
                },
                {
                    label: '净利率',
                    value: financial.profitMargins?.fmt || '-',
                    desc: '净利润/营业收入'
                },
                {
                    label: '营收增长率',
                    value: financial.revenueGrowth?.fmt || '-',
                    desc: '同比营收增长'
                },
                {
                    label: '自由现金流',
                    value: financial.freeCashflow?.fmt || '-',
                    desc: '公司可自由支配现金'
                },
                {
                    label: '流通股',
                    value: stats.floatShares?.fmt || '-',
                    desc: '可流通的股票数量'
                },
                {
                    label: '总股本',
                    value: stats.sharesOutstanding?.fmt || '-',
                    desc: '公司发行的总股数'
                },
                {
                    label: '资产负债率',
                    value: financial.debtToEquity?.fmt || '-',
                    desc: '总负债/股东权益'
                },
                {
                    label: '流动比率',
                    value: financial.currentRatio?.fmt || '-',
                    desc: '流动资产/流动负债'
                }
            ];
            
            const html = fundamentals.map(item => `
                <div class="fundamental-item">
                    <div class="fundamental-label">${item.label}</div>
                    <div class="fundamental-value">${item.value}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">${item.desc}</div>
                </div>
            `).join('');
            
            document.getElementById('fundamentalsData').innerHTML = html;
        }

        // 显示基本信息（当无法获取详细信息时）
        function displayBasicInfo(symbol) {
            const html = `
                <div class="company-info-item">
                    <div class="company-info-label">股票代码</div>
                    <div class="company-info-value">${symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">提示</div>
                    <div class="company-info-value">基本面数据加载中或暂无数据</div>
                </div>
            `;
            document.getElementById('companyInfo').innerHTML = html;
            document.getElementById('fundamentalsData').innerHTML = '<div class="info-box"><p>暂时无法获取基本面数据</p></div>';
        }

        // 获取财务报表数据
        async function fetchFinancialReports(symbol) {
            try {
                console.log('📊 获取财务报表...');
                
                // 使用Yahoo Finance的财务报表API
                const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=incomeStatementHistory,balanceSheetHistory,cashflowStatementHistory`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const json = await response.json();
                
                if (json.quoteSummary && json.quoteSummary.result && json.quoteSummary.result[0]) {
                    const data = json.quoteSummary.result[0];
                    displayFinancialReports(data);
                    console.log('✅ 财务报表获取成功');
                } else {
                    throw new Error('无财报数据');
                }
            } catch (error) {
                console.warn('财报获取失败:', error);
                document.getElementById('financialReports').innerHTML = `
                    <div class="info-box">
                        <p>暂时无法获取详细财报数据</p>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">提示：可以访问 Yahoo Finance 或公司官网查看完整财报</p>
                    </div>
                `;
            }
        }

        // 显示财务报表
        function displayFinancialReports(data) {
            let html = '';
            
            // 利润表
            if (data.incomeStatementHistory && data.incomeStatementHistory.incomeStatementHistory) {
                const statements = data.incomeStatementHistory.incomeStatementHistory.slice(0, 3);
                html += '<h3 style="color: #4facfe; margin-bottom: 10px;">📈 利润表（最近3期）</h3>';
                html += '<table class="financial-table"><thead><tr><th>项目</th>';
                statements.forEach(s => {
                    const date = new Date(s.endDate.raw * 1000).toISOString().split('T')[0];
                    html += `<th>${date}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                const items = [
                    { key: 'totalRevenue', label: '营业收入' },
                    { key: 'grossProfit', label: '毛利润' },
                    { key: 'operatingIncome', label: '营业利润' },
                    { key: 'netIncome', label: '净利润' },
                    { key: 'ebitda', label: 'EBITDA' }
                ];
                
                items.forEach(item => {
                    html += `<tr><td>${item.label}</td>`;
                    statements.forEach(s => {
                        const value = s[item.key];
                        html += `<td>${value ? value.fmt : '-'}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            // 资产负债表
            if (data.balanceSheetHistory && data.balanceSheetHistory.balanceSheetStatements) {
                const statements = data.balanceSheetHistory.balanceSheetStatements.slice(0, 3);
                html += '<h3 style="color: #4facfe; margin: 20px 0 10px 0;">💰 资产负债表（最近3期）</h3>';
                html += '<table class="financial-table"><thead><tr><th>项目</th>';
                statements.forEach(s => {
                    const date = new Date(s.endDate.raw * 1000).toISOString().split('T')[0];
                    html += `<th>${date}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                const items = [
                    { key: 'totalAssets', label: '总资产' },
                    { key: 'totalLiab', label: '总负债' },
                    { key: 'totalStockholderEquity', label: '股东权益' },
                    { key: 'cash', label: '现金' },
                    { key: 'totalCurrentAssets', label: '流动资产' }
                ];
                
                items.forEach(item => {
                    html += `<tr><td>${item.label}</td>`;
                    statements.forEach(s => {
                        const value = s[item.key];
                        html += `<td>${value ? value.fmt : '-'}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            // 现金流量表
            if (data.cashflowStatementHistory && data.cashflowStatementHistory.cashflowStatements) {
                const statements = data.cashflowStatementHistory.cashflowStatements.slice(0, 3);
                html += '<h3 style="color: #4facfe; margin: 20px 0 10px 0;">💵 现金流量表（最近3期）</h3>';
                html += '<table class="financial-table"><thead><tr><th>项目</th>';
                statements.forEach(s => {
                    const date = new Date(s.endDate.raw * 1000).toISOString().split('T')[0];
                    html += `<th>${date}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                const items = [
                    { key: 'totalCashFromOperatingActivities', label: '经营活动现金流' },
                    { key: 'totalCashFromFinancingActivities', label: '融资活动现金流' },
                    { key: 'totalCashflowsFromInvestingActivities', label: '投资活动现金流' },
                    { key: 'freeCashflow', label: '自由现金流' }
                ];
                
                items.forEach(item => {
                    html += `<tr><td>${item.label}</td>`;
                    statements.forEach(s => {
                        const value = s[item.key];
                        html += `<td>${value ? value.fmt : '-'}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            if (html) {
                document.getElementById('financialReports').innerHTML = html;
            } else {
                document.getElementById('financialReports').innerHTML = '<div class="info-box"><p>暂无财报数据</p></div>';
            }
        }

        // 获取相关新闻
        async function fetchNews(symbol) {
            try {
                console.log('📰 获取相关新闻...');
                
                // 使用多个新闻源
                const newsSources = [
                    {
                        name: 'Yahoo Finance News',
                        fetch: async () => {
                            const url = `https://query1.finance.yahoo.com/v1/finance/search?q=${symbol}&quotesCount=0&newsCount=10`;
                            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                            const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
                            return await response.json();
                        },
                        parse: (json) => {
                            if (json.news && json.news.length > 0) {
                                return json.news.map(item => ({
                                    title: item.title,
                                    summary: item.summary || '暂无摘要',
                                    source: item.publisher,
                                    date: new Date(item.providerPublishTime * 1000).toLocaleDateString('zh-CN'),
                                    url: item.link
                                }));
                            }
                            return [];
                        }
                    },
                    {
                        name: 'Finnhub News',
                        fetch: async () => {
                            // 备用新闻源（需要API Key时可配置）
                            return { status: 'ok', articles: [] };
                        },
                        parse: () => []
                    }
                ];
                
                for (let source of newsSources) {
                    try {
                        const json = await source.fetch();
                        const news = source.parse(json);
                        
                        if (news && news.length > 0) {
                            displayNews(news);
                            console.log(`✅ 新闻获取成功，来源：${source.name}`);
                            return;
                        }
                    } catch (err) {
                        console.warn(`${source.name} 失败:`, err);
                        continue;
                    }
                }
                
                throw new Error('所有新闻源都失败');
            } catch (error) {
                console.warn('新闻获取失败:', error);
                document.getElementById('newsList').innerHTML = `
                    <div class="info-box">
                        <h3>📰 暂时无法获取新闻</h3>
                        <p style="margin-top: 10px;">建议访问以下网站查看相关新闻：</p>
                        <ul style="margin-top: 10px; color: #aaa; line-height: 2;">
                            <li>Yahoo Finance: <a href="https://finance.yahoo.com/quote/${symbol}" target="_blank" style="color: #4facfe;">查看</a></li>
                            <li>Google Finance: <a href="https://www.google.com/finance/quote/${symbol.split('.')[0]}:${symbol.includes('.') ? symbol.split('.')[1] : 'NASDAQ'}" target="_blank" style="color: #4facfe;">查看</a></li>
                        </ul>
                    </div>
                `;
            }
        }

        // 显示新闻
        function displayNews(news) {
            let html = '';
            
            news.slice(0, 10).forEach(item => {
                html += `
                    <div class="news-item" onclick="window.open('${item.url}', '_blank')">
                        <div class="news-title">${item.title}</div>
                        <div class="news-meta">
                            <span>📅 ${item.date}</span>
                            <span>📰 ${item.source}</span>
                        </div>
                        <div class="news-summary">${item.summary}</div>
                    </div>
                `;
            });
            
            document.getElementById('newsList').innerHTML = html || '<div class="info-box"><p>暂无新闻</p></div>';
        }

        // 从新浪财经获取数据
        async function fetchFromSina(symbol) {
            try {
                console.log('📊 新浪财经数据源');
                let sinaCode = symbol.replace('.SS', '').replace('.SZ', '');
                if (symbol.includes('.SS')) {
                    sinaCode = 'sh' + sinaCode;
                } else if (symbol.includes('.SZ')) {
                    sinaCode = 'sz' + sinaCode;
                } else {
                    sinaCode = 'sh' + sinaCode;
                }
                
                // 使用代理访问新浪
                const url = `https://money.finance.sina.com.cn/quotes_service/api/json_v2.php/CN_MarketData.getKLineData?symbol=${sinaCode}&scale=240&ma=5,10,20,60&datalen=1000`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const text = await response.text();
                const jsonData = JSON.parse(text);
                
                if (jsonData && jsonData.length > 0) {
                    const data = jsonData.map(item => ({
                        date: item.day,
                        open: parseFloat(item.open),
                        high: parseFloat(item.high),
                        low: parseFloat(item.low),
                        close: parseFloat(item.close),
                        volume: parseFloat(item.volume)
                    }));
                    
                    console.log(`✅ 新浪财经获取成功，${data.length} 条数据`);
                    displayBasicInfo(symbol);
                    return data;
                }
                throw new Error('新浪财经暂无数据');
            } catch (error) {
                console.error('新浪财经错误:', error);
                throw error;
            }
        }

        // 东方财富数据源
        async function fetchFromEastMoney(symbol, range, interval) {
            try {
                console.log('📊 东方财富数据源');
                // 转换代码格式
                let emCode = symbol.replace('.SS', '').replace('.SZ', '').replace('.HK', '');
                let market = '1'; // 上海
                if (symbol.includes('.SZ')) market = '0'; // 深圳
                if (symbol.includes('.HK')) market = '116'; // 港股
                
                // 东方财富API（通过代理）
                const klineMap = { '1m': '1', '5m': '5', '15m': '15', '30m': '30', '60m': '60', '1d': '101', '1wk': '102', '1mo': '103' };
                const ktype = klineMap[interval] || '101';
                
                const url = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${market}.${emCode}&klt=${ktype}&fqt=1&lmt=500&fields1=f1,f2,f3,f4,f5&fields2=f51,f52,f53,f54,f55,f56,f57`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const json = await response.json();
                
                if (json.data && json.data.klines && json.data.klines.length > 0) {
                    const data = json.data.klines.map(item => {
                        const parts = item.split(',');
                        return {
                            date: parts[0],
                            open: parseFloat(parts[1]),
                            close: parseFloat(parts[2]),
                            high: parseFloat(parts[3]),
                            low: parseFloat(parts[4]),
                            volume: parseFloat(parts[5])
                        };
                    });
                    
                    console.log(`✅ 东方财富获取成功，${data.length} 条数据`);
                    displayBasicInfo(symbol);
                    return data;
                }
                throw new Error('东方财富暂无数据');
            } catch (error) {
                console.error('东方财富错误:', error);
                throw error;
            }
        }

        // 腾讯财经数据源
        async function fetchFromTencent(symbol, range, interval) {
            try {
                console.log('📊 腾讯财经数据源');
                // 转换代码
                let qqCode = symbol.replace('.SS', '').replace('.SZ', '');
                let prefix = 'sh';
                if (symbol.includes('.SZ')) prefix = 'sz';
                
                const url = `https://web.ifzq.gtimg.cn/appstock/app/fqkline/get?param=${prefix}${qqCode},day,,500`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const json = await response.json();
                
                if (json.data && json.data[`${prefix}${qqCode}`] && json.data[`${prefix}${qqCode}`].day) {
                    const klines = json.data[`${prefix}${qqCode}`].day;
                    const data = klines.map(item => ({
                        date: item[0],
                        open: parseFloat(item[1]),
                        close: parseFloat(item[2]),
                        high: parseFloat(item[3]),
                        low: parseFloat(item[4]),
                        volume: parseFloat(item[5])
                    }));
                    
                    console.log(`✅ 腾讯财经获取成功，${data.length} 条数据`);
                    displayBasicInfo(symbol);
                    return data;
                }
                throw new Error('腾讯财经暂无数据');
            } catch (error) {
                console.error('腾讯财经错误:', error);
                throw error;
            }
        }

        // 网易财经数据源
        async function fetchFromNetease(symbol, range, interval) {
            try {
                console.log('📊 网易财经数据源');
                let code = symbol.replace('.SS', '').replace('.SZ', '');
                let prefix = '0';
                if (symbol.includes('.SS')) prefix = '1';
                
                const today = new Date();
                const start = new Date(today.getTime() - getRangeSeconds(range) * 1000);
                const startDate = start.toISOString().split('T')[0].replace(/-/g, '');
                const endDate = today.toISOString().split('T')[0].replace(/-/g, '');
                
                const url = `https://img1.money.126.net/data/hs/kline/day/history/${today.getFullYear()}/${prefix}${code}.json`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                const json = await response.json();
                
                if (json.data && json.data.length > 0) {
                    const data = json.data.map(item => ({
                        date: item[0],
                        open: parseFloat(item[1]),
                        high: parseFloat(item[2]),
                        low: parseFloat(item[3]),
                        close: parseFloat(item[4]),
                        volume: parseFloat(item[5])
                    }));
                    
                    console.log(`✅ 网易财经获取成功，${data.length} 条数据`);
                    displayBasicInfo(symbol);
                    return data;
                }
                throw new Error('网易财经暂无数据');
            } catch (error) {
                console.error('网易财经错误:', error);
                throw error;
            }
        }

        // Alpha Vantage数据源（免费但需要API Key）
        async function fetchFromAlphaVantage(symbol, range, interval) {
            try {
                console.log('📊 Alpha Vantage数据源（演示模式）');
                showError('Alpha Vantage需要API Key。请访问 https://www.alphavantage.co 申请免费API Key，然后在代码中配置。当前使用Yahoo Finance数据源。');
                // 回退到Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('Alpha Vantage错误:', error);
                throw error;
            }
        }

        // Finnhub数据源
        async function fetchFromFinnhub(symbol, range, interval) {
            try {
                console.log('📊 Finnhub数据源（演示模式）');
                showError('Finnhub需要API Key。请访问 https://finnhub.io 申请免费API Key。当前使用Yahoo Finance数据源。');
                // 回退到Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('Finnhub错误:', error);
                throw error;
            }
        }

        // Polygon.io数据源
        async function fetchFromPolygon(symbol, range, interval) {
            try {
                console.log('📊 Polygon.io数据源（演示模式）');
                showError('Polygon.io需要API Key。请访问 https://polygon.io 申请。当前使用Yahoo Finance数据源。');
                // 回退到Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('Polygon.io错误:', error);
                throw error;
            }
        }

        // Twelve Data数据源
        async function fetchFromTwelveData(symbol, range, interval) {
            try {
                console.log('📊 Twelve Data数据源（演示模式）');
                showError('Twelve Data需要API Key。请访问 https://twelvedata.com 申请。当前使用Yahoo Finance数据源。');
                // 回退到Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('Twelve Data错误:', error);
                throw error;
            }
        }

        // IEX Cloud数据源
        async function fetchFromIEXCloud(symbol, range, interval) {
            try {
                console.log('📊 IEX Cloud数据源（演示模式）');
                showError('IEX Cloud需要API Key。请访问 https://iexcloud.io 申请。当前使用Yahoo Finance数据源。');
                // 回退到Yahoo
                return await fetchFromYahoo(symbol, range, interval);
            } catch (error) {
                console.error('IEX Cloud错误:', error);
                throw error;
            }
        }

        function getRangeSeconds(range) {
            const ranges = {
                '1d': 1 * 24 * 3600,
                '5d': 5 * 24 * 3600,
                '1mo': 30 * 24 * 3600,
                '3mo': 90 * 24 * 3600,
                '6mo': 180 * 24 * 3600,
                '1y': 365 * 24 * 3600,
                '2y': 730 * 24 * 3600,
                '5y': 1825 * 24 * 3600
            };
            return ranges[range] || ranges['3mo'];
        }

        // 分析并显示数据
        function analyzeAndDisplay(data) {
            // 计算所有技术指标
            const indicators = calculateAllIndicators(data);
            
            // 显示结果区域
            document.getElementById('results').style.display = 'block';
            
            // 显示统计数据
            displayStats(data, indicators);
            
            // 显示技术信号
            displaySignals(data, indicators);
            
            // 绘制所有图表
            drawAllCharts(data, indicators);
            
            // 形态识别
            displayPatterns(data);
            
            // 滚动到结果
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // 计算所有技术指标（完整版）
        function calculateAllIndicators(data) {
            return {
                // 均线系统
                ma5: calculateMA(data, 5),
                ma10: calculateMA(data, 10),
                ma20: calculateMA(data, 20),
                ma30: calculateMA(data, 30),
                ma60: calculateMA(data, 60),
                ma120: calculateMA(data, 120),
                ema12: calculateEMA(data, 12),
                ema26: calculateEMA(data, 26),
                // 趋势指标
                macd: calculateMACD(data),
                bollinger: calculateBollinger(data, 20, 2),
                sar: calculateSAR(data),
                trix: calculateTRIX(data),
                // 摆动指标
                kdj: calculateKDJ(data),
                rsi: calculateRSI(data, 14),
                rsi6: calculateRSI(data, 6),
                rsi12: calculateRSI(data, 12),
                wr: calculateWR(data, 14),
                cci: calculateCCI(data, 14),
                stoch: calculateStoch(data, 14),
                mom: calculateMOM(data, 10),
                // 趋向指标
                dmi: calculateDMI(data, 14),
                // 成交量能量指标
                obv: calculateOBV(data),
                volumeRatio: calculateVolumeRatio(data),
                vr: calculateVR(data),
                mfi: calculateMFI(data, 14),
                adl: calculateADL(data),
                // 波动率指标
                atr: calculateATR(data, 14),
                // 人气指标
                brar: calculateBRAR(data),
                cr: calculateCR(data),
                // 一目均衡表
                ichimoku: calculateIchimoku(data)
            };
        }

        // 计算MA
        function calculateMA(data, period) {
            const closes = data.map(d => d.close);
            return closes.map((_, i) => {
                if (i < period - 1) return null;
                const slice = closes.slice(i - period + 1, i + 1);
                if (slice.length === 0) return null;
                const sum = slice.reduce((a, b) => a + b, 0);
                return sum / period;
            });
        }

        // 计算EMA
        function calculateEMA(data, period) {
            const closes = data.map(d => d.close);
            const k = 2 / (period + 1);
            const ema = [closes[0]];
            for (let i = 1; i < closes.length; i++) {
                ema.push(closes[i] * k + ema[i - 1] * (1 - k));
            }
            return ema;
        }

        // 计算MACD
        function calculateMACD(data) {
            const closes = data.map(d => d.close);
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            const dif = ema12.map((val, i) => val - ema26[i]);
            
            // 计算DEA (DIF的9日EMA)
            const k = 2 / 10;
            const dea = [dif[0]];
            for (let i = 1; i < dif.length; i++) {
                dea.push(dif[i] * k + dea[i - 1] * (1 - k));
            }
            
            const macd = dif.map((val, i) => (val - dea[i]) * 2);
            return { dif, dea, macd };
        }

        // 计算KDJ
        function calculateKDJ(data, period = 9) {
            const rsv = [];
            const k = [50];
            const d = [50];
            const j = [];

            for (let i = 0; i < data.length; i++) {
                const start = Math.max(0, i - period + 1);
                const slice = data.slice(start, i + 1);
                const high = Math.max(...slice.map(d => d.high));
                const low = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                rsv[i] = high === low ? 50 : ((close - low) / (high - low)) * 100;
                
                if (i > 0) {
                    k[i] = k[i - 1] * 2/3 + rsv[i] * 1/3;
                    d[i] = d[i - 1] * 2/3 + k[i] * 1/3;
                }
                j[i] = 3 * k[i] - 2 * d[i];
            }
            
            return { k, d, j };
        }

        // 计算RSI
        function calculateRSI(data, period = 14) {
            const closes = data.map(d => d.close);
            const rsi = [];
            
            for (let i = 0; i < closes.length; i++) {
                if (i < period) {
                    rsi.push(null);
                    continue;
                }
                
                let gains = 0, losses = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    const change = closes[j] - closes[j - 1];
                    if (change > 0) gains += change;
                    else losses -= change;
                }
                
                const avgGain = gains / period;
                const avgLoss = losses / period;
                const rs = avgGain / (avgLoss || 1);
                rsi.push(100 - (100 / (1 + rs)));
            }
            
            return rsi;
        }

        // 计算布林带
        function calculateBollinger(data, period = 20, stdDev = 2) {
            const closes = data.map(d => d.close);
            const middle = [];
            const upper = [];
            const lower = [];

            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    middle.push(null);
                    upper.push(null);
                    lower.push(null);
                    continue;
                }

                const slice = closes.slice(i - period + 1, i + 1);
                if (slice.length === 0) {
                    middle.push(null);
                    upper.push(null);
                    lower.push(null);
                    continue;
                }
                const mean = slice.reduce((a, b) => a + b, 0) / period;
                const variance = slice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / period;
                const std = Math.sqrt(variance);

                middle.push(mean);
                upper.push(mean + stdDev * std);
                lower.push(mean - stdDev * std);
            }

            return { middle, upper, lower };
        }

        // 计算威廉指标
        function calculateWR(data, period = 14) {
            const wr = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    wr.push(null);
                    continue;
                }
                
                const slice = data.slice(i - period + 1, i + 1);
                const highest = Math.max(...slice.map(d => d.high));
                const lowest = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                wr.push(((highest - close) / (highest - lowest)) * -100);
            }
            return wr;
        }

        // 计算CCI
        function calculateCCI(data, period = 14) {
            const cci = [];
            const tp = data.map(d => (d.high + d.low + d.close) / 3);
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    cci.push(null);
                    continue;
                }
                
                const slice = tp.slice(i - period + 1, i + 1);
                if (slice.length === 0) {
                    cci.push(null);
                    continue;
                }
                const ma = slice.reduce((a, b) => a + b, 0) / period;
                const md = slice.reduce((sum, val) => sum + Math.abs(val - ma), 0) / period;
                
                cci.push((tp[i] - ma) / (0.015 * md));
            }
            return cci;
        }

        // 计算DMI
        function calculateDMI(data, period = 14) {
            const pdi = [];
            const mdi = [];
            const adx = [];
            const dx = [];
            
            if (data.length < period + 1) {
                return { 
                    pdi: data.map(() => null), 
                    mdi: data.map(() => null), 
                    adx: data.map(() => null) 
                };
            }
            
            let trSum = 0, pdmSum = 0, mdmSum = 0;
            
            for (let i = 1; i < data.length; i++) {
                const tr = Math.max(
                    data[i].high - data[i].low,
                    Math.abs(data[i].high - data[i - 1].close),
                    Math.abs(data[i].low - data[i - 1].close)
                );
                
                const pdm = Math.max(data[i].high - data[i - 1].high, 0);
                const mdm = Math.max(data[i - 1].low - data[i].low, 0);
                
                if (i < period) {
                    trSum += tr;
                    pdmSum += pdm;
                    mdmSum += mdm;
                    pdi.push(null);
                    mdi.push(null);
                    adx.push(null);
                    continue;
                }
                
                if (i === period) {
                    trSum += tr;
                    pdmSum += pdm;
                    mdmSum += mdm;
                } else {
                    trSum = trSum - trSum / period + tr;
                    pdmSum = pdmSum - pdmSum / period + pdm;
                    mdmSum = mdmSum - mdmSum / period + mdm;
                }
                
                const pdiVal = (pdmSum / (trSum || 1)) * 100;
                const mdiVal = (mdmSum / (trSum || 1)) * 100;
                const dxVal = Math.abs(pdiVal - mdiVal) / ((pdiVal + mdiVal) || 1) * 100;
                
                pdi.push(pdiVal);
                mdi.push(mdiVal);
                dx.push(dxVal);
                
                if (i >= period * 2 - 1) {
                    const adxSlice = dx.slice(i - period + 1, i + 1).filter(v => v !== null);
                    if (adxSlice.length > 0) {
                        adx.push(adxSlice.reduce((a, b) => a + b, 0) / adxSlice.length);
                    } else {
                        adx.push(null);
                    }
                } else {
                    adx.push(null);
                }
            }
            
            return { pdi, mdi, adx };
        }

        // 计算OBV
        function calculateOBV(data) {
            const obv = [0];
            for (let i = 1; i < data.length; i++) {
                if (data[i].close > data[i - 1].close) {
                    obv.push(obv[i - 1] + data[i].volume);
                } else if (data[i].close < data[i - 1].close) {
                    obv.push(obv[i - 1] - data[i].volume);
                } else {
                    obv.push(obv[i - 1]);
                }
            }
            return obv;
        }

        // 计算量比
        function calculateVolumeRatio(data) {
            const ratio = [];
            for (let i = 0; i < data.length; i++) {
                if (i < 5) {
                    ratio.push(null);
                    continue;
                }
                const avgVolume = data.slice(i - 5, i).reduce((sum, d) => sum + d.volume, 0) / 5;
                ratio.push(data[i].volume / (avgVolume || 1));
            }
            return ratio;
        }

        // 计算SAR (抛物线指标)
        function calculateSAR(data, af = 0.02, maxAf = 0.2) {
            const sar = [];
            if (data.length < 2) return data.map(() => null);
            
            let isUpTrend = data[1].close > data[0].close;
            let currentSar = isUpTrend ? data[0].low : data[0].high;
            let ep = isUpTrend ? data[0].high : data[0].low;
            let currentAf = af;
            
            sar.push(currentSar);
            
            for (let i = 1; i < data.length; i++) {
                const prevSar = currentSar;
                currentSar = prevSar + currentAf * (ep - prevSar);
                
                if (isUpTrend) {
                    currentSar = Math.min(currentSar, data[i - 1].low, i > 1 ? data[i - 2].low : data[i - 1].low);
                    if (data[i].low < currentSar) {
                        isUpTrend = false;
                        currentSar = ep;
                        ep = data[i].low;
                        currentAf = af;
                    } else {
                        if (data[i].high > ep) {
                            ep = data[i].high;
                            currentAf = Math.min(currentAf + af, maxAf);
                        }
                    }
                } else {
                    currentSar = Math.max(currentSar, data[i - 1].high, i > 1 ? data[i - 2].high : data[i - 1].high);
                    if (data[i].high > currentSar) {
                        isUpTrend = true;
                        currentSar = ep;
                        ep = data[i].high;
                        currentAf = af;
                    } else {
                        if (data[i].low < ep) {
                            ep = data[i].low;
                            currentAf = Math.min(currentAf + af, maxAf);
                        }
                    }
                }
                
                sar.push(currentSar);
            }
            
            return sar;
        }

        // 计算TRIX (三重指数平滑移动平均)
        function calculateTRIX(data, period = 12) {
            const closes = data.map(d => d.close);
            const ema1 = calculateEMAFromArray(closes, period);
            const ema2 = calculateEMAFromArray(ema1, period);
            const ema3 = calculateEMAFromArray(ema2, period);
            
            const trix = ema3.map((val, i) => {
                if (i === 0 || !ema3[i - 1] || ema3[i - 1] === 0) return null;
                return ((val - ema3[i - 1]) / ema3[i - 1]) * 100;
            });
            
            return trix;
        }

        // 辅助函数：从数组计算EMA
        function calculateEMAFromArray(arr, period) {
            const k = 2 / (period + 1);
            const ema = [];
            let prevEma = null;
            
            for (let i = 0; i < arr.length; i++) {
                if (arr[i] === null || arr[i] === undefined) {
                    ema.push(null);
                } else if (prevEma === null) {
                    ema.push(arr[i]);
                    prevEma = arr[i];
                } else {
                    const val = arr[i] * k + prevEma * (1 - k);
                    ema.push(val);
                    prevEma = val;
                }
            }
            return ema;
        }

        // 计算Stoch (随机指标)
        function calculateStoch(data, period = 14) {
            const k = [];
            const d = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    k.push(null);
                    d.push(null);
                    continue;
                }
                
                const slice = data.slice(i - period + 1, i + 1);
                const high = Math.max(...slice.map(d => d.high));
                const low = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                const kVal = high === low ? 50 : ((close - low) / (high - low)) * 100;
                k.push(kVal);
                
                // D是K的3日SMA
                if (i >= period + 1) {
                    const kSlice = k.slice(i - 2, i + 1).filter(v => v !== null);
                    const dVal = kSlice.reduce((a, b) => a + b, 0) / kSlice.length;
                    d.push(dVal);
                } else {
                    d.push(null);
                }
            }
            
            return { k, d };
        }

        // 计算VR (成交量比率)
        function calculateVR(data, period = 26) {
            const vr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    vr.push(null);
                    continue;
                }
                
                let upVolume = 0;
                let downVolume = 0;
                let flatVolume = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    if (data[j].close > data[j - 1].close) {
                        upVolume += data[j].volume;
                    } else if (data[j].close < data[j - 1].close) {
                        downVolume += data[j].volume;
                    } else {
                        flatVolume += data[j].volume;
                    }
                }
                
                vr.push((upVolume + flatVolume / 2) / (downVolume + flatVolume / 2 || 1) * 100);
            }
            
            return vr;
        }

        // 计算ATR (平均真实波幅)
        function calculateATR(data, period = 14) {
            const tr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    tr.push(data[i].high - data[i].low);
                } else {
                    const high = data[i].high;
                    const low = data[i].low;
                    const prevClose = data[i - 1].close;
                    
                    tr.push(Math.max(
                        high - low,
                        Math.abs(high - prevClose),
                        Math.abs(low - prevClose)
                    ));
                }
            }
            
            const atr = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    atr.push(null);
                } else if (i === period - 1) {
                    const slice = tr.slice(0, period);
                    atr.push(slice.reduce((a, b) => a + b, 0) / period);
                } else {
                    atr.push((atr[i - 1] * (period - 1) + tr[i]) / period);
                }
            }
            
            return atr;
        }

        // 计算BRAR (人气意愿指标)
        function calculateBRAR(data, period = 26) {
            const br = [];
            const ar = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    br.push(null);
                    ar.push(null);
                    continue;
                }
                
                let sumHC = 0;  // 最高-昨收
                let sumCL = 0;  // 昨收-最低
                let sumHO = 0;  // 最高-今开
                let sumOL = 0;  // 今开-最低
                
                for (let j = i - period + 1; j <= i; j++) {
                    sumHC += data[j].high - data[j - 1].close;
                    sumCL += data[j - 1].close - data[j].low;
                    sumHO += data[j].high - data[j].open;
                    sumOL += data[j].open - data[j].low;
                }
                
                br.push(sumHC / (sumCL || 1) * 100);
                ar.push((sumHO + sumOL) / (sumHC + sumCL || 1) * 100);
            }
            
            return { br, ar };
        }

        // 计算CR (能量指标)
        function calculateCR(data, period = 26) {
            const cr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    cr.push(null);
                    continue;
                }
                
                let sumP = 0;
                let sumM = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    const mid = (data[j - 1].high + data[j - 1].low + data[j - 1].close) / 3;
                    sumP += Math.max(0, data[j].high - mid);
                    sumM += Math.max(0, mid - data[j].low);
                }
                
                cr.push(sumP / (sumM || 1) * 100);
            }
            
            return cr;
        }

        // 计算MOM (动量指标)
        function calculateMOM(data, period = 10) {
            const closes = data.map(d => d.close);
            return closes.map((close, i) => {
                if (i < period) return null;
                return close - closes[i - period];
            });
        }

        // 计算MFI (资金流量指标 - Money Flow Index)
        function calculateMFI(data, period = 14) {
            const mfi = [];
            const typicalPrice = data.map(d => (d.high + d.low + d.close) / 3);
            const rawMoneyFlow = data.map((d, i) => typicalPrice[i] * d.volume);
            
            for (let i = 0; i < data.length; i++) {
                if (i < period) {
                    mfi.push(null);
                    continue;
                }
                
                let positiveFlow = 0;
                let negativeFlow = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    if (j === 0) continue;
                    if (typicalPrice[j] > typicalPrice[j - 1]) {
                        positiveFlow += rawMoneyFlow[j];
                    } else if (typicalPrice[j] < typicalPrice[j - 1]) {
                        negativeFlow += rawMoneyFlow[j];
                    }
                }
                
                if (negativeFlow === 0) {
                    mfi.push(100);
                } else {
                    const moneyRatio = positiveFlow / negativeFlow;
                    mfi.push(100 - (100 / (1 + moneyRatio)));
                }
            }
            
            return mfi;
        }

        // 计算A/D Line (集散线 - Accumulation/Distribution Line)
        function calculateADL(data) {
            const adl = [0];
            
            for (let i = 1; i < data.length; i++) {
                const high = data[i].high;
                const low = data[i].low;
                const close = data[i].close;
                const volume = data[i].volume;
                
                let clv = 0;
                if (high !== low) {
                    clv = ((close - low) - (high - close)) / (high - low);
                }
                
                adl.push(adl[i - 1] + clv * volume);
            }
            
            return adl;
        }

        // 计算Ichimoku (一目均衡表)
        function calculateIchimoku(data) {
            const tenkan = [];  // 转换线 (9日)
            const kijun = [];   // 基准线 (26日)
            const senkouA = []; // 先行带A
            const senkouB = []; // 先行带B (52日)
            const chikou = [];  // 延迟线
            
            for (let i = 0; i < data.length; i++) {
                // 转换线 (9日高低点中值)
                if (i < 8) {
                    tenkan.push(null);
                } else {
                    const slice = data.slice(i - 8, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    tenkan.push((high + low) / 2);
                }
                
                // 基准线 (26日高低点中值)
                if (i < 25) {
                    kijun.push(null);
                } else {
                    const slice = data.slice(i - 25, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    kijun.push((high + low) / 2);
                }
                
                // 先行带A ((转换线+基准线)/2，向前移26日)
                if (tenkan[i] !== null && kijun[i] !== null) {
                    senkouA.push((tenkan[i] + kijun[i]) / 2);
                } else {
                    senkouA.push(null);
                }
                
                // 先行带B (52日高低点中值，向前移26日)
                if (i < 51) {
                    senkouB.push(null);
                } else {
                    const slice = data.slice(i - 51, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    senkouB.push((high + low) / 2);
                }
                
                // 延迟线 (当日收盘价，向后移26日)
                chikou.push(data[i].close);
            }
            
            return { tenkan, kijun, senkouA, senkouB, chikou };
        }

        // 显示统计数据
        function displayStats(data, indicators) {
            const latest = data[data.length - 1];
            const previous = data[data.length - 2];
            const changePercent = ((latest.close - previous.close) / previous.close * 100);
            const amplitude = ((latest.high - latest.low) / previous.close * 100);
            const turnover = (latest.volume / 1000000).toFixed(2);

            const html = `
                <div class="stat-card ${changePercent > 0 ? 'bullish' : 'bearish'}">
                    <div class="stat-label">最新价</div>
                    <div class="stat-value">¥${latest.close.toFixed(2)}</div>
                    <div class="stat-change">${changePercent > 0 ? '↑' : '↓'} ${Math.abs(changePercent).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今开</div>
                    <div class="stat-value">¥${latest.open.toFixed(2)}</div>
                    <div class="stat-change">最高 ¥${latest.high.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">最低</div>
                    <div class="stat-value">¥${latest.low.toFixed(2)}</div>
                    <div class="stat-change">振幅 ${amplitude.toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">成交量</div>
                    <div class="stat-value">${turnover}M</div>
                    <div class="stat-change">量比 ${indicators.volumeRatio[indicators.volumeRatio.length - 1]?.toFixed(2) || '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">MA5</div>
                    <div class="stat-value">¥${indicators.ma5[indicators.ma5.length - 1]?.toFixed(2) || '-'}</div>
                    <div class="stat-change">5日均线</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">MA20</div>
                    <div class="stat-value">¥${indicators.ma20[indicators.ma20.length - 1]?.toFixed(2) || '-'}</div>
                    <div class="stat-change">20日均线</div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = html;
        }

        // 显示技术信号
        function displaySignals(data, indicators) {
            const signals = [];
            const latest = data[data.length - 1];
            const currentRSI = indicators.rsi[indicators.rsi.length - 1];
            const currentMACD = indicators.macd.macd[indicators.macd.macd.length - 1];
            const currentK = indicators.kdj.k[indicators.kdj.k.length - 1];
            const currentD = indicators.kdj.d[indicators.kdj.d.length - 1];
            const ma5 = indicators.ma5[indicators.ma5.length - 1];
            const ma20 = indicators.ma20[indicators.ma20.length - 1];
            const ma60 = indicators.ma60[indicators.ma60.length - 1];

            // 趋势信号
            let trendText = '';
            if (ma5 > ma20 && ma20 > ma60) {
                signals.push({ text: '多头排列', type: 'buy' });
                trendText = '<span class="bullish-text">强势上涨</span>';
            } else if (ma5 < ma20 && ma20 < ma60) {
                signals.push({ text: '空头排列', type: 'sell' });
                trendText = '<span class="bearish-text">弱势下跌</span>';
            } else {
                signals.push({ text: '震荡整理', type: 'neutral' });
                trendText = '<span class="neutral-text">横盘震荡</span>';
            }

            // RSI信号
            let rsiText = '';
            if (currentRSI < 30) {
                signals.push({ text: 'RSI超卖', type: 'buy' });
                rsiText = `<span class="bullish-text">${currentRSI.toFixed(2)} (超卖)</span>`;
            } else if (currentRSI > 70) {
                signals.push({ text: 'RSI超买', type: 'sell' });
                rsiText = `<span class="bearish-text">${currentRSI.toFixed(2)} (超买)</span>`;
            } else {
                rsiText = `<span class="neutral-text">${currentRSI.toFixed(2)}</span>`;
            }

            // MACD信号
            let macdText = '';
            const prevMACD = indicators.macd.macd[indicators.macd.macd.length - 2];
            if (currentMACD > 0 && prevMACD < 0) {
                signals.push({ text: 'MACD金叉', type: 'buy' });
                macdText = '<span class="bullish-text">金叉</span>';
            } else if (currentMACD < 0 && prevMACD > 0) {
                signals.push({ text: 'MACD死叉', type: 'sell' });
                macdText = '<span class="bearish-text">死叉</span>';
            } else if (currentMACD > 0) {
                macdText = '<span class="bullish-text">多头</span>';
            } else {
                macdText = '<span class="bearish-text">空头</span>';
            }

            // KDJ信号
            let kdjText = '';
            if (currentK < 20 && currentK > currentD) {
                signals.push({ text: 'KDJ低位金叉', type: 'buy' });
                kdjText = '<span class="bullish-text">低位金叉</span>';
            } else if (currentK > 80 && currentK < currentD) {
                signals.push({ text: 'KDJ高位死叉', type: 'sell' });
                kdjText = '<span class="bearish-text">高位死叉</span>';
            } else if (currentK > 80) {
                kdjText = '<span class="bearish-text">超买</span>';
            } else if (currentK < 20) {
                kdjText = '<span class="bullish-text">超卖</span>';
            } else {
                kdjText = '<span class="neutral-text">中性</span>';
            }

            // 布林带信号
            const upperBB = indicators.bollinger.upper[indicators.bollinger.upper.length - 1];
            const lowerBB = indicators.bollinger.lower[indicators.bollinger.lower.length - 1];
            const middleBB = indicators.bollinger.middle[indicators.bollinger.middle.length - 1];
            
            let bollingerText = '';
            if (latest.close > upperBB) {
                signals.push({ text: '突破上轨', type: 'sell' });
                bollingerText = '<span class="bearish-text">上轨上方</span>';
            } else if (latest.close < lowerBB) {
                signals.push({ text: '触及下轨', type: 'buy' });
                bollingerText = '<span class="bullish-text">下轨下方</span>';
            } else if (latest.close > middleBB) {
                bollingerText = '<span class="neutral-text">中轨上方</span>';
            } else {
                bollingerText = '<span class="neutral-text">中轨下方</span>';
            }

            // 显示信号
            const signalsHTML = signals.map(s => 
                `<div class="signal ${s.type}">${s.text}</div>`
            ).join('');
            document.getElementById('signals').innerHTML = signalsHTML;

            // 显示指标面板
            const panelHTML = `
                <div class="indicator-row">
                    <span class="indicator-name">趋势方向</span>
                    <span class="indicator-value">${trendText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">RSI(14)</span>
                    <span class="indicator-value">${rsiText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">MACD</span>
                    <span class="indicator-value">${macdText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">KDJ</span>
                    <span class="indicator-value">${kdjText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">布林带</span>
                    <span class="indicator-value">${bollingerText}</span>
                </div>
            `;
            document.getElementById('indicatorPanel').innerHTML = panelHTML;
        }

        // 绘制所有图表
        function drawAllCharts(data, indicators) {
            // K线和趋势
            drawCandlestickChart(data, indicators);
            drawBollingerChartLW(data, indicators);
            
            // 趋势指标
            drawMACDChart(data, indicators);
            drawSARChart(data, indicators);
            drawTRIXChart(data, indicators);
            
            // 摆动指标
            drawKDJChart(data, indicators);
            drawRSIChart(data, indicators);
            drawWRChart(data, indicators);
            drawCCIChart(data, indicators);
            drawStochChart(data, indicators);
            drawMOMChart(data, indicators);
            drawMFIChart(data, indicators);
            
            // 趋向指标
            drawDMIChart(data, indicators);
            drawIchimokuChart(data, indicators);
            
            // 成交量指标
            drawVolumeChart(data);
            drawOBVChart(data, indicators);
            drawVolumeRatioChart(data, indicators);
            drawVRChart(data, indicators);
            drawBRARChart(data, indicators);
            drawCRChart(data, indicators);
            drawADLChart(data, indicators);
            
            // 波动率指标
            drawATRChart(data, indicators);
            
            // 形态分析
            drawSupportResistanceChart(data);
        }

        // K线图（真正的蜡烛图 - 使用Canvas绘制）
        function drawCandlestickChart(data, indicators) {
            const container = document.getElementById('candlestickChart');
            container.innerHTML = '<canvas id="candleCanvas"></canvas>';
            
            const canvas = document.getElementById('candleCanvas');
            const ctx = canvas.getContext('2d');
            
            // 设置canvas尺寸（使用高分辨率）
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            
            const width = rect.width;
            const height = rect.height;
            
            // 计算绘图区域（优化padding，扩大K线区域）
            const padding = { top: 60, right: 80, bottom: 80, left: 70 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // 计算价格范围
            const allPrices = data.flatMap(d => [d.high, d.low]);
            const maxPrice = Math.max(...allPrices);
            const minPrice = Math.min(...allPrices);
            const priceRange = maxPrice - minPrice;
            
            // 辅助函数：价格转Y坐标
            const priceToY = (price) => {
                return padding.top + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
            };
            
            // 辅助函数：索引转X坐标
            const indexToX = (index) => {
                const candleWidth = chartWidth / data.length;
                return padding.left + index * candleWidth + candleWidth / 2;
            };
            
            // 清空画布
            ctx.fillStyle = '#0f1429';
            ctx.fillRect(0, 0, width, height);
            
            // 绘制网格
            ctx.strokeStyle = '#2d3561';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartWidth, y);
                ctx.stroke();
                
                // 价格标签
                const price = maxPrice - (priceRange / 5) * i;
                ctx.fillStyle = '#aaa';
                ctx.font = '14px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(price.toFixed(2), padding.left - 10, y + 5);
            }
            
            // 绘制K线（蜡烛更粗）
            const candleWidth = Math.max(4, Math.min(12, chartWidth / data.length - 3));
            data.forEach((d, i) => {
                const x = indexToX(i);
                const openY = priceToY(d.open);
                const closeY = priceToY(d.close);
                const highY = priceToY(d.high);
                const lowY = priceToY(d.low);
                
                const isUp = d.close >= d.open;
                const color = isUp ? '#22c55e' : '#ef4444';
                
                // 绘制影线（上下影线，加粗）
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // 绘制实体（K线主体）
                ctx.fillStyle = color;
                const bodyHeight = Math.abs(closeY - openY);
                const bodyY = Math.min(openY, closeY);
                
                // 如果实体太小，至少显示2px
                if (bodyHeight < 2) {
                    ctx.fillRect(x - candleWidth / 2, bodyY - 1, candleWidth, 2);
                } else {
                    ctx.fillRect(x - candleWidth / 2, bodyY, candleWidth, bodyHeight);
                }
            });
            
            // 绘制均线（加粗）
            const maLines = [
                { data: indicators.ma5, color: '#22c55e', label: 'MA5', width: 2.5 },
                { data: indicators.ma10, color: '#f59e0b', label: 'MA10', width: 2.5 },
                { data: indicators.ma20, color: '#a855f7', label: 'MA20', width: 2.5 },
                { data: indicators.ma60, color: '#ec4899', label: 'MA60', width: 2.5 }
            ];
            
            maLines.forEach(ma => {
                ctx.strokeStyle = ma.color;
                ctx.lineWidth = ma.width;
                ctx.beginPath();
                let started = false;
                data.forEach((d, i) => {
                    if (ma.data[i] !== null) {
                        const x = indexToX(i);
                        const y = priceToY(ma.data[i]);
                        if (!started) {
                            ctx.moveTo(x, y);
                            started = true;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                });
                ctx.stroke();
            });
            
            // 绘制图例（更大更清晰）
            let legendX = padding.left;
            const legendY = 30;
            maLines.forEach(ma => {
                ctx.fillStyle = ma.color;
                ctx.fillRect(legendX, legendY - 6, 20, 4);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(ma.label, legendX + 25, legendY);
                legendX += 100;
            });
            
            // 绘制日期（更清晰）
            ctx.fillStyle = '#aaa';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            const dateStep = Math.ceil(data.length / 10);
            for (let i = 0; i < data.length; i += dateStep) {
                const x = indexToX(i);
                const date = data[i].date.substring(5); // 只显示月-日
                ctx.fillText(date, x, height - 25);
            }
            
            // 绘制标题（更大）
            ctx.fillStyle = '#4facfe';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('K线图与均线系统 (红涨绿跌)', padding.left, 20);
            
            // 保存到charts对象
            charts.candlestick = { canvas, redraw: () => drawCandlestickChart(data, indicators) };
            
            // 响应式（防抖）
            let resizeTimeout;
            const resizeHandler = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (charts.candlestick && charts.candlestick.redraw) {
                        charts.candlestick.redraw();
                    }
                }, 250);
            };
            
            window.removeEventListener('resize', resizeHandler);
            window.addEventListener('resize', resizeHandler);
        }

        // 布林带图表（使用Chart.js）
        function drawBollingerChartLW(data, indicators) {
            const container = document.getElementById('bollingerChart');
            container.innerHTML = '<canvas id="bollingerCanvas"></canvas>';
            
            const ctx = document.getElementById('bollingerCanvas').getContext('2d');
            if (charts.bollinger) charts.bollinger.destroy();

            const dates = data.map(d => d.date);

            charts.bollinger = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '上轨',
                            data: indicators.bollinger.upper,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '中轨',
                            data: indicators.bollinger.middle,
                            borderColor: '#facc15',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '下轨',
                            data: indicators.bollinger.lower,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '收盘价',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // 其他图表函数（使用Chart.js）
        function drawMACDChart(data, indicators) {
            const ctx = document.getElementById('macdChart').getContext('2d');
            if (charts.macd) charts.macd.destroy();

            const dates = data.map(d => d.date);
            const colors = indicators.macd.macd.map(val => val >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)');

            charts.macd = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'MACD',
                            data: indicators.macd.macd,
                            backgroundColor: colors,
                            borderWidth: 0
                        },
                        {
                            label: 'DIF',
                            data: indicators.macd.dif,
                            type: 'line',
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'DEA',
                            data: indicators.macd.dea,
                            type: 'line',
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        function drawKDJChart(data, indicators) {
            const ctx = document.getElementById('kdjChart').getContext('2d');
            if (charts.kdj) charts.kdj.destroy();

            charts.kdj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'K',
                            data: indicators.kdj.k,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'D',
                            data: indicators.kdj.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'J',
                            data: indicators.kdj.j,
                            borderColor: '#a855f7',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        function drawRSIChart(data, indicators) {
            const ctx = document.getElementById('rsiChart').getContext('2d');
            if (charts.rsi) charts.rsi.destroy();

            charts.rsi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'RSI(6)',
                            data: indicators.rsi6,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'RSI(12)',
                            data: indicators.rsi12,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'RSI(14)',
                            data: indicators.rsi,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        function drawWRChart(data, indicators) {
            const ctx = document.getElementById('wrChart').getContext('2d');
            if (charts.wr) charts.wr.destroy();

            charts.wr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'WR(14)',
                        data: indicators.wr,
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: -100, max: 0 } } }
            });
        }

        function drawCCIChart(data, indicators) {
            const ctx = document.getElementById('cciChart').getContext('2d');
            if (charts.cci) charts.cci.destroy();

            charts.cci = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'CCI(14)',
                        data: indicators.cci,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawDMIChart(data, indicators) {
            const ctx = document.getElementById('dmiChart').getContext('2d');
            if (charts.dmi) charts.dmi.destroy();

            charts.dmi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'PDI',
                            data: indicators.dmi.pdi,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'MDI',
                            data: indicators.dmi.mdi,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'ADX',
                            data: indicators.dmi.adx,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        function drawVolumeChart(data) {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            if (charts.volume) charts.volume.destroy();

            const colors = data.map((d, i) => {
                if (i === 0) return '#4facfe';
                return d.close >= d.open ? '#22c55e' : '#ef4444';
            });

            charts.volume = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: '成交量',
                        data: data.map(d => d.volume),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawOBVChart(data, indicators) {
            const ctx = document.getElementById('obvChart').getContext('2d');
            if (charts.obv) charts.obv.destroy();

            charts.obv = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'OBV',
                        data: indicators.obv,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawVolumeRatioChart(data, indicators) {
            const ctx = document.getElementById('volumeRatioChart').getContext('2d');
            if (charts.volumeRatio) charts.volumeRatio.destroy();

            const colors = indicators.volumeRatio.map(r => {
                if (!r) return '#4facfe';
                return r > 1 ? '#22c55e' : '#ef4444';
            });

            charts.volumeRatio = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: '量比',
                        data: indicators.volumeRatio,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawSupportResistanceChart(data) {
            const container = document.getElementById('supportResistanceChart');
            container.innerHTML = '<canvas id="supportResistanceCanvas"></canvas>';
            
            const ctx = document.getElementById('supportResistanceCanvas').getContext('2d');
            if (charts.supportResistance) charts.supportResistance.destroy();

            // 计算支撑压力位
            const highs = data.map(d => d.high);
            const lows = data.map(d => d.low);
            const resistance = Math.max(...highs.slice(-20));
            const support = Math.min(...lows.slice(-20));
            
            const dates = data.map(d => d.date);

            charts.supportResistance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '收盘价',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            pointRadius: 0
                        },
                        {
                            label: '压力位',
                            data: data.map(() => resistance),
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '支撑位',
                            data: data.map(() => support),
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // 形态识别
        function displayPatterns(data) {
            const patterns = [];
            const len = data.length;
            
            // 检测最近的K线形态
            if (len >= 3) {
                const d1 = data[len - 3];
                const d2 = data[len - 2];
                const d3 = data[len - 1];
                
                // 早晨之星
                if (d1.close < d1.open && 
                    Math.abs(d2.close - d2.open) < (d1.open - d1.close) * 0.3 &&
                    d3.close > d3.open &&
                    d3.close > (d1.open + d1.close) / 2) {
                    patterns.push({ name: '早晨之星', type: 'buy', desc: '底部反转信号，预示上涨' });
                }
                
                // 黄昏之星
                if (d1.close > d1.open && 
                    Math.abs(d2.close - d2.open) < (d1.close - d1.open) * 0.3 &&
                    d3.close < d3.open &&
                    d3.close < (d1.open + d1.close) / 2) {
                    patterns.push({ name: '黄昏之星', type: 'sell', desc: '顶部反转信号，预示下跌' });
                }
            }
            
            // 锤子线
            if (len >= 1) {
                const d = data[len - 1];
                const body = Math.abs(d.close - d.open);
                const lowerShadow = Math.min(d.open, d.close) - d.low;
                const upperShadow = d.high - Math.max(d.open, d.close);
                
                if (lowerShadow > body * 2 && upperShadow < body * 0.3) {
                    patterns.push({ name: '锤子线', type: 'buy', desc: '底部反转信号' });
                }
                
                if (upperShadow > body * 2 && lowerShadow < body * 0.3) {
                    patterns.push({ name: '倒锤子线', type: 'sell', desc: '顶部反转信号' });
                }
            }
            
            let html = '';
            if (patterns.length > 0) {
                html = patterns.map(p => `
                    <div class="signal ${p.type}" style="display: block; margin-bottom: 10px; padding: 15px;">
                        <strong>${p.name}</strong><br>
                        <span style="font-size: 13px; opacity: 0.9;">${p.desc}</span>
                    </div>
                `).join('');
            } else {
                html = '<div class="info-box"><p>暂未识别到明显的K线形态</p></div>';
            }
            
            document.getElementById('patternResults').innerHTML = html;
            
            // 趋势分析
            const ma20 = calculateMA(data, 20);
            const trend = ma20[ma20.length - 1] > ma20[ma20.length - 20] ? '上升' : '下降';
            document.getElementById('trendAnalysis').innerHTML = `
                <div class="info-box">
                    <h3>趋势方向</h3>
                    <p>当前20日均线呈<strong>${trend}趋势</strong></p>
                    <p>MA20: ${ma20[ma20.length - 1]?.toFixed(2)}</p>
                </div>
            `;
        }

        // 绘制SAR图表
        function drawSARChart(data, indicators) {
            const ctx = document.getElementById('sarChart').getContext('2d');
            if (charts.sar) charts.sar.destroy();

            charts.sar = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: '收盘价',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'SAR',
                            data: indicators.sar,
                            borderColor: '#f59e0b',
                            borderWidth: 0,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b',
                            showLine: false
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // 绘制TRIX图表
        function drawTRIXChart(data, indicators) {
            const ctx = document.getElementById('trixChart').getContext('2d');
            if (charts.trix) charts.trix.destroy();

            charts.trix = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'TRIX',
                        data: indicators.trix,
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // 绘制Stoch图表
        function drawStochChart(data, indicators) {
            const ctx = document.getElementById('stochChart').getContext('2d');
            if (charts.stoch) charts.stoch.destroy();

            charts.stoch = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: '%K',
                            data: indicators.stoch.k,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '%D',
                            data: indicators.stoch.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        // 绘制ATR图表
        function drawATRChart(data, indicators) {
            const ctx = document.getElementById('atrChart').getContext('2d');
            if (charts.atr) charts.atr.destroy();

            charts.atr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'ATR(14)',
                        data: indicators.atr,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // 绘制VR图表
        function drawVRChart(data, indicators) {
            const ctx = document.getElementById('vrChart').getContext('2d');
            if (charts.vr) charts.vr.destroy();

            charts.vr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'VR',
                        data: indicators.vr,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // 绘制BRAR图表
        function drawBRARChart(data, indicators) {
            const ctx = document.getElementById('brarChart').getContext('2d');
            if (charts.brar) charts.brar.destroy();

            charts.brar = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'BR',
                            data: indicators.brar.br,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'AR',
                            data: indicators.brar.ar,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // 绘制CR图表
        function drawCRChart(data, indicators) {
            const ctx = document.getElementById('crChart').getContext('2d');
            if (charts.cr) charts.cr.destroy();

            charts.cr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'CR',
                        data: indicators.cr,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // 绘制MOM图表
        function drawMOMChart(data, indicators) {
            const ctx = document.getElementById('momChart').getContext('2d');
            if (charts.mom) charts.mom.destroy();

            charts.mom = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'MOM(10)',
                        data: indicators.mom,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // 绘制MFI图表
        function drawMFIChart(data, indicators) {
            const ctx = document.getElementById('mfiChart').getContext('2d');
            if (charts.mfi) charts.mfi.destroy();

            charts.mfi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'MFI(14)',
                        data: indicators.mfi,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        // 绘制ADL图表
        function drawADLChart(data, indicators) {
            const ctx = document.getElementById('adlChart').getContext('2d');
            if (charts.adl) charts.adl.destroy();

            charts.adl = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'A/D Line',
                        data: indicators.adl,
                        borderColor: '#14b8a6',
                        backgroundColor: 'rgba(20, 184, 166, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // 绘制Ichimoku图表
        function drawIchimokuChart(data, indicators) {
            const ctx = document.getElementById('ichimokuChart').getContext('2d');
            if (charts.ichimoku) charts.ichimoku.destroy();

            charts.ichimoku = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: '收盘价',
                            data: data.map(d => d.close),
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '转换线',
                            data: indicators.ichimoku.tenkan,
                            borderColor: '#ef4444',
                            borderWidth: 1.5,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '基准线',
                            data: indicators.ichimoku.kijun,
                            borderColor: '#3b82f6',
                            borderWidth: 1.5,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '先行带A',
                            data: indicators.ichimoku.senkouA,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        {
                            label: '先行带B',
                            data: indicators.ichimoku.senkouB,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 1,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // 通用图表配置
        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: '#aaa', font: { size: 11 } }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#2d3561' },
                        ticks: { color: '#aaa', maxTicksLimit: 12, font: { size: 10 } }
                    },
                    y: {
                        grid: { color: '#2d3561' },
                        ticks: { color: '#aaa', font: { size: 10 } }
                    }
                }
            };
        }
    </script>
</body>
</html>
