<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“ä¸šé‡åŒ–è‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: #0a0e27;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .search-section {
            background: #1a1f3a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .search-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 300px;
            background: #0f1429;
            border: 2px solid #2d3561;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
        }
        .search-input:focus {
            outline: none;
            border-color: #4facfe;
        }
        select {
            background: #0f1429;
            border: 2px solid #2d3561;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        select:focus {
            outline: none;
            border-color: #4facfe;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #4facfe;
        }
        .loading.active {
            display: block;
        }
        .spinner {
            border: 4px solid #2d3561;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #2d3561;
        }
        .stat-card.bullish {
            background: linear-gradient(135deg, #134e48 0%, #267871 100%);
        }
        .stat-card.bearish {
            background: linear-gradient(135deg, #7b1e3d 0%, #a32952 100%);
        }
        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-change {
            font-size: 13px;
            opacity: 0.9;
        }
        .card {
            background: #1a1f3a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2d3561;
            margin-bottom: 25px;
            position: relative;
        }
        .card h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #4facfe;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-container {
            background: #0f1429;
            border-radius: 8px;
            padding: 20px;
            height: 750px;
            min-height: 600px;
        }
        .chart-container.small {
            height: 650px;
        }
        .chart-container.large {
            height: 850px;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .chart-action-bar {
            position: absolute;
            top: 10px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 3;
        }
        .chart-action-btn {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #ddd;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .chart-action-btn:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        .chart-container.enlarged {
            height: 900px !important;
        }
        
        /* ä¸­ç­‰å±å¹• - æ˜¾ç¤º1åˆ— */
        @media (min-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* å¤§å±å¹• - å¯ä»¥æ˜¾ç¤º2åˆ— */
        @media (min-width: 1600px) {
            .chart-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .signals {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .signal {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid;
        }
        .signal.buy {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }
        .signal.sell {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        .signal.neutral {
            background: rgba(250, 204, 21, 0.2);
            border-color: #facc15;
            color: #facc15;
        }
        .indicator-panel {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .indicator-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #2d3561;
        }
        .indicator-row:last-child {
            border-bottom: none;
        }
        .indicator-name {
            color: #aaa;
            font-size: 14px;
        }
        .indicator-value {
            font-size: 15px;
            font-weight: bold;
        }
        .bullish-text {
            color: #22c55e;
        }
        .bearish-text {
            color: #ef4444;
        }
        .neutral-text {
            color: #facc15;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            background: #1a1f3a;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #2d3561;
            transition: all 0.3s;
            font-size: 14px;
        }
        .tab:hover {
            background: #2d3561;
            border-color: #4facfe;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        .info-box {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            margin-bottom: 15px;
        }
        .info-box h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #4facfe;
        }
        .info-box p {
            font-size: 14px;
            color: #aaa;
            line-height: 1.6;
        }
        .company-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .company-info-item {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
        }
        .company-info-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .company-info-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .error.active {
            display: block;
        }
        .category-btn {
            flex: 1;
            background: #1a1f3a;
            border: 2px solid #2d3561;
            color: #aaa;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .category-btn:hover {
            border-color: #4facfe;
            background: #2d3561;
        }
        .category-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }
        .category-content {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .stock-item {
            background: #0f1429;
            border: 2px solid #2d3561;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .stock-item:hover {
            border-color: #4facfe;
            background: #1a1f3a;
            transform: translateY(-2px);
        }
        .stock-item.selected {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        .stock-name {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        .stock-code {
            font-size: 12px;
            color: #888;
        }
        .fundamentals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .fundamental-item {
            background: #0f1429;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #4facfe;
        }
        .fundamental-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .fundamental-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        .download-section {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2d3561;
            margin-bottom: 20px;
        }
        .download-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(34, 197, 94, 0.5);
        }
        .color-scheme-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            padding: 15px;
            background: #0f1429;
            border-radius: 8px;
        }
        .color-option {
            padding: 10px 20px;
            border: 2px solid #2d3561;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .color-option:hover {
            border-color: #4facfe;
        }
        .color-option.active {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        
        /* å“åº”å¼è®¾è®¡ - å¹³æ¿ */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
            }
            .header h1 {
                font-size: 28px;
            }
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .chart-container {
                height: 500px;
            }
            .chart-container.small {
                height: 400px;
            }
            .chart-container.large {
                height: 600px;
            }
        }
        
        /* å“åº”å¼è®¾è®¡ - æ‰‹æœº */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header h1 {
                font-size: 24px;
            }
            .header p {
                font-size: 12px;
            }
            .search-bar {
                flex-direction: column;
            }
            .search-input {
                min-width: 100%;
            }
            button {
                width: 100%;
                padding: 12px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .stat-card {
                padding: 15px;
            }
            .stat-value {
                font-size: 20px;
            }
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 400px;
                padding: 10px;
            }
            .chart-container.small {
                height: 350px;
            }
            .chart-container.large {
                height: 500px;
            }
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            .tab {
                white-space: nowrap;
                font-size: 12px;
                padding: 10px 16px;
            }
            .stock-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }
            .stock-item {
                padding: 10px;
            }
            .stock-name {
                font-size: 12px;
            }
            .stock-code {
                font-size: 10px;
            }
            .download-btn {
                width: 100%;
                margin-right: 0;
            }
            .color-scheme-selector {
                flex-direction: column;
                align-items: stretch;
            }
            .color-option {
                text-align: center;
            }
        }
        
        /* å¤§å±å¹•ä¼˜åŒ– 1440px+ */
        @media (min-width: 1440px) {
            .container {
                max-width: 1800px;
            }
            .chart-container {
                height: 800px;
            }
            .chart-container.small {
                height: 700px;
            }
            .chart-container.large {
                height: 900px;
            }
        }
        
        /* è¶…å¤§å±å¹•ä¼˜åŒ– 1920px+ */
        @media (min-width: 1920px) {
            .container {
                max-width: 2200px;
            }
            .chart-container {
                height: 850px;
            }
            .chart-container.small {
                height: 750px;
            }
            .chart-container.large {
                height: 1000px;
            }
        }
        
        /* 4Kè¶…é«˜æ¸…å±å¹• 2560px+ */
        @media (min-width: 2560px) {
            .container {
                max-width: 2800px;
            }
            .chart-container {
                height: 950px;
            }
            .chart-container.small {
                height: 850px;
            }
            .chart-container.large {
                height: 1100px;
            }
            .chart-container.enlarged {
                height: 1300px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ä¸“ä¸šé‡åŒ–è‚¡ç¥¨åˆ†æç³»ç»Ÿ</h1>
            <p style="color: #aaa;">å®æ—¶æ•°æ®è·å– Â· å…¨é‡æŠ€æœ¯æŒ‡æ ‡ Â· Kçº¿å›¾åˆ†æ Â· åŸºæœ¬é¢ç ”ç©¶</p>
        </div>

        <div class="search-section">
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <button onclick="switchCategory('stock')" id="stockCategoryBtn" class="category-btn active">
                        ğŸ“Š è‚¡ç¥¨å¸‚åœº
                    </button>
                    <button onclick="switchCategory('fund')" id="fundCategoryBtn" class="category-btn">
                        ğŸ’¼ åŸºé‡‘å¸‚åœº
                    </button>
                    <button onclick="switchCategory('crypto')" id="cryptoCategoryBtn" class="category-btn">
                        â‚¿ åŠ å¯†è´§å¸
                    </button>
                </div>
            </div>

            <div id="stockCategory" class="category-content">
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 10px;">ğŸ“ˆ çƒ­é—¨è‚¡ç¥¨</h3>
                    <div class="stock-grid" id="stockGrid"></div>
                </div>
            </div>

            <div id="fundCategory" class="category-content" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 10px;">ğŸ’¼ çƒ­é—¨åŸºé‡‘</h3>
                    <div class="stock-grid" id="fundGrid"></div>
                </div>
            </div>

            <div id="cryptoCategory" class="category-content" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 10px;">â‚¿ åŠ å¯†è´§å¸ (Crypto)</h3>
                    <div class="stock-grid" id="cryptoGrid"></div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border-left: 4px solid #fbbf24;">
                    <p style="color: #fbbf24; font-size: 13px; margin: 0;">
                        âš ï¸ <strong>é£é™©æç¤ºï¼š</strong>åŠ å¯†è´§å¸å¸‚åœºæ³¢åŠ¨æå¤§ï¼Œä»·æ ¼å¯èƒ½å‰§çƒˆæ³¢åŠ¨ã€‚è¯·è°¨æ…æŠ•èµ„ï¼Œåšå¥½é£é™©ç®¡ç†ã€‚
                    </p>
                </div>
            </div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #2d3561;">
                <h3 style="color: #4facfe; font-size: 16px; margin-bottom: 15px;">ğŸ” è‡ªå®šä¹‰æœç´¢</h3>
                <div class="search-bar">
                    <input type="text" class="search-input" id="stockCode" placeholder="è¾“å…¥è‚¡ç¥¨/åŸºé‡‘ä»£ç ï¼ˆå¦‚ï¼šAAPL, 600519.SS, 000001.SZï¼‰" />
                    <select id="dataSource">
                        <option value="yahoo">Yahoo Financeï¼ˆå…¨çƒå¸‚åœºï¼‰</option>
                        <option value="sina">æ–°æµªè´¢ç»ï¼ˆAè‚¡å®æ—¶ï¼‰</option>
                    </select>
                    <select id="klineType">
                        <option value="1m">1åˆ†é’Ÿ</option>
                        <option value="5m">5åˆ†é’Ÿ</option>
                        <option value="15m">15åˆ†é’Ÿ</option>
                        <option value="30m">30åˆ†é’Ÿ</option>
                        <option value="60m">60åˆ†é’Ÿ</option>
                        <option value="120m">120åˆ†é’Ÿ</option>
                        <option value="1d" selected>æ—¥K</option>
                        <option value="1wk">å‘¨K</option>
                        <option value="1mo">æœˆK</option>
                    </select>
                    <select id="timeRange">
                        <option value="1d">1å¤©</option>
                        <option value="5d">5å¤©</option>
                        <option value="1mo">1ä¸ªæœˆ</option>
                        <option value="3mo" selected>3ä¸ªæœˆ</option>
                        <option value="6mo">6ä¸ªæœˆ</option>
                        <option value="1y">1å¹´</option>
                        <option value="2y">2å¹´</option>
                        <option value="5y">5å¹´</option>
                    </select>
                    <button onclick="fetchStockData()" id="searchBtn">ğŸ” è·å–æ•°æ®</button>
                </div>
                <div style="margin-top: 15px;">
                    <h4 style="color: #4facfe; font-size: 14px; margin-bottom: 10px;">âš¡ å¿«é€Ÿå‘¨æœŸåˆ‡æ¢</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="quickSelectPeriod('1m', '1d')" style="padding: 8px 16px; font-size: 13px;">1åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('5m', '1d')" style="padding: 8px 16px; font-size: 13px;">5åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('15m', '5d')" style="padding: 8px 16px; font-size: 13px;">15åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('30m', '5d')" style="padding: 8px 16px; font-size: 13px;">30åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('60m', '1mo')" style="padding: 8px 16px; font-size: 13px;">60åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('120m', '1mo')" style="padding: 8px 16px; font-size: 13px;">120åˆ†é’Ÿ</button>
                        <button onclick="quickSelectPeriod('1d', '3mo')" style="padding: 8px 16px; font-size: 13px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">æ—¥K</button>
                        <button onclick="quickSelectPeriod('1wk', '1y')" style="padding: 8px 16px; font-size: 13px;">å‘¨K</button>
                        <button onclick="quickSelectPeriod('1mo', '5y')" style="padding: 8px 16px; font-size: 13px;">æœˆK</button>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #888;">
                    <strong>æç¤ºï¼š</strong>
                    ç¾è‚¡ç›´æ¥è¾“å…¥ä»£ç ï¼ˆå¦‚ AAPLï¼‰ï¼Œ
                    Aè‚¡ä¸Šæµ·åŠ  .SSï¼ˆå¦‚ 600519.SSï¼‰ï¼Œ
                    æ·±åœ³åŠ  .SZï¼ˆå¦‚ 000001.SZï¼‰ï¼Œ
                    æ¸¯è‚¡åŠ  .HKï¼ˆå¦‚ 0700.HKï¼‰
                    <br>
                    <span style="color: #facc15;">ğŸ’¡ å¿«é€Ÿå‘¨æœŸåˆ‡æ¢ï¼šå…ˆé€‰æ‹©è‚¡ç¥¨ï¼Œç„¶åç‚¹å‡»ä¸Šæ–¹çš„å‘¨æœŸæŒ‰é’®å³å¯å¿«é€Ÿåˆ‡æ¢ä¸åŒå‘¨æœŸçš„Kçº¿å›¾</span>
                </div>
                <div class="color-scheme-selector">
                    <strong style="color: #4facfe;">ğŸ¨ é¢œè‰²æ–¹æ¡ˆï¼š</strong>
                    <div class="color-option active" onclick="setColorScheme('western')" id="westernScheme">
                        ğŸŒ å›½é™…æƒ¯ä¾‹ (ç»¿æ¶¨çº¢è·Œ)
                    </div>
                    <div class="color-option" onclick="setColorScheme('chinese')" id="chineseScheme">
                        ğŸ‡¨ğŸ‡³ ä¸­å›½Aè‚¡ (çº¢æ¶¨ç»¿è·Œ)
                    </div>
                </div>
            </div>
        </div>

        <div id="errorMsg" class="error"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div id="results" style="display: none;">
            <!-- ä¸‹è½½åŠŸèƒ½åŒº -->
            <div class="download-section">
                <h2 style="color: #4facfe; font-size: 20px; margin-bottom: 15px;">ğŸ“¥ æ•°æ®ä¸‹è½½</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <button class="download-btn" onclick="downloadAllData()">ğŸ“Š ä¸‹è½½å®Œæ•´æ•°æ®(CSV)</button>
                    <button class="download-btn" onclick="downloadIndicators()">ğŸ“ˆ ä¸‹è½½æ‰€æœ‰æŒ‡æ ‡(CSV)</button>
                    <button class="download-btn" onclick="downloadKlineData()">ğŸ•¯ï¸ ä¸‹è½½Kçº¿æ•°æ®(CSV)</button>
                    <button class="download-btn" onclick="downloadJSON()">ğŸ’¾ ä¸‹è½½JSONæ ¼å¼</button>
                    <button class="download-btn" onclick="downloadReport()">ğŸ“„ ç”Ÿæˆåˆ†ææŠ¥å‘Š(TXT)</button>
                    <button class="download-btn" onclick="downloadAllCharts()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">ğŸ–¼ï¸ ä¸‹è½½æ‰€æœ‰å›¾è¡¨(PNG)</button>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; font-size: 12px; color: #8b5cf6;">
                    ğŸ’¡ <strong>ä¸‹è½½æç¤ºï¼š</strong>å¦‚æœå›¾è¡¨ä¸‹è½½å¤±è´¥ï¼Œè¯·å…ˆåˆ‡æ¢åˆ°"æŠ€æœ¯æŒ‡æ ‡"å’Œ"é‡ä»·åˆ†æ"æ ‡ç­¾é¡µï¼Œç¡®ä¿å›¾è¡¨å·²å®Œå…¨åŠ è½½åå†ä¸‹è½½ã€‚
                </div>
            </div>

            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="card" id="companyInfoCard">
                <h2>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h2>
                <div class="company-info" id="companyInfo"></div>
            </div>

            <!-- åŸºæœ¬é¢æ•°æ® -->
            <div class="card" id="fundamentalsCard">
                <h2>ğŸ’° åŸºæœ¬é¢åˆ†æ</h2>
                <div class="fundamentals-grid" id="fundamentalsData"></div>
            </div>

            <!-- å®æ—¶æ•°æ® -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- å½“å‰å‘¨æœŸä¿¡æ¯ -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">å½“å‰å‘¨æœŸ</div>
                        <div style="font-size: 24px; font-weight: bold; margin-top: 5px;" id="currentPeriodDisplay">æ—¥Kçº¿ - 3ä¸ªæœˆ</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; opacity: 0.9;">æ•°æ®æ¡æ•°</div>
                        <div style="font-size: 24px; font-weight: bold; margin-top: 5px;" id="dataCountDisplay">-</div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯ä¿¡å· -->
            <div class="card">
                <h2>ğŸ¯ ç»¼åˆæŠ€æœ¯ä¿¡å·</h2>
                <div class="signals" id="signals"></div>
                <div class="indicator-panel" id="indicatorPanel"></div>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('overview')">ğŸ“ˆ å¸‚åœºæ€»è§ˆ</div>
                <div class="tab" onclick="switchTab('technical')">ğŸ“Š æŠ€æœ¯æŒ‡æ ‡</div>
                <div class="tab" onclick="switchTab('volume')">ğŸ“¦ é‡ä»·åˆ†æ</div>
                <div class="tab" onclick="switchTab('pattern')">ğŸ” å½¢æ€è¯†åˆ«</div>
            </div>

            <!-- æ€»è§ˆ -->
            <div id="overview" class="content active">
                <div class="card">
                    <h2>ğŸ“Š Kçº¿å›¾ä¸å‡çº¿ç³»ç»Ÿ</h2>
                    <div class="chart-container large">
                        <div id="candlestickChart"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ å¸ƒæ—å¸¦åˆ†æï¼ˆBollinger Bandsï¼‰</h2>
                    <div class="chart-container">
                        <div id="bollingerChart"></div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯æŒ‡æ ‡ -->
            <div id="technical" class="content">
                <div class="chart-grid">
                    <div class="card">
                        <h2>ğŸ“‰ MACDæŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>å¹³æ»‘å¼‚åŒç§»åŠ¨å¹³å‡çº¿ï¼Œç”¨äºåˆ¤æ–­ä¹°å–æ—¶æœºã€‚DIFä¸Šç©¿DEAä¸ºé‡‘å‰ï¼ˆä¹°å…¥ï¼‰ï¼Œä¸‹ç©¿ä¸ºæ­»å‰ï¼ˆå–å‡ºï¼‰ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="macdChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š KDJéšæœºæŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>éšæœºæ‘†åŠ¨æŒ‡æ ‡ï¼ŒKå€¼>80è¶…ä¹°ï¼Œ<20è¶…å–ã€‚Jå€¼æœ€æ•æ„Ÿï¼Œå¯æå‰å‘ç°è½¬æŠ˜ç‚¹ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="kdjChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“ˆ RSIç›¸å¯¹å¼ºå¼±æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>ç›¸å¯¹å¼ºå¼±æŒ‡æ•°ï¼Œ>70è¶…ä¹°åŒºåŸŸï¼Œ<30è¶…å–åŒºåŸŸã€‚50ä¸ºå¼ºå¼±åˆ†ç•Œçº¿ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="rsiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š å¨å»‰æŒ‡æ ‡ï¼ˆWRï¼‰</h2>
                        <div class="info-box">
                            <p>å¨å»‰è¶…ä¹°è¶…å–æŒ‡æ ‡ï¼Œ>-20ä¸ºè¶…ä¹°ï¼Œ<-80ä¸ºè¶…å–ã€‚ä¸ä»·æ ¼å½¢æˆèƒŒç¦»æ—¶ä¸ºåè½¬ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="wrChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“‰ CCIé¡ºåŠ¿æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>å•†å“è·¯å¾„æŒ‡æ ‡ï¼Œ>100ä¸ºè¶…ä¹°ï¼Œ<-100ä¸ºè¶…å–ã€‚ç©¿è¶Š0è½´ä¸ºè¶‹åŠ¿æ”¹å˜ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="cciChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š DMIè¶‹å‘æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>åŠ¨å‘æŒ‡æ ‡ï¼ŒPDIä¸Šç©¿MDIçœ‹å¤šï¼Œä¸‹ç©¿çœ‹ç©ºã€‚ADX>25è¡¨ç¤ºè¶‹åŠ¿å¼ºåŠ²ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="dmiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ¯ SARæŠ›ç‰©çº¿æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>ç‚¹ä½åœ¨ä»·æ ¼ä¸‹æ–¹ä¸ºçœ‹æ¶¨ï¼Œä¸Šæ–¹ä¸ºçœ‹è·Œã€‚SARè½¬å‘æ—¶æä¾›æ˜ç¡®çš„æ­¢æŸæˆ–åè½¬ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="sarChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š TRIXæŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>ä¸‰é‡æŒ‡æ•°å¹³æ»‘ç§»åŠ¨å¹³å‡ï¼Œè¿‡æ»¤çŸ­æœŸå™ªéŸ³ã€‚ä¸Šç©¿é›¶è½´çœ‹å¤šï¼Œä¸‹ç©¿çœ‹ç©ºã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="trixChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š ATRæ³¢åŠ¨ç‡æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>è¡¡é‡å¸‚åœºæ³¢åŠ¨æ€§ï¼Œå€¼è¶Šå¤§æ³¢åŠ¨è¶Šå‰§çƒˆã€‚å¸¸ç”¨äºè®¾ç½®åŠ¨æ€æ­¢æŸä½ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="atrChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š StochéšæœºæŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>å¿«é€ŸéšæœºæŒ‡æ ‡ï¼ŒKçº¿å’ŒDçº¿ã€‚>80è¶…ä¹°ï¼Œ<20è¶…å–ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="stochChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š MOMåŠ¨é‡æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>è¡¡é‡ä»·æ ¼å˜åŒ–é€Ÿåº¦ã€‚ç©¿è¶Šé›¶è½´ä¸ºè¶‹åŠ¿æ”¹å˜ï¼Œä¸ä»·æ ¼èƒŒç¦»ä¸ºåè½¬ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="momChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ’° MFIèµ„é‡‘æµé‡æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>æˆäº¤é‡åŠ æƒçš„RSIï¼Œè¡¡é‡èµ„é‡‘æµå…¥æµå‡ºåŠ›åº¦ã€‚>80è¶…ä¹°ï¼Œ<20è¶…å–ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="mfiChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“ˆ ä¸€ç›®å‡è¡¡è¡¨ (Ichimoku)</h2>
                        <div class="info-box">
                            <p>ç»¼åˆè¶‹åŠ¿ç³»ç»Ÿï¼ŒåŒ…å«è½¬æ¢çº¿ã€åŸºå‡†çº¿ã€å…ˆè¡Œå¸¦ï¼ˆäº‘å±‚ï¼‰ã€‚ä»·æ ¼åœ¨äº‘å±‚ä¸Šæ–¹ä¸ºå¤šå¤´ï¼Œä¸‹æ–¹ä¸ºç©ºå¤´ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="ichimokuChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š ROCå˜åŠ¨ç‡æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>è¡¡é‡ä»·æ ¼å˜åŠ¨é€Ÿåº¦ï¼Œ>0ä¸Šæ¶¨åŠ¨èƒ½ï¼Œ<0ä¸‹è·ŒåŠ¨èƒ½ã€‚ä¸ä»·æ ¼èƒŒç¦»ä¸ºåè½¬ä¿¡å·ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="rocChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“‰ BIASä¹–ç¦»ç‡</h2>
                        <div class="info-box">
                            <p>ä»·æ ¼ä¸å‡çº¿çš„åç¦»åº¦ï¼Œ>10%è¶…ä¹°ï¼Œ<-10%è¶…å–ã€‚æç«¯å€¼é¢„ç¤ºå›å½’ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="biasChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ§  PSYå¿ƒç†çº¿</h2>
                        <div class="info-box">
                            <p>å¸‚åœºæƒ…ç»ªæŒ‡æ ‡ï¼Œ>75%è¿‡åº¦ä¹è§‚ï¼Œ<25%è¿‡åº¦æ‚²è§‚ã€‚åæ˜ æŠ•èµ„è€…å¿ƒç†çŠ¶æ€ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="psyChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>âš¡ EMVç®€æ˜“æ³¢åŠ¨æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>è¡¡é‡ä»·æ ¼ä¸æˆäº¤é‡å…³ç³»ï¼Œæ­£å€¼å®¹æ˜“ä¸Šæ¶¨ï¼Œè´Ÿå€¼å®¹æ˜“ä¸‹è·Œã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="emvChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“ˆ Arooné˜¿éš†æŒ‡æ ‡</h2>
                        <div class="info-box">
                            <p>è¯†åˆ«è¶‹åŠ¿å˜åŒ–ï¼ŒAroonUp>70ä¸”AroonDown<30ä¸ºå¼ºåŠ¿ä¸Šæ¶¨ã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="aroonChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š DMAå¹³è¡Œçº¿å·®</h2>
                        <div class="info-box">
                            <p>åŒå‡çº¿å·®å€¼ç³»ç»Ÿï¼ŒDMAä¸Šç©¿AMAä¸ºä¹°å…¥ï¼Œä¸‹ç©¿ä¸ºå–å‡ºã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="dmaChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“‰ EXPMAæŒ‡æ•°å¹³æ»‘å‡çº¿</h2>
                        <div class="info-box">
                            <p>å¿«é€Ÿå“åº”ä»·æ ¼å˜åŒ–çš„å‡çº¿ç³»ç»Ÿï¼ŒçŸ­æœŸçº¿ä¸Šç©¿é•¿æœŸçº¿çœ‹å¤šã€‚</p>
                        </div>
                        <div class="chart-container small">
                            <canvas id="expmaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é‡ä»·åˆ†æ -->
            <div id="volume" class="content">
                <div class="card">
                    <h2>ğŸ“¦ æˆäº¤é‡åˆ†æ</h2>
                    <div class="info-box">
                        <p>ä»·æ¶¨é‡å¢ä¸ºæ­£å¸¸ä¸Šæ¶¨ï¼Œä»·æ¶¨é‡ç¼©éœ€è°¨æ…ã€‚ä»·è·Œé‡å¢ä¸ºæ€è·Œï¼Œä»·è·Œé‡ç¼©ä¸ºè‡ªç„¶å›è°ƒã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š OBVèƒ½é‡æ½®</h2>
                    <div class="info-box">
                        <p>ç´¯ç§¯èƒ½é‡çº¿ï¼Œä»·å‡é‡å¢OBVä¸Šå‡ï¼Œä»·è·Œé‡å¢OBVä¸‹é™ã€‚OBVä¸ä»·æ ¼èƒŒç¦»ä¸ºåè½¬ä¿¡å·ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="obvChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ é‡æ¯”åˆ†æ</h2>
                    <div class="info-box">
                        <p>å½“æ—¥æ¯åˆ†é’Ÿå¹³å‡æˆäº¤é‡ä¸è¿‡å»5æ—¥æ¯åˆ†é’Ÿå¹³å‡æˆäº¤é‡çš„æ¯”å€¼ã€‚>1æ”¾é‡ï¼Œ<1ç¼©é‡ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="volumeRatioChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š VRæˆäº¤é‡æ¯”ç‡</h2>
                    <div class="info-box">
                        <p>æˆäº¤é‡ä¸ä»·æ ¼å˜åŠ¨å…³ç³»ã€‚VR>160è¶…ä¹°ï¼Œ<40è¶…å–ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="vrChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ BRARäººæ°”æ„æ„¿æŒ‡æ ‡</h2>
                    <div class="info-box">
                        <p>BRåæ˜ äººæ°”ï¼ŒARåæ˜ æ„æ„¿ã€‚BRã€AR>150è¶…ä¹°ï¼Œ<50è¶…å–ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="brarChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>âš¡ CRèƒ½é‡æŒ‡æ ‡</h2>
                    <div class="info-box">
                        <p>è¡¡é‡äººæ°”ä¸ä»·æ ¼åŠ¨é‡ã€‚>300è¶…ä¹°ï¼Œ<40è¶…å–ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="crChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š A/D Lineé›†æ•£çº¿</h2>
                    <div class="info-box">
                        <p>è¡¡é‡èµ„é‡‘æµå…¥æµå‡ºã€‚ADLä¸ä»·æ ¼åŒå‘è¿åŠ¨ç¡®è®¤è¶‹åŠ¿ï¼ŒèƒŒç¦»é¢„ç¤ºåè½¬ã€‚</p>
                    </div>
                    <div class="chart-container small">
                        <canvas id="adlChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- å½¢æ€è¯†åˆ« -->
            <div id="pattern" class="content">
                <div class="card">
                    <h2>ğŸ” Kçº¿å½¢æ€è¯†åˆ«</h2>
                    <div id="patternResults"></div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š æ”¯æ’‘å‹åŠ›ä½</h2>
                    <div class="chart-container small">
                        <div id="supportResistanceChart"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“ˆ è¶‹åŠ¿çº¿åˆ†æ</h2>
                    <div id="trendAnalysis"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let stockData = null;
        let currentSymbol = '';
        let currentIndicators = null;
        let colorScheme = 'western'; // 'western' = ç»¿æ¶¨çº¢è·Œ, 'chinese' = çº¢æ¶¨ç»¿è·Œ
        
        // é¢œè‰²é…ç½®
        const colorConfig = {
            western: {
                up: '#22c55e',      // ç»¿è‰²
                down: '#ef4444',    // çº¢è‰²
                upBg: 'linear-gradient(135deg, #134e48 0%, #267871 100%)',
                downBg: 'linear-gradient(135deg, #7b1e3d 0%, #a32952 100%)'
            },
            chinese: {
                up: '#ef4444',      // çº¢è‰²
                down: '#22c55e',    // ç»¿è‰²
                upBg: 'linear-gradient(135deg, #7b1e3d 0%, #a32952 100%)',
                downBg: 'linear-gradient(135deg, #134e48 0%, #267871 100%)'
            }
        };

        // çƒ­é—¨è‚¡ç¥¨åˆ—è¡¨ï¼ˆæ‰©å±•ç‰ˆï¼‰
        const stockList = [
            // ç¾è‚¡ç§‘æŠ€
            { name: 'è‹¹æœ', code: 'AAPL', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'å¾®è½¯', code: 'MSFT', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'è°·æ­Œ', code: 'GOOGL', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'äºšé©¬é€Š', code: 'AMZN', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'ç‰¹æ–¯æ‹‰', code: 'TSLA', market: 'ç¾è‚¡', category: 'æ±½è½¦' },
            { name: 'è‹±ä¼Ÿè¾¾', code: 'NVDA', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'è„¸ä¹¦', code: 'META', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'å¥ˆé£', code: 'NFLX', market: 'ç¾è‚¡', category: 'åª’ä½“' },
            { name: 'è‹±ç‰¹å°”', code: 'INTC', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'AMD', code: 'AMD', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'å°ç§¯ç”µ', code: 'TSM', market: 'ç¾è‚¡', category: 'ç§‘æŠ€' },
            { name: 'è¿ªå£«å°¼', code: 'DIS', market: 'ç¾è‚¡', category: 'åª’ä½“' },
            { name: 'å¯å£å¯ä¹', code: 'KO', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'ç™¾äº‹å¯ä¹', code: 'PEP', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'éº¦å½“åŠ³', code: 'MCD', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'è€å…‹', code: 'NKE', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'æ˜Ÿå·´å…‹', code: 'SBUX', market: 'ç¾è‚¡', category: 'æ¶ˆè´¹' },
            { name: 'æ³¢éŸ³', code: 'BA', market: 'ç¾è‚¡', category: 'å·¥ä¸š' },
            { name: 'åŸƒå…‹æ£®ç¾å­š', code: 'XOM', market: 'ç¾è‚¡', category: 'èƒ½æº' },
            { name: 'é›ªä½›é¾™', code: 'CVX', market: 'ç¾è‚¡', category: 'èƒ½æº' },
            // ç¾è‚¡é‡‘è
            { name: 'æ‘©æ ¹å¤§é€š', code: 'JPM', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'ç¾å›½é“¶è¡Œ', code: 'BAC', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'å¯Œå›½é“¶è¡Œ', code: 'WFC', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'é«˜ç››', code: 'GS', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'ä¼¯å…‹å¸Œå°”', code: 'BRK-B', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'ç»´è¨', code: 'V', market: 'ç¾è‚¡', category: 'é‡‘è' },
            { name: 'ä¸‡äº‹è¾¾', code: 'MA', market: 'ç¾è‚¡', category: 'é‡‘è' },
            // Aè‚¡ä¸»æ¿
            { name: 'è´µå·èŒ…å°', code: '600519.SS', market: 'Aè‚¡', category: 'æ¶ˆè´¹' },
            { name: 'ä¸­å›½å¹³å®‰', code: '601318.SS', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'æ‹›å•†é“¶è¡Œ', code: '600036.SS', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'äº”ç²®æ¶²', code: '000858.SZ', market: 'Aè‚¡', category: 'æ¶ˆè´¹' },
            { name: 'ç¾çš„é›†å›¢', code: '000333.SZ', market: 'Aè‚¡', category: 'å®¶ç”µ' },
            { name: 'æ ¼åŠ›ç”µå™¨', code: '000651.SZ', market: 'Aè‚¡', category: 'å®¶ç”µ' },
            { name: 'ä¸­å›½ç§»åŠ¨', code: '600941.SS', market: 'Aè‚¡', category: 'é€šä¿¡' },
            { name: 'å·¥å•†é“¶è¡Œ', code: '601398.SS', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'å»ºè®¾é“¶è¡Œ', code: '601939.SS', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'ä¸­å›½çŸ³æ²¹', code: '601857.SS', market: 'Aè‚¡', category: 'èƒ½æº' },
            { name: 'ä¸­å›½çŸ³åŒ–', code: '600028.SS', market: 'Aè‚¡', category: 'èƒ½æº' },
            { name: 'æµ·å¤©å‘³ä¸š', code: '603288.SS', market: 'Aè‚¡', category: 'æ¶ˆè´¹' },
            { name: 'æ’ç‘åŒ»è¯', code: '600276.SS', market: 'Aè‚¡', category: 'åŒ»è¯' },
            { name: 'è¯æ˜åº·å¾·', code: '603259.SS', market: 'Aè‚¡', category: 'åŒ»è¯' },
            { name: 'éš†åŸºç»¿èƒ½', code: '601012.SS', market: 'Aè‚¡', category: 'æ–°èƒ½æº' },
            { name: 'ä¸‰ä¸€é‡å·¥', code: '600031.SS', market: 'Aè‚¡', category: 'æœºæ¢°' },
            // åˆ›ä¸šæ¿/ç§‘åˆ›æ¿
            { name: 'å®å¾·æ—¶ä»£', code: '300750.SZ', market: 'Aè‚¡', category: 'æ–°èƒ½æº' },
            { name: 'æ¯”äºšè¿ª', code: '002594.SZ', market: 'Aè‚¡', category: 'æ±½è½¦' },
            { name: 'è¿ˆç‘åŒ»ç–—', code: '300760.SZ', market: 'Aè‚¡', category: 'åŒ»ç–—' },
            { name: 'ä¸œæ–¹è´¢å¯Œ', code: '300059.SZ', market: 'Aè‚¡', category: 'é‡‘è' },
            { name: 'æ±‡å·æŠ€æœ¯', code: '300124.SZ', market: 'Aè‚¡', category: 'å·¥æ§' },
            // æ¸¯è‚¡
            { name: 'è…¾è®¯æ§è‚¡', code: '0700.HK', market: 'æ¸¯è‚¡', category: 'ç§‘æŠ€' },
            { name: 'é˜¿é‡Œå·´å·´', code: '9988.HK', market: 'æ¸¯è‚¡', category: 'ç§‘æŠ€' },
            { name: 'ç¾å›¢', code: '3690.HK', market: 'æ¸¯è‚¡', category: 'äº’è”ç½‘' },
            { name: 'äº¬ä¸œ', code: '9618.HK', market: 'æ¸¯è‚¡', category: 'ç”µå•†' },
            { name: 'å°ç±³é›†å›¢', code: '1810.HK', market: 'æ¸¯è‚¡', category: 'ç§‘æŠ€' },
            { name: 'æ¯”äºšè¿ªè‚¡ä»½', code: '1211.HK', market: 'æ¸¯è‚¡', category: 'æ±½è½¦' },
            { name: 'ä¸­å›½ç§»åŠ¨', code: '0941.HK', market: 'æ¸¯è‚¡', category: 'é€šä¿¡' }
        ];

        // åŠ å¯†è´§å¸åˆ—è¡¨ï¼ˆå¸åœˆï¼‰
        const cryptoList = [
            // ä¸»æµå¸
            { name: 'æ¯”ç‰¹å¸', code: 'BTC-USD', market: 'åŠ å¯†è´§å¸', category: 'ä¸»æµå¸' },
            { name: 'ä»¥å¤ªåŠ', code: 'ETH-USD', market: 'åŠ å¯†è´§å¸', category: 'ä¸»æµå¸' },
            { name: 'å¸å®‰å¸', code: 'BNB-USD', market: 'åŠ å¯†è´§å¸', category: 'ä¸»æµå¸' },
            { name: 'ç‘æ³¢å¸', code: 'XRP-USD', market: 'åŠ å¯†è´§å¸', category: 'ä¸»æµå¸' },
            { name: 'å¡å°”è¾¾è¯º', code: 'ADA-USD', market: 'åŠ å¯†è´§å¸', category: 'ä¸»æµå¸' },
            { name: 'Solana', code: 'SOL-USD', market: 'åŠ å¯†è´§å¸', category: 'ä¸»æµå¸' },
            { name: 'Litecoin', code: 'LTC-USD', market: 'åŠ å¯†è´§å¸', category: 'ä¸»æµå¸' },
            { name: 'Bitcoin Cash', code: 'BCH-USD', market: 'åŠ å¯†è´§å¸', category: 'ä¸»æµå¸' },
            // Memeå¸
            { name: 'ç‹—ç‹—å¸', code: 'DOGE-USD', market: 'åŠ å¯†è´§å¸', category: 'Memeå¸' },
            { name: 'æŸ´çŠ¬å¸', code: 'SHIB-USD', market: 'åŠ å¯†è´§å¸', category: 'Memeå¸' },
            { name: 'Pepe', code: 'PEPE-USD', market: 'åŠ å¯†è´§å¸', category: 'Memeå¸' },
            // Layer1/Layer2
            { name: 'Polygon', code: 'MATIC-USD', market: 'åŠ å¯†è´§å¸', category: 'Layer2' },
            { name: 'Avalanche', code: 'AVAX-USD', market: 'åŠ å¯†è´§å¸', category: 'Layer1' },
            { name: 'Polkadot', code: 'DOT-USD', market: 'åŠ å¯†è´§å¸', category: 'è·¨é“¾' },
            { name: 'Cosmos', code: 'ATOM-USD', market: 'åŠ å¯†è´§å¸', category: 'è·¨é“¾' },
            // DeFi
            { name: 'Chainlink', code: 'LINK-USD', market: 'åŠ å¯†è´§å¸', category: 'DeFi' },
            { name: 'Uniswap', code: 'UNI-USD', market: 'åŠ å¯†è´§å¸', category: 'DeFi' },
            { name: 'Aave', code: 'AAVE-USD', market: 'åŠ å¯†è´§å¸', category: 'DeFi' },
            // ç¨³å®šå¸
            { name: 'USDT', code: 'USDT-USD', market: 'åŠ å¯†è´§å¸', category: 'ç¨³å®šå¸' },
            { name: 'USDC', code: 'USDC-USD', market: 'åŠ å¯†è´§å¸', category: 'ç¨³å®šå¸' }
        ];

        // çƒ­é—¨åŸºé‡‘åˆ—è¡¨ï¼ˆæ‰©å±•ç‰ˆ - ä½¿ç”¨ETFä»£ç ï¼‰
        const fundList = [
            // ç¾å›½å®½åŸºæŒ‡æ•°ETF
            { name: 'æ ‡æ™®500ETF', code: 'SPY', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'çº³æ–¯è¾¾å…‹100ETF', code: 'QQQ', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'é“ç¼æ–¯ETF', code: 'DIA', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'ç½—ç´ 2000ETF', code: 'IWM', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'æ ‡æ™®400ä¸­ç›˜ETF', code: 'MDY', market: 'ç¾å›½', category: 'å®½åŸºæŒ‡æ•°' },
            // ç¾å›½è¡Œä¸šETF
            { name: 'ç§‘æŠ€è‚¡ETF', code: 'XLK', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'é‡‘èè‚¡ETF', code: 'XLF', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'åŒ»ç–—è‚¡ETF', code: 'XLV', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'èƒ½æºè‚¡ETF', code: 'XLE', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'æ¶ˆè´¹ETF', code: 'XLP', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'å·¥ä¸šETF', code: 'XLI', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'æˆ¿åœ°äº§ETF', code: 'XLRE', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'å…¬ç”¨äº‹ä¸šETF', code: 'XLU', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'ææ–™ETF', code: 'XLB', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            { name: 'é€šä¿¡ETF', code: 'XLC', market: 'ç¾å›½', category: 'è¡Œä¸š' },
            // ç¾å›½ä¸»é¢˜ETF
            { name: 'åŠå¯¼ä½“ETF', code: 'SOXX', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'ç”Ÿç‰©ç§‘æŠ€ETF', code: 'IBB', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'äº‘è®¡ç®—ETF', code: 'SKYY', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'ç½‘ç»œå®‰å…¨ETF', code: 'HACK', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'æ¸…æ´èƒ½æºETF', code: 'ICLN', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            { name: 'ç”µåŠ¨è½¦ETF', code: 'DRIV', market: 'ç¾å›½', category: 'ä¸»é¢˜' },
            // å›½é™…å¸‚åœºETF
            { name: 'æ–°å…´å¸‚åœºETF', code: 'EEM', market: 'ç¾å›½', category: 'å›½é™…' },
            { name: 'ä¸­å›½ETF', code: 'FXI', market: 'ç¾å›½', category: 'å›½é™…' },
            { name: 'æ¬§æ´²ETF', code: 'VGK', market: 'ç¾å›½', category: 'å›½é™…' },
            { name: 'æ—¥æœ¬ETF', code: 'EWJ', market: 'ç¾å›½', category: 'å›½é™…' },
            { name: 'å°åº¦ETF', code: 'INDA', market: 'ç¾å›½', category: 'å›½é™…' },
            // å•†å“ETF
            { name: 'é»„é‡‘ETF', code: 'GLD', market: 'ç¾å›½', category: 'å•†å“' },
            { name: 'ç™½é“¶ETF', code: 'SLV', market: 'ç¾å›½', category: 'å•†å“' },
            { name: 'çŸ³æ²¹ETF', code: 'USO', market: 'ç¾å›½', category: 'å•†å“' },
            { name: 'å¤©ç„¶æ°”ETF', code: 'UNG', market: 'ç¾å›½', category: 'å•†å“' },
            // å€ºåˆ¸ETF
            { name: 'ç¾å›½å›½å€ºETF', code: 'TLT', market: 'ç¾å›½', category: 'å€ºåˆ¸' },
            { name: 'å…¬å¸å€ºETF', code: 'LQD', market: 'ç¾å›½', category: 'å€ºåˆ¸' },
            { name: 'é«˜æ”¶ç›Šå€ºETF', code: 'HYG', market: 'ç¾å›½', category: 'å€ºåˆ¸' },
            // ä¸­å›½å®½åŸºETF
            { name: 'æ²ªæ·±300ETF', code: '510300.SS', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'ä¸­è¯500ETF', code: '510500.SS', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'åˆ›ä¸šæ¿ETF', code: '159915.SZ', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'ç§‘åˆ›50ETF', code: '588000.SS', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'ä¸Šè¯50ETF', code: '510050.SS', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            { name: 'æ·±è¯100ETF', code: '159901.SZ', market: 'ä¸­å›½', category: 'å®½åŸºæŒ‡æ•°' },
            // ä¸­å›½è¡Œä¸šETF
            { name: 'æ¶ˆè´¹ETF', code: '159928.SZ', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'åŒ»è¯ETF', code: '512010.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'åˆ¸å•†ETF', code: '512000.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'é“¶è¡ŒETF', code: '512800.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'å†›å·¥ETF', code: '512660.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'èŠ¯ç‰‡ETF', code: '512760.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'æ–°èƒ½æºè½¦ETF', code: '515030.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            { name: 'å…‰ä¼ETF', code: '515790.SS', market: 'ä¸­å›½', category: 'è¡Œä¸š' },
            // ä¸­å›½å…¶ä»–ETF
            { name: 'æ’ç”ŸETF', code: '159920.SZ', market: 'ä¸­å›½', category: 'æ¸¯è‚¡' },
            { name: 'æ’ç”Ÿç§‘æŠ€ETF', code: '513180.SS', market: 'ä¸­å›½', category: 'æ¸¯è‚¡ç§‘æŠ€' },
            { name: 'çº¢åˆ©ETF', code: '510880.SS', market: 'ä¸­å›½', category: 'ç­–ç•¥' },
            { name: 'Hè‚¡ETF', code: '510900.SS', market: 'ä¸­å›½', category: 'æ¸¯è‚¡' },
            { name: 'é»„é‡‘ETF', code: '518880.SS', market: 'ä¸­å›½', category: 'å•†å“' }
        ];

        // åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            initStockGrid();
            initFundGrid();
            initCryptoGrid();
        };

        // åˆå§‹åŒ–è‚¡ç¥¨åˆ—è¡¨
        function initStockGrid() {
            const grid = document.getElementById('stockGrid');
            grid.innerHTML = stockList.map(stock => `
                <div class="stock-item" onclick="selectStock('${stock.code}', '${stock.name}')">
                    <div class="stock-name">${stock.name}</div>
                    <div class="stock-code">${stock.code}</div>
                    <div class="stock-code">${stock.market}</div>
                </div>
            `).join('');
        }

        // åˆå§‹åŒ–åŸºé‡‘åˆ—è¡¨
        function initFundGrid() {
            const grid = document.getElementById('fundGrid');
            grid.innerHTML = fundList.map(fund => `
                <div class="stock-item" onclick="selectStock('${fund.code}', '${fund.name}')">
                    <div class="stock-name">${fund.name}</div>
                    <div class="stock-code">${fund.code}</div>
                    <div class="stock-code">${fund.market}</div>
                </div>
            `).join('');
        }

        // åˆå§‹åŒ–åŠ å¯†è´§å¸åˆ—è¡¨
        function initCryptoGrid() {
            const grid = document.getElementById('cryptoGrid');
            grid.innerHTML = cryptoList.map(crypto => `
                <div class="stock-item" onclick="selectStock('${crypto.code}', '${crypto.name}')">
                    <div class="stock-name">${crypto.name}</div>
                    <div class="stock-code">${crypto.code}</div>
                    <div class="stock-code">${crypto.category}</div>
                </div>
            `).join('');
        }

        // åˆ‡æ¢åˆ†ç±»
        function switchCategory(category) {
            document.getElementById('stockCategoryBtn').classList.remove('active');
            document.getElementById('fundCategoryBtn').classList.remove('active');
            document.getElementById('cryptoCategoryBtn').classList.remove('active');
            document.getElementById('stockCategory').style.display = 'none';
            document.getElementById('fundCategory').style.display = 'none';
            document.getElementById('cryptoCategory').style.display = 'none';

            if (category === 'stock') {
                document.getElementById('stockCategoryBtn').classList.add('active');
                document.getElementById('stockCategory').style.display = 'block';
            } else if (category === 'fund') {
                document.getElementById('fundCategoryBtn').classList.add('active');
                document.getElementById('fundCategory').style.display = 'block';
            } else if (category === 'crypto') {
                document.getElementById('cryptoCategoryBtn').classList.add('active');
                document.getElementById('cryptoCategory').style.display = 'block';
            }
        }

        // é€‰æ‹©è‚¡ç¥¨/åŸºé‡‘
        function selectStock(code, name) {
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.stock-item').forEach(item => {
                item.classList.remove('selected');
            });
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            event.currentTarget.classList.add('selected');
            
            // è®¾ç½®ä»£ç å¹¶è·å–æ•°æ®
            document.getElementById('stockCode').value = code;
            currentSymbol = code;
            fetchStockData();
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        // åˆ‡æ¢é¢œè‰²æ–¹æ¡ˆ
        function setColorScheme(scheme) {
            colorScheme = scheme;
            document.getElementById('westernScheme').classList.remove('active');
            document.getElementById('chineseScheme').classList.remove('active');
            document.getElementById(scheme + 'Scheme').classList.add('active');
            
            // å¦‚æœå·²æœ‰æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“
            if (stockData && currentIndicators) {
                displayStats(stockData, currentIndicators);
                displaySignals(stockData, currentIndicators);
            }
        }
        
        // ä¸‹è½½å®Œæ•´æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰
        function downloadAllData() {
            console.log('downloadAllData è¢«è°ƒç”¨');
            console.log('stockData:', stockData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®');
            console.log('currentIndicators:', currentIndicators ? 'æœ‰æŒ‡æ ‡' : 'æ— æŒ‡æ ‡');
            
            if (!stockData || !currentIndicators) {
                alert('âŒ è¯·å…ˆé€‰æ‹©è‚¡ç¥¨/åŸºé‡‘å¹¶è·å–æ•°æ®åå†ä¸‹è½½ï¼\n\næ“ä½œæ­¥éª¤ï¼š\n1. é€‰æ‹©è‚¡ç¥¨æˆ–åŸºé‡‘\n2. ç‚¹å‡»"è·å–æ•°æ®"æŒ‰é’®\n3. ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ\n4. å†ç‚¹å‡»ä¸‹è½½æŒ‰é’®');
                return;
            }
            
            let csv = 'Date,Open,High,Low,Close,Volume,MA5,MA10,MA20,MA30,MA60,RSI,MACD,Signal,KDJ_K,KDJ_D,KDJ_J\n';
            
            stockData.forEach((row, i) => {
                csv += `${row.date},${row.open},${row.high},${row.low},${row.close},${row.volume},`;
                csv += `${currentIndicators.ma5[i] || ''},${currentIndicators.ma10[i] || ''},`;
                csv += `${currentIndicators.ma20[i] || ''},${currentIndicators.ma30[i] || ''},${currentIndicators.ma60[i] || ''},`;
                csv += `${currentIndicators.rsi[i] || ''},${currentIndicators.macd.macd[i] || ''},${currentIndicators.macd.signal[i] || ''},`;
                csv += `${currentIndicators.kdj.k[i] || ''},${currentIndicators.kdj.d[i] || ''},${currentIndicators.kdj.j[i] || ''}\n`;
            });
            
            downloadFile(csv, `${currentSymbol}_complete_data.csv`, 'text/csv');
        }
        
        // ä¸‹è½½æ‰€æœ‰æŒ‡æ ‡ï¼ˆCSVæ ¼å¼ï¼‰
        function downloadIndicators() {
            console.log('downloadIndicators è¢«è°ƒç”¨');
            if (!stockData || !currentIndicators) {
                alert('âŒ è¯·å…ˆé€‰æ‹©è‚¡ç¥¨/åŸºé‡‘å¹¶è·å–æ•°æ®åå†ä¸‹è½½ï¼');
                return;
            }
            
            let csv = 'Date,RSI,MACD,MACD_Signal,MACD_Histogram,KDJ_K,KDJ_D,KDJ_J,WR,CCI,ADX,SAR,TRIX,ATR,MOM,MFI,OBV,VR,BR,AR,CR\n';
            
            stockData.forEach((row, i) => {
                csv += `${row.date},`;
                csv += `${currentIndicators.rsi[i] || ''},`;
                csv += `${currentIndicators.macd.macd[i] || ''},${currentIndicators.macd.signal[i] || ''},${currentIndicators.macd.histogram[i] || ''},`;
                csv += `${currentIndicators.kdj.k[i] || ''},${currentIndicators.kdj.d[i] || ''},${currentIndicators.kdj.j[i] || ''},`;
                csv += `${currentIndicators.wr[i] || ''},${currentIndicators.cci[i] || ''},${currentIndicators.dmi.adx[i] || ''},`;
                csv += `${currentIndicators.sar[i] || ''},${currentIndicators.trix[i] || ''},${currentIndicators.atr[i] || ''},`;
                csv += `${currentIndicators.mom[i] || ''},${currentIndicators.mfi[i] || ''},${currentIndicators.obv[i] || ''},`;
                csv += `${currentIndicators.vr[i] || ''},${currentIndicators.brar.br[i] || ''},${currentIndicators.brar.ar[i] || ''},${currentIndicators.cr[i] || ''}\n`;
            });
            
            downloadFile(csv, `${currentSymbol}_indicators.csv`, 'text/csv');
        }
        
        // ä¸‹è½½Kçº¿æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰
        function downloadKlineData() {
            console.log('downloadKlineData è¢«è°ƒç”¨');
            if (!stockData) {
                alert('âŒ è¯·å…ˆé€‰æ‹©è‚¡ç¥¨/åŸºé‡‘å¹¶è·å–æ•°æ®åå†ä¸‹è½½ï¼');
                return;
            }
            
            let csv = 'Date,Open,High,Low,Close,Volume\n';
            stockData.forEach(row => {
                csv += `${row.date},${row.open},${row.high},${row.low},${row.close},${row.volume}\n`;
            });
            
            downloadFile(csv, `${currentSymbol}_kline.csv`, 'text/csv');
        }
        
        // ä¸‹è½½JSONæ ¼å¼
        function downloadJSON() {
            console.log('downloadJSON è¢«è°ƒç”¨');
            if (!stockData || !currentIndicators) {
                alert('âŒ è¯·å…ˆé€‰æ‹©è‚¡ç¥¨/åŸºé‡‘å¹¶è·å–æ•°æ®åå†ä¸‹è½½ï¼');
                return;
            }
            
            const data = {
                symbol: currentSymbol,
                downloadTime: new Date().toISOString(),
                klineData: stockData,
                indicators: currentIndicators
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, `${currentSymbol}_data.json`, 'application/json');
        }
        
        // ç”Ÿæˆåˆ†ææŠ¥å‘Šï¼ˆTXTæ ¼å¼ï¼‰
        function downloadReport() {
            console.log('downloadReport è¢«è°ƒç”¨');
            if (!stockData || !currentIndicators) {
                alert('âŒ è¯·å…ˆé€‰æ‹©è‚¡ç¥¨/åŸºé‡‘å¹¶è·å–æ•°æ®åå†ä¸‹è½½ï¼');
                return;
            }
            
            const latest = stockData[stockData.length - 1];
            const previous = stockData[stockData.length - 2];
            const changePercent = ((latest.close - previous.close) / previous.close * 100).toFixed(2);
            
            let report = `è‚¡ç¥¨åˆ†ææŠ¥å‘Š\n`;
            report += `=====================================\n\n`;
            report += `è‚¡ç¥¨ä»£ç : ${currentSymbol}\n`;
            report += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n`;
            report += `æ•°æ®å‘¨æœŸ: ${stockData[0].date} è‡³ ${latest.date}\n`;
            report += `æ•°æ®æ¡æ•°: ${stockData.length}\n\n`;
            
            report += `æœ€æ–°è¡Œæƒ…\n`;
            report += `-------------------------------------\n`;
            report += `æœ€æ–°ä»·: ${latest.close.toFixed(2)}\n`;
            report += `æ¶¨è·Œå¹…: ${changePercent}%\n`;
            report += `å¼€ç›˜ä»·: ${latest.open.toFixed(2)}\n`;
            report += `æœ€é«˜ä»·: ${latest.high.toFixed(2)}\n`;
            report += `æœ€ä½ä»·: ${latest.low.toFixed(2)}\n`;
            report += `æˆäº¤é‡: ${(latest.volume / 1000000).toFixed(2)}M\n\n`;
            
            report += `æŠ€æœ¯æŒ‡æ ‡\n`;
            report += `-------------------------------------\n`;
            const lastIdx = stockData.length - 1;
            report += `RSI(14): ${currentIndicators.rsi[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `MACD: ${currentIndicators.macd.macd[lastIdx]?.toFixed(4) || 'N/A'}\n`;
            report += `KDJ K: ${currentIndicators.kdj.k[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `KDJ D: ${currentIndicators.kdj.d[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `KDJ J: ${currentIndicators.kdj.j[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `WR(14): ${currentIndicators.wr[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `CCI(14): ${currentIndicators.cci[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `ATR(14): ${currentIndicators.atr[lastIdx]?.toFixed(2) || 'N/A'}\n\n`;
            
            report += `å‡çº¿ç³»ç»Ÿ\n`;
            report += `-------------------------------------\n`;
            report += `MA5: ${currentIndicators.ma5[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `MA10: ${currentIndicators.ma10[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `MA20: ${currentIndicators.ma20[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `MA30: ${currentIndicators.ma30[lastIdx]?.toFixed(2) || 'N/A'}\n`;
            report += `MA60: ${currentIndicators.ma60[lastIdx]?.toFixed(2) || 'N/A'}\n\n`;
            
            report += `=====================================\n`;
            report += `æŠ¥å‘Šç»“æŸ\n`;
            
            downloadFile(report, `${currentSymbol}_report.txt`, 'text/plain');
        }
        
        // ä¸‹è½½æ‰€æœ‰å›¾è¡¨ï¼ˆPNGæ ¼å¼ï¼‰
        async function downloadAllCharts() {
            console.log('downloadAllCharts è¢«è°ƒç”¨');
            if (!stockData || !currentIndicators) {
                alert('âŒ è¯·å…ˆé€‰æ‹©è‚¡ç¥¨/åŸºé‡‘å¹¶è·å–æ•°æ®åå†ä¸‹è½½å›¾è¡¨ï¼');
                return;
            }
            
            // æŠ€æœ¯æŒ‡æ ‡æ ‡ç­¾é¡µçš„å›¾è¡¨
            const technicalCharts = [
                'macdChart', 'kdjChart', 'rsiChart', 'wrChart', 'cciChart', 
                'dmiChart', 'sarChart', 'trixChart', 'atrChart', 'stochChart',
                'momChart', 'mfiChart', 'ichimokuChart',
                'rocChart', 'biasChart', 'psyChart', 'emvChart', 'aroonChart',
                'dmaChart', 'expmaChart'
            ];
            
            // é‡ä»·åˆ†ææ ‡ç­¾é¡µçš„å›¾è¡¨
            const volumeCharts = [
                'volumeChart', 'obvChart', 'volumeRatioChart', 'vrChart', 
                'brarChart', 'crChart', 'adlChart'
            ];
            
            const chartIds = [...technicalCharts, ...volumeCharts];
            
            const chartNames = {
                'macdChart': 'MACDæŒ‡æ ‡',
                'kdjChart': 'KDJæŒ‡æ ‡',
                'rsiChart': 'RSIæŒ‡æ ‡',
                'wrChart': 'WRæŒ‡æ ‡',
                'cciChart': 'CCIæŒ‡æ ‡',
                'dmiChart': 'DMIæŒ‡æ ‡',
                'sarChart': 'SARæŒ‡æ ‡',
                'trixChart': 'TRIXæŒ‡æ ‡',
                'atrChart': 'ATRæŒ‡æ ‡',
                'stochChart': 'StochæŒ‡æ ‡',
                'momChart': 'MOMæŒ‡æ ‡',
                'mfiChart': 'MFIæŒ‡æ ‡',
                'ichimokuChart': 'ä¸€ç›®å‡è¡¡è¡¨',
                'volumeChart': 'æˆäº¤é‡',
                'obvChart': 'OBVæŒ‡æ ‡',
                'volumeRatioChart': 'é‡æ¯”',
                'vrChart': 'VRæŒ‡æ ‡',
                'brarChart': 'BRARæŒ‡æ ‡',
                'crChart': 'CRæŒ‡æ ‡',
                'adlChart': 'ADLæŒ‡æ ‡',
                'rocChart': 'ROCå˜åŠ¨ç‡',
                'biasChart': 'BIASä¹–ç¦»ç‡',
                'psyChart': 'PSYå¿ƒç†çº¿',
                'emvChart': 'EMVç®€æ˜“æ³¢åŠ¨',
                'aroonChart': 'Arooné˜¿éš†æŒ‡æ ‡',
                'dmaChart': 'DMAå¹³è¡Œçº¿å·®',
                'expmaChart': 'EXPMAæŒ‡æ•°å‡çº¿'
            };
            
            alert('ğŸ“¥ å¼€å§‹è‡ªåŠ¨ä¸‹è½½å›¾è¡¨...\n\nç³»ç»Ÿå°†è‡ªåŠ¨åˆ‡æ¢æ ‡ç­¾é¡µå¹¶ä¸‹è½½æ‰€æœ‰å›¾è¡¨ï¼Œè¯·ç¨å€™ç‰‡åˆ»ã€‚');
            
            let downloadCount = 0;
            const totalCharts = chartIds.length;
            
            // ä¸‹è½½æŒ‡å®šå›¾è¡¨çš„è¾…åŠ©å‡½æ•°
            const downloadChart = (chartId) => {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        try {
                            const canvas = document.getElementById(chartId);
                            const chartKey = chartId.replace('Chart', '');
                            
                            if (canvas && canvas.width > 0 && canvas.height > 0) {
                                const url = canvas.toDataURL('image/png', 1.0);
                                
                                if (url && url.length > 100) {
                                    const link = document.createElement('a');
                                    link.href = url;
                                    link.download = `${currentSymbol}_${chartNames[chartId]}.png`;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    downloadCount++;
                                    console.log(`âœ… å·²ä¸‹è½½: ${chartNames[chartId]} (${downloadCount}/${totalCharts})`);
                                    resolve(true);
                                } else {
                                    console.warn(`âš ï¸ è·³è¿‡: ${chartNames[chartId]} (æœªæ¸²æŸ“)`);
                                    resolve(false);
                                }
                            } else {
                                console.warn(`âš ï¸ è·³è¿‡: ${chartNames[chartId]} (Canvasæ— æ•ˆ)`);
                                resolve(false);
                            }
                        } catch (error) {
                            console.error(`âŒ ä¸‹è½½å¤±è´¥: ${chartNames[chartId]}`, error);
                            resolve(false);
                        }
                    }, 300);
                });
            };
            
            // åˆ†æ­¥ä¸‹è½½æµç¨‹
            (async () => {
                // æ­¥éª¤1: åˆ‡æ¢åˆ°æŠ€æœ¯æŒ‡æ ‡é¡µå¹¶ä¸‹è½½
                console.log('ğŸ“Š æ­¥éª¤1: ä¸‹è½½æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨...');
                const techTab = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent.includes('æŠ€æœ¯æŒ‡æ ‡'));
                if (techTab) {
                    techTab.click();
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    for (const chartId of technicalCharts) {
                        await downloadChart(chartId);
                    }
                }
                
                // æ­¥éª¤2: åˆ‡æ¢åˆ°é‡ä»·åˆ†æé¡µå¹¶ä¸‹è½½
                console.log('ğŸ“Š æ­¥éª¤2: ä¸‹è½½é‡ä»·åˆ†æå›¾è¡¨...');
                const volumeTab = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent.includes('é‡ä»·åˆ†æ'));
                if (volumeTab) {
                    volumeTab.click();
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    for (const chartId of volumeCharts) {
                        await downloadChart(chartId);
                    }
                }
                
                // å®Œæˆæç¤º
                setTimeout(() => {
                    if (downloadCount > 0) {
                        alert(`âœ… ä¸‹è½½å®Œæˆï¼\n\næˆåŠŸä¸‹è½½ ${downloadCount} å¼ å›¾è¡¨ã€‚`);
                    } else {
                        alert('âŒ æœªèƒ½ä¸‹è½½å›¾è¡¨\n\nè¯·ç¡®ä¿å·²åŠ è½½è‚¡ç¥¨æ•°æ®ï¼Œå¹¶ä¸”å›¾è¡¨å·²æ­£å¸¸æ˜¾ç¤ºã€‚');
                    }
                }, 500);
            })();
        }
        
        // é€šç”¨ä¸‹è½½å‡½æ•°
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            // å¤„ç†æ¢è¡Œç¬¦
            errorDiv.innerHTML = message.replace(/\n/g, '<br>');
            errorDiv.classList.add('active');
            
            // æ»šåŠ¨åˆ°é”™è¯¯ä½ç½®
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 10ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => errorDiv.classList.remove('active'), 10000);
        }

        // å¿«é€Ÿé€‰æ‹©å‘¨æœŸ
        function quickSelectPeriod(klineType, range) {
            if (!document.getElementById('stockCode').value.trim()) {
                showError('è¯·å…ˆé€‰æ‹©æˆ–è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            document.getElementById('klineType').value = klineType;
            document.getElementById('timeRange').value = range;
            fetchStockData();
        }

        // è·å–è‚¡ç¥¨æ•°æ®
        async function fetchStockData() {
            const stockCode = document.getElementById('stockCode').value.trim();
            const dataSource = document.getElementById('dataSource').value;
            const timeRange = document.getElementById('timeRange').value;
            const klineType = document.getElementById('klineType').value;

            if (!stockCode) {
                showError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            console.log('=== å¼€å§‹è·å–æ•°æ® ===');
            console.log('è‚¡ç¥¨ä»£ç :', stockCode);
            console.log('æ•°æ®æº:', dataSource);
            console.log('Kçº¿å‘¨æœŸ:', klineType);
            console.log('æ—¶é—´èŒƒå›´:', timeRange);

            // æ ¹æ®Kçº¿ç±»å‹è°ƒæ•´æ—¶é—´èŒƒå›´
            let adjustedRange = timeRange;
            if (klineType.includes('m')) {
                // åˆ†æ—¶æ•°æ®ï¼Œé™åˆ¶æ—¶é—´èŒƒå›´
                if (!['1d', '5d', '1mo'].includes(timeRange)) {
                    adjustedRange = '5d';
                    console.log('âš ï¸ åˆ†æ—¶æ•°æ®è‡ªåŠ¨è°ƒæ•´æ—¶é—´èŒƒå›´ä¸º5å¤©');
                }
            }

            document.getElementById('loading').classList.add('active');
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('results').style.display = 'none';

            try {
                let data;
                if (dataSource === 'yahoo') {
                    data = await fetchFromYahoo(stockCode, adjustedRange, klineType);
                } else if (dataSource === 'sina') {
                    data = await fetchFromSina(stockCode);
                } else {
                    showError('è¯¥æ•°æ®æºæš‚æœªå®ç°ï¼Œè¯·é€‰æ‹©Yahoo Financeæˆ–æ–°æµªè´¢ç»');
                    return;
                }

                if (data && data.length > 0) {
                    stockData = data;
                    analyzeAndDisplay(data);
                    // æ¸…é™¤é”™è¯¯ä¿¡æ¯
                    document.getElementById('errorMsg').classList.remove('active');
                } else {
                    showError('æœªèƒ½è·å–æ•°æ®ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®');
                }
            } catch (error) {
                console.error('Error:', error);
                let errorMsg = error.message || 'æ•°æ®è·å–å¤±è´¥';
                
                // æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º
                if (errorMsg.includes('HTTP error')) {
                    errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•';
                } else if (errorMsg.includes('æœªæ‰¾åˆ°æ•°æ®')) {
                    errorMsg = `è‚¡ç¥¨ä»£ç "${stockCode}"å¯èƒ½ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥ï¼š\n- ç¾è‚¡ç›´æ¥è¾“å…¥ä»£ç ï¼ˆå¦‚ AAPLï¼‰\n- Aè‚¡ä¸Šæµ·åŠ  .SSï¼ˆå¦‚ 600519.SSï¼‰\n- Aè‚¡æ·±åœ³åŠ  .SZï¼ˆå¦‚ 000001.SZï¼‰\n- æ¸¯è‚¡åŠ  .HKï¼ˆå¦‚ 0700.HKï¼‰\n- åŠ å¯†è´§å¸åŠ  -USDï¼ˆå¦‚ BTC-USD, ETH-USDï¼‰`;
                }
                
                showError(errorMsg);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('searchBtn').disabled = false;
            }
        }

        // æ•°æ®æºé…ç½®ï¼ˆåªä¿ç•™æœ€ç¨³å®šçš„ï¼‰
        const dataSources = [
            {
                name: 'Yahoo Finance via CORS Proxy',
                fetch: async (symbol, range) => {
                    const period1 = Math.floor(Date.now() / 1000) - getRangeSeconds(range);
                    const period2 = Math.floor(Date.now() / 1000);
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=1d`;
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return await response.json();
                }
            }
        ];

        // å¤šæ•°æ®æºé…ç½®ï¼ˆæ‰©å±•æ›´å¤šå¯é ä»£ç†ï¼‰
        const multiDataSources = [
            {
                name: 'ç›´æ¥è®¿é—®ï¼ˆæ— ä»£ç†ï¼‰',
                getUrl: (url) => url,
                timeout: 8000
            },
            {
                name: 'AllOrigins Proxy',
                getUrl: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                timeout: 15000
            },
            {
                name: 'CORS Proxy',
                getUrl: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                timeout: 12000
            },
            {
                name: 'ThingProxy',
                getUrl: (url) => `https://thingproxy.freeboard.io/fetch/${url}`,
                timeout: 12000
            },
            {
                name: 'Cloudflare Worker',
                getUrl: (url) => `https://cors-anywhere-cf.herokuapp.com/${url}`,
                timeout: 10000
            },
            {
                name: 'CORS.SH',
                getUrl: (url) => `https://cors.sh/${url}`,
                timeout: 10000
            },
            {
                name: 'JSONProxy',
                getUrl: (url) => `https://jsonp.afeld.me/?url=${encodeURIComponent(url)}`,
                timeout: 10000
            }
        ];

        // è·å–æ•°æ®ï¼ˆæ”¯æŒæ‰€æœ‰Kçº¿å‘¨æœŸï¼Œå¤šæ•°æ®æºï¼‰
        async function fetchFromYahoo(symbol, range, interval = '1d') {
            const klineTypeMap = {
                '1m': '1åˆ†é’Ÿ',
                '5m': '5åˆ†é’Ÿ',
                '15m': '15åˆ†é’Ÿ',
                '30m': '30åˆ†é’Ÿ',
                '60m': '60åˆ†é’Ÿ',
                '120m': '120åˆ†é’Ÿ',
                '1d': 'æ—¥K',
                '1wk': 'å‘¨K',
                '1mo': 'æœˆK'
            };
            
            console.log(`ğŸ“Š æ­£åœ¨è·å– ${symbol} çš„${klineTypeMap[interval]}æ•°æ®...`);
            
            const period1 = Math.floor(Date.now() / 1000) - getRangeSeconds(range);
            const period2 = Math.floor(Date.now() / 1000);
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=${interval}`;
            
            // å°è¯•å¤šä¸ªæ•°æ®æº
            let lastError = null;
            for (let i = 0; i < multiDataSources.length; i++) {
                try {
                    const source = multiDataSources[i];
                    console.log(`ğŸ”„ å°è¯•æ•°æ®æº ${i + 1}/${multiDataSources.length}: ${source.name} (è¶…æ—¶${source.timeout}ms)`);
                    
                    const proxyUrl = source.getUrl(yahooUrl);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), source.timeout);
                    
                    const response = await fetch(proxyUrl, { 
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const json = await response.json();
                    
                    if (json.chart && json.chart.result && json.chart.result[0]) {
                        const result = json.chart.result[0];
                        
                        if (!result.timestamp || result.timestamp.length === 0) {
                            throw new Error('æ²¡æœ‰å¯ç”¨çš„å†å²æ•°æ®');
                        }
                        
                        const timestamps = result.timestamp;
                        const quotes = result.indicators.quote[0];
                        
                        // æ ¹æ®å‘¨æœŸæ ¼å¼åŒ–æ—¶é—´
                        const formatTime = (timestamp) => {
                            const date = new Date(timestamp * 1000);
                            if (interval.includes('m')) {
                                // åˆ†é’Ÿçº§åˆ«æ˜¾ç¤º æœˆ-æ—¥ æ—¶:åˆ†
                                return date.toLocaleString('zh-CN', { 
                                    month: '2-digit', 
                                    day: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                }).replace(/\//g, '-');
                            } else if (interval === '1wk') {
                                return date.toISOString().split('T')[0];
                            } else if (interval === '1mo') {
                                return date.toISOString().substring(0, 7);
                            } else {
                                return date.toISOString().split('T')[0];
                            }
                        };
                        
                        const data = timestamps.map((time, i) => ({
                            date: formatTime(time),
                            timestamp: time,
                            open: quotes.open[i] || quotes.close[i],
                            high: quotes.high[i] || quotes.close[i],
                            low: quotes.low[i] || quotes.close[i],
                            close: quotes.close[i],
                            volume: quotes.volume[i] || 0
                        })).filter(d => d.close !== null && d.close !== undefined);
                        
                        if (data.length === 0) {
                            throw new Error('è¿‡æ»¤åæ²¡æœ‰æœ‰æ•ˆæ•°æ®');
                        }
                        
                        console.log(`âœ… æˆåŠŸï¼ä½¿ç”¨ ${source.name}ï¼Œè·å– ${data.length} æ¡${klineTypeMap[interval]}æ•°æ®`);
                        
                        // æ›´æ–°å‘¨æœŸæ˜¾ç¤º
                        const rangeMap = {
                            '1d': '1å¤©', '5d': '5å¤©', '1mo': '1ä¸ªæœˆ', '3mo': '3ä¸ªæœˆ',
                            '6mo': '6ä¸ªæœˆ', '1y': '1å¹´', '2y': '2å¹´', '5y': '5å¹´'
                        };
                        document.getElementById('currentPeriodDisplay').textContent = 
                            `${klineTypeMap[interval]} - ${rangeMap[range] || range}`;
                        document.getElementById('dataCountDisplay').textContent = data.length + ' æ¡';
                        
                        // é™é»˜è·å–åŸºæœ¬é¢ä¿¡æ¯ï¼ˆä»…æ—¥KåŠä»¥ä¸Šå‘¨æœŸï¼‰
                        if (!interval.includes('m')) {
                            fetchCompanyInfo(symbol).catch(() => {
                                displayBasicInfo(symbol);
                            });
                        } else {
                            displayBasicInfo(symbol);
                        }
                        
                        return data;
                    } else if (json.chart && json.chart.error) {
                        throw new Error(json.chart.error.description || 'æ•°æ®è·å–å¤±è´¥');
                    }
                    
                    throw new Error('æœªæ‰¾åˆ°æ•°æ®');
                } catch (error) {
                    lastError = error;
                    const errorMsg = error.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶' : error.message;
                    console.warn(`âŒ ${multiDataSources[i].name} å¤±è´¥: ${errorMsg}`);
                    
                    // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªæ•°æ®æºï¼Œç»§ç»­å°è¯•
                    if (i < multiDataSources.length - 1) {
                        console.log('â­ï¸ ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ•°æ®æº...');
                        await new Promise(resolve => setTimeout(resolve, 500)); // çŸ­æš‚å»¶è¿Ÿ
                        continue;
                    }
                }
            }
            
            // æ‰€æœ‰æ•°æ®æºéƒ½å¤±è´¥
            const errorDetail = lastError ? ` (æœ€åé”™è¯¯: ${lastError.message})` : '';
            console.error('ğŸš« æ‰€æœ‰æ•°æ®æºå‡å¤±è´¥', errorDetail);
            throw new Error(`æ‰€æœ‰${multiDataSources.length}ä¸ªæ•°æ®æºéƒ½æ— æ³•è®¿é—®${errorDetail}\n\nå¯èƒ½åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. é˜²ç«å¢™æˆ–ä»£ç†é™åˆ¶\n3. Yahoo Finance APIæš‚æ—¶ä¸å¯ç”¨\n4. è‚¡ç¥¨ä»£ç ä¸æ­£ç¡®\n\nå»ºè®®ï¼šç¨åé‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè®¾ç½®`);
        }

        // è·å–å…¬å¸åŸºæœ¬é¢ä¿¡æ¯ï¼ˆå¸¦å¤šæ•°æ®æºï¼Œé™é»˜å¤±è´¥ï¼‰
        async function fetchCompanyInfo(symbol) {
            // åªä½¿ç”¨æˆåŠŸç‡é«˜çš„ä»£ç†
            const fundamentalSources = [
                {
                    name: 'Yahoo Quote via Proxy 1',
                    fetch: async () => {
                        const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail,defaultKeyStatistics,financialData,price`;
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                        const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return await response.json();
                    }
                }
            ];
            
            for (let i = 0; i < fundamentalSources.length; i++) {
                try {
                    const json = await fundamentalSources[i].fetch();
                    
                    if (json.quoteSummary && json.quoteSummary.result && json.quoteSummary.result[0]) {
                        const data = json.quoteSummary.result[0];
                        console.log(`âœ… åŸºæœ¬é¢æ•°æ®è·å–æˆåŠŸ`);
                        displayCompanyInfo(data, symbol);
                        displayFundamentals(data);
                        return;
                    }
                } catch (error) {
                    // é™é»˜å¤±è´¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    displayBasicInfo(symbol);
                }
            }
        }

        // æ˜¾ç¤ºå…¬å¸åŸºæœ¬ä¿¡æ¯
        function displayCompanyInfo(data, symbol) {
            const price = data.price || {};
            const summary = data.summaryDetail || {};
            
            const html = `
                <div class="company-info-item">
                    <div class="company-info-label">è‚¡ç¥¨åç§°</div>
                    <div class="company-info-value">${price.shortName || symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">è‚¡ç¥¨ä»£ç </div>
                    <div class="company-info-value">${symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">äº¤æ˜“æ‰€</div>
                    <div class="company-info-value">${price.exchangeName || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">è´§å¸</div>
                    <div class="company-info-value">${price.currency || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">å¸‚åœºç±»å‹</div>
                    <div class="company-info-value">${price.quoteType || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">52å‘¨æœ€é«˜</div>
                    <div class="company-info-value">${summary.fiftyTwoWeekHigh?.fmt || '-'}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">52å‘¨æœ€ä½</div>
                    <div class="company-info-value">${summary.fiftyTwoWeekLow?.fmt || '-'}</div>
                </div>
            `;
            
            document.getElementById('companyInfo').innerHTML = html;
        }

        // æ˜¾ç¤ºåŸºæœ¬é¢æ•°æ®
        function displayFundamentals(data) {
            const stats = data.defaultKeyStatistics || {};
            const financial = data.financialData || {};
            const summary = data.summaryDetail || {};
            
            const fundamentals = [
                {
                    label: 'å¸‚ç›ˆç‡ (P/E)',
                    value: stats.trailingPE?.fmt || summary.trailingPE?.fmt || '-',
                    desc: 'è‚¡ä»·ä¸æ¯è‚¡æ”¶ç›Šçš„æ¯”ç‡'
                },
                {
                    label: 'å¸‚å‡€ç‡ (P/B)',
                    value: stats.priceToBook?.fmt || '-',
                    desc: 'è‚¡ä»·ä¸æ¯è‚¡å‡€èµ„äº§çš„æ¯”ç‡'
                },
                {
                    label: 'å¸‚å€¼',
                    value: summary.marketCap?.fmt || '-',
                    desc: 'å…¬å¸æ€»å¸‚å€¼'
                },
                {
                    label: 'æ¯è‚¡æ”¶ç›Š (EPS)',
                    value: stats.trailingEps?.fmt || '-',
                    desc: 'å…¬å¸ç›ˆåˆ©èƒ½åŠ›æŒ‡æ ‡'
                },
                {
                    label: 'è‚¡æ¯ç‡',
                    value: summary.dividendYield?.fmt ? (parseFloat(summary.dividendYield.raw) * 100).toFixed(2) + '%' : '-',
                    desc: 'å¹´åº¦è‚¡æ¯/è‚¡ä»·'
                },
                {
                    label: 'å‡€èµ„äº§æ”¶ç›Šç‡ (ROE)',
                    value: financial.returnOnEquity?.fmt || '-',
                    desc: 'å‡€åˆ©æ¶¦/å‡€èµ„äº§'
                },
                {
                    label: 'æ€»èµ„äº§æ”¶ç›Šç‡ (ROA)',
                    value: financial.returnOnAssets?.fmt || '-',
                    desc: 'å‡€åˆ©æ¶¦/æ€»èµ„äº§'
                },
                {
                    label: 'è¥ä¸šæ”¶å…¥',
                    value: financial.totalRevenue?.fmt || '-',
                    desc: 'å…¬å¸æ€»è¥æ”¶'
                },
                {
                    label: 'æ¯›åˆ©ç‡',
                    value: financial.grossMargins?.fmt || '-',
                    desc: 'æ¯›åˆ©æ¶¦/è¥ä¸šæ”¶å…¥'
                },
                {
                    label: 'å‡€åˆ©ç‡',
                    value: financial.profitMargins?.fmt || '-',
                    desc: 'å‡€åˆ©æ¶¦/è¥ä¸šæ”¶å…¥'
                },
                {
                    label: 'è¥æ”¶å¢é•¿ç‡',
                    value: financial.revenueGrowth?.fmt || '-',
                    desc: 'åŒæ¯”è¥æ”¶å¢é•¿'
                },
                {
                    label: 'è‡ªç”±ç°é‡‘æµ',
                    value: financial.freeCashflow?.fmt || '-',
                    desc: 'å…¬å¸å¯è‡ªç”±æ”¯é…ç°é‡‘'
                },
                {
                    label: 'æµé€šè‚¡',
                    value: stats.floatShares?.fmt || '-',
                    desc: 'å¯æµé€šçš„è‚¡ç¥¨æ•°é‡'
                },
                {
                    label: 'æ€»è‚¡æœ¬',
                    value: stats.sharesOutstanding?.fmt || '-',
                    desc: 'å…¬å¸å‘è¡Œçš„æ€»è‚¡æ•°'
                },
                {
                    label: 'èµ„äº§è´Ÿå€ºç‡',
                    value: financial.debtToEquity?.fmt || '-',
                    desc: 'æ€»è´Ÿå€º/è‚¡ä¸œæƒç›Š'
                },
                {
                    label: 'æµåŠ¨æ¯”ç‡',
                    value: financial.currentRatio?.fmt || '-',
                    desc: 'æµåŠ¨èµ„äº§/æµåŠ¨è´Ÿå€º'
                }
            ];
            
            const html = fundamentals.map(item => `
                <div class="fundamental-item">
                    <div class="fundamental-label">${item.label}</div>
                    <div class="fundamental-value">${item.value}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">${item.desc}</div>
                </div>
            `).join('');
            
            document.getElementById('fundamentalsData').innerHTML = html;
        }

        // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ï¼ˆå½“æ— æ³•è·å–è¯¦ç»†ä¿¡æ¯æ—¶ï¼‰
        function displayBasicInfo(symbol) {
            const html = `
                <div class="company-info-item">
                    <div class="company-info-label">è‚¡ç¥¨ä»£ç </div>
                    <div class="company-info-value">${symbol}</div>
                </div>
                <div class="company-info-item">
                    <div class="company-info-label">æç¤º</div>
                    <div class="company-info-value">åŸºæœ¬é¢æ•°æ®åŠ è½½ä¸­æˆ–æš‚æ— æ•°æ®</div>
                </div>
            `;
            document.getElementById('companyInfo').innerHTML = html;
            document.getElementById('fundamentalsData').innerHTML = '<div class="info-box"><p>æš‚æ—¶æ— æ³•è·å–åŸºæœ¬é¢æ•°æ®</p></div>';
        }

        // ä»æ–°æµªè´¢ç»è·å–æ•°æ®
        async function fetchFromSina(symbol) {
            try {
                // è½¬æ¢è‚¡ç¥¨ä»£ç æ ¼å¼
                let sinaCode = symbol.replace('.SS', '').replace('.SZ', '');
                if (symbol.includes('.SS')) {
                    sinaCode = 'sh' + sinaCode;
                } else if (symbol.includes('.SZ')) {
                    sinaCode = 'sz' + sinaCode;
                } else {
                    sinaCode = 'sh' + sinaCode; // é»˜è®¤ä¸Šæµ·
                }
                
                // æ³¨æ„ï¼šç”±äºè·¨åŸŸé™åˆ¶ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨ä»£ç†æˆ–JSONP
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶å¯èƒ½éœ€è¦åç«¯ä»£ç†
                showError('æ–°æµªè´¢ç»éœ€è¦åç«¯ä»£ç†æ”¯æŒï¼Œè¯·ä½¿ç”¨Yahoo Financeæ•°æ®æº');
                return null;
            } catch (error) {
                console.error('Sina Finance error:', error);
                throw error;
            }
        }

        function getRangeSeconds(range) {
            const ranges = {
                '1mo': 30 * 24 * 3600,
                '3mo': 90 * 24 * 3600,
                '6mo': 180 * 24 * 3600,
                '1y': 365 * 24 * 3600,
                '2y': 730 * 24 * 3600,
                '5y': 1825 * 24 * 3600
            };
            return ranges[range] || ranges['3mo'];
        }

        // åˆ†æå¹¶æ˜¾ç¤ºæ•°æ®
        function analyzeAndDisplay(data) {
            // è®¡ç®—æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡
            const indicators = calculateAllIndicators(data);
            
            // å­˜å‚¨åˆ°å…¨å±€å˜é‡ä»¥ä¾¿ä¸‹è½½
            currentIndicators = indicators;
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('results').style.display = 'block';
            
            // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
            displayStats(data, indicators);
            
            // æ˜¾ç¤ºæŠ€æœ¯ä¿¡å·
            displaySignals(data, indicators);
            
            // ç»˜åˆ¶æ‰€æœ‰å›¾è¡¨
            drawAllCharts(data, indicators);
            // é™„åŠ æ¯ä¸ªå›¾è¡¨çš„æ”¾å¤§/è¿˜åŸæ§åˆ¶
            attachChartControls();
            
            // å½¢æ€è¯†åˆ«
            displayPatterns(data);
            
            // æ»šåŠ¨åˆ°ç»“æœ
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // è®¡ç®—æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡ï¼ˆå®Œæ•´ç‰ˆï¼‰
        function calculateAllIndicators(data) {
            return {
                // å‡çº¿ç³»ç»Ÿ
                ma5: calculateMA(data, 5),
                ma10: calculateMA(data, 10),
                ma20: calculateMA(data, 20),
                ma30: calculateMA(data, 30),
                ma60: calculateMA(data, 60),
                ma120: calculateMA(data, 120),
                ema12: calculateEMA(data, 12),
                ema26: calculateEMA(data, 26),
                // è¶‹åŠ¿æŒ‡æ ‡
                macd: calculateMACD(data),
                bollinger: calculateBollinger(data, 20, 2),
                sar: calculateSAR(data),
                trix: calculateTRIX(data),
                // æ‘†åŠ¨æŒ‡æ ‡
                kdj: calculateKDJ(data),
                rsi: calculateRSI(data, 14),
                rsi6: calculateRSI(data, 6),
                rsi12: calculateRSI(data, 12),
                wr: calculateWR(data, 14),
                cci: calculateCCI(data, 14),
                stoch: calculateStoch(data, 14),
                mom: calculateMOM(data, 10),
                // è¶‹å‘æŒ‡æ ‡
                dmi: calculateDMI(data, 14),
                // æˆäº¤é‡èƒ½é‡æŒ‡æ ‡
                obv: calculateOBV(data),
                volumeRatio: calculateVolumeRatio(data),
                vr: calculateVR(data),
                mfi: calculateMFI(data, 14),
                adl: calculateADL(data),
                // æ³¢åŠ¨ç‡æŒ‡æ ‡
                atr: calculateATR(data, 14),
                // äººæ°”æŒ‡æ ‡
                brar: calculateBRAR(data),
                cr: calculateCR(data),
                // ä¸€ç›®å‡è¡¡è¡¨
                ichimoku: calculateIchimoku(data),
                // æ–°å¢é«˜çº§æŒ‡æ ‡
                roc: calculateROC(data, 12),           // å˜åŠ¨ç‡æŒ‡æ ‡
                bias: calculateBIAS(data, 6),          // ä¹–ç¦»ç‡
                psy: calculatePSY(data, 12),           // å¿ƒç†çº¿
                emv: calculateEMV(data, 14),           // ç®€æ˜“æ³¢åŠ¨æŒ‡æ ‡
                wvad: calculateWVAD(data),             // å¨å»‰å˜å¼‚ç¦»æ•£é‡
                mass: calculateMASS(data, 25),         // æ¢…æ–¯çº¿
                dpo: calculateDPO(data, 20),           // åŒºé—´éœ‡è¡çº¿
                roc: calculateROC(data, 12),           // å˜åŠ¨ç‡
                aroon: calculateAroon(data, 25),       // é˜¿éš†æŒ‡æ ‡
                bbw: calculateBBW(data, 20),           // å¸ƒæ—å¸¦å®½åº¦
                env: calculateENV(data, 14, 6),        // ENVåŒ…ç»œçº¿
                mi: calculateMI(data),                 // åŠ¨åŠ›æŒ‡æ ‡
                dma: calculateDMA(data, 10, 50),       // å¹³è¡Œçº¿å·®æŒ‡æ ‡
                expma: calculateEXPMA(data, 12, 50)    // æŒ‡æ•°å¹³æ»‘ç§»åŠ¨å¹³å‡
            };
        }

        // è®¡ç®—MA
        function calculateMA(data, period) {
            const closes = data.map(d => d.close);
            return closes.map((_, i) => {
                if (i < period - 1) return null;
                const slice = closes.slice(i - period + 1, i + 1);
                if (slice.length === 0) return null;
                const sum = slice.reduce((a, b) => a + b, 0);
                return sum / period;
            });
        }

        // è®¡ç®—EMA
        function calculateEMA(data, period) {
            const closes = data.map(d => d.close);
            const k = 2 / (period + 1);
            const ema = [closes[0]];
            for (let i = 1; i < closes.length; i++) {
                ema.push(closes[i] * k + ema[i - 1] * (1 - k));
            }
            return ema;
        }

        // è®¡ç®—MACD
        function calculateMACD(data) {
            const closes = data.map(d => d.close);
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            const dif = ema12.map((val, i) => val - ema26[i]);
            
            // è®¡ç®—DEA (DIFçš„9æ—¥EMA)
            const k = 2 / 10;
            const dea = [dif[0]];
            for (let i = 1; i < dif.length; i++) {
                dea.push(dif[i] * k + dea[i - 1] * (1 - k));
            }
            
            const macd = dif.map((val, i) => (val - dea[i]) * 2);
            return { dif, dea, macd };
        }

        // è®¡ç®—KDJ
        function calculateKDJ(data, period = 9) {
            const rsv = [];
            const k = [50];
            const d = [50];
            const j = [];

            for (let i = 0; i < data.length; i++) {
                const start = Math.max(0, i - period + 1);
                const slice = data.slice(start, i + 1);
                const high = Math.max(...slice.map(d => d.high));
                const low = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                rsv[i] = high === low ? 50 : ((close - low) / (high - low)) * 100;
                
                if (i > 0) {
                    k[i] = k[i - 1] * 2/3 + rsv[i] * 1/3;
                    d[i] = d[i - 1] * 2/3 + k[i] * 1/3;
                }
                j[i] = 3 * k[i] - 2 * d[i];
            }
            
            return { k, d, j };
        }

        // è®¡ç®—RSI
        function calculateRSI(data, period = 14) {
            const closes = data.map(d => d.close);
            const rsi = [];
            
            for (let i = 0; i < closes.length; i++) {
                if (i < period) {
                    rsi.push(null);
                    continue;
                }
                
                let gains = 0, losses = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    const change = closes[j] - closes[j - 1];
                    if (change > 0) gains += change;
                    else losses -= change;
                }
                
                const avgGain = gains / period;
                const avgLoss = losses / period;
                const rs = avgGain / (avgLoss || 1);
                rsi.push(100 - (100 / (1 + rs)));
            }
            
            return rsi;
        }

        // è®¡ç®—å¸ƒæ—å¸¦
        function calculateBollinger(data, period = 20, stdDev = 2) {
            const closes = data.map(d => d.close);
            const middle = [];
            const upper = [];
            const lower = [];

            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    middle.push(null);
                    upper.push(null);
                    lower.push(null);
                    continue;
                }

                const slice = closes.slice(i - period + 1, i + 1);
                if (slice.length === 0) {
                    middle.push(null);
                    upper.push(null);
                    lower.push(null);
                    continue;
                }
                const mean = slice.reduce((a, b) => a + b, 0) / period;
                const variance = slice.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / period;
                const std = Math.sqrt(variance);

                middle.push(mean);
                upper.push(mean + stdDev * std);
                lower.push(mean - stdDev * std);
            }

            return { middle, upper, lower };
        }

        // è®¡ç®—å¨å»‰æŒ‡æ ‡
        function calculateWR(data, period = 14) {
            const wr = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    wr.push(null);
                    continue;
                }
                
                const slice = data.slice(i - period + 1, i + 1);
                const highest = Math.max(...slice.map(d => d.high));
                const lowest = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                wr.push(((highest - close) / (highest - lowest)) * -100);
            }
            return wr;
        }

        // è®¡ç®—CCI
        function calculateCCI(data, period = 14) {
            const cci = [];
            const tp = data.map(d => (d.high + d.low + d.close) / 3);
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    cci.push(null);
                    continue;
                }
                
                const slice = tp.slice(i - period + 1, i + 1);
                if (slice.length === 0) {
                    cci.push(null);
                    continue;
                }
                const ma = slice.reduce((a, b) => a + b, 0) / period;
                const md = slice.reduce((sum, val) => sum + Math.abs(val - ma), 0) / period;
                
                cci.push((tp[i] - ma) / (0.015 * md));
            }
            return cci;
        }

        // è®¡ç®—DMI
        function calculateDMI(data, period = 14) {
            const pdi = [];
            const mdi = [];
            const adx = [];
            const dx = [];
            
            if (data.length < period + 1) {
                return { 
                    pdi: data.map(() => null), 
                    mdi: data.map(() => null), 
                    adx: data.map(() => null) 
                };
            }
            
            let trSum = 0, pdmSum = 0, mdmSum = 0;
            
            for (let i = 1; i < data.length; i++) {
                const tr = Math.max(
                    data[i].high - data[i].low,
                    Math.abs(data[i].high - data[i - 1].close),
                    Math.abs(data[i].low - data[i - 1].close)
                );
                
                const pdm = Math.max(data[i].high - data[i - 1].high, 0);
                const mdm = Math.max(data[i - 1].low - data[i].low, 0);
                
                if (i < period) {
                    trSum += tr;
                    pdmSum += pdm;
                    mdmSum += mdm;
                    pdi.push(null);
                    mdi.push(null);
                    adx.push(null);
                    continue;
                }
                
                if (i === period) {
                    trSum += tr;
                    pdmSum += pdm;
                    mdmSum += mdm;
                } else {
                    trSum = trSum - trSum / period + tr;
                    pdmSum = pdmSum - pdmSum / period + pdm;
                    mdmSum = mdmSum - mdmSum / period + mdm;
                }
                
                const pdiVal = (pdmSum / (trSum || 1)) * 100;
                const mdiVal = (mdmSum / (trSum || 1)) * 100;
                const dxVal = Math.abs(pdiVal - mdiVal) / ((pdiVal + mdiVal) || 1) * 100;
                
                pdi.push(pdiVal);
                mdi.push(mdiVal);
                dx.push(dxVal);
                
                if (i >= period * 2 - 1) {
                    const adxSlice = dx.slice(i - period + 1, i + 1).filter(v => v !== null);
                    if (adxSlice.length > 0) {
                        adx.push(adxSlice.reduce((a, b) => a + b, 0) / adxSlice.length);
                    } else {
                        adx.push(null);
                    }
                } else {
                    adx.push(null);
                }
            }
            
            return { pdi, mdi, adx };
        }

        // è®¡ç®—OBV
        function calculateOBV(data) {
            const obv = [0];
            for (let i = 1; i < data.length; i++) {
                if (data[i].close > data[i - 1].close) {
                    obv.push(obv[i - 1] + data[i].volume);
                } else if (data[i].close < data[i - 1].close) {
                    obv.push(obv[i - 1] - data[i].volume);
                } else {
                    obv.push(obv[i - 1]);
                }
            }
            return obv;
        }

        // è®¡ç®—é‡æ¯”
        function calculateVolumeRatio(data) {
            const ratio = [];
            for (let i = 0; i < data.length; i++) {
                if (i < 5) {
                    ratio.push(null);
                    continue;
                }
                const avgVolume = data.slice(i - 5, i).reduce((sum, d) => sum + d.volume, 0) / 5;
                ratio.push(data[i].volume / (avgVolume || 1));
            }
            return ratio;
        }

        // è®¡ç®—SAR (æŠ›ç‰©çº¿æŒ‡æ ‡)
        function calculateSAR(data, af = 0.02, maxAf = 0.2) {
            const sar = [];
            if (data.length < 2) return data.map(() => null);
            
            let isUpTrend = data[1].close > data[0].close;
            let currentSar = isUpTrend ? data[0].low : data[0].high;
            let ep = isUpTrend ? data[0].high : data[0].low;
            let currentAf = af;
            
            sar.push(currentSar);
            
            for (let i = 1; i < data.length; i++) {
                const prevSar = currentSar;
                currentSar = prevSar + currentAf * (ep - prevSar);
                
                if (isUpTrend) {
                    currentSar = Math.min(currentSar, data[i - 1].low, i > 1 ? data[i - 2].low : data[i - 1].low);
                    if (data[i].low < currentSar) {
                        isUpTrend = false;
                        currentSar = ep;
                        ep = data[i].low;
                        currentAf = af;
                    } else {
                        if (data[i].high > ep) {
                            ep = data[i].high;
                            currentAf = Math.min(currentAf + af, maxAf);
                        }
                    }
                } else {
                    currentSar = Math.max(currentSar, data[i - 1].high, i > 1 ? data[i - 2].high : data[i - 1].high);
                    if (data[i].high > currentSar) {
                        isUpTrend = true;
                        currentSar = ep;
                        ep = data[i].high;
                        currentAf = af;
                    } else {
                        if (data[i].low < ep) {
                            ep = data[i].low;
                            currentAf = Math.min(currentAf + af, maxAf);
                        }
                    }
                }
                
                sar.push(currentSar);
            }
            
            return sar;
        }

        // è®¡ç®—TRIX (ä¸‰é‡æŒ‡æ•°å¹³æ»‘ç§»åŠ¨å¹³å‡)
        function calculateTRIX(data, period = 12) {
            const closes = data.map(d => d.close);
            const ema1 = calculateEMAFromArray(closes, period);
            const ema2 = calculateEMAFromArray(ema1, period);
            const ema3 = calculateEMAFromArray(ema2, period);
            
            const trix = ema3.map((val, i) => {
                if (i === 0 || !ema3[i - 1] || ema3[i - 1] === 0) return null;
                return ((val - ema3[i - 1]) / ema3[i - 1]) * 100;
            });
            
            return trix;
        }

        // è¾…åŠ©å‡½æ•°ï¼šä»æ•°ç»„è®¡ç®—EMA
        function calculateEMAFromArray(arr, period) {
            const k = 2 / (period + 1);
            const ema = [];
            let prevEma = null;
            
            for (let i = 0; i < arr.length; i++) {
                if (arr[i] === null || arr[i] === undefined) {
                    ema.push(null);
                } else if (prevEma === null) {
                    ema.push(arr[i]);
                    prevEma = arr[i];
                } else {
                    const val = arr[i] * k + prevEma * (1 - k);
                    ema.push(val);
                    prevEma = val;
                }
            }
            return ema;
        }

        // è®¡ç®—Stoch (éšæœºæŒ‡æ ‡)
        function calculateStoch(data, period = 14) {
            const k = [];
            const d = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    k.push(null);
                    d.push(null);
                    continue;
                }
                
                const slice = data.slice(i - period + 1, i + 1);
                const high = Math.max(...slice.map(d => d.high));
                const low = Math.min(...slice.map(d => d.low));
                const close = data[i].close;
                
                const kVal = high === low ? 50 : ((close - low) / (high - low)) * 100;
                k.push(kVal);
                
                // Dæ˜¯Kçš„3æ—¥SMA
                if (i >= period + 1) {
                    const kSlice = k.slice(i - 2, i + 1).filter(v => v !== null);
                    const dVal = kSlice.reduce((a, b) => a + b, 0) / kSlice.length;
                    d.push(dVal);
                } else {
                    d.push(null);
                }
            }
            
            return { k, d };
        }

        // è®¡ç®—VR (æˆäº¤é‡æ¯”ç‡)
        function calculateVR(data, period = 26) {
            const vr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    vr.push(null);
                    continue;
                }
                
                let upVolume = 0;
                let downVolume = 0;
                let flatVolume = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    if (data[j].close > data[j - 1].close) {
                        upVolume += data[j].volume;
                    } else if (data[j].close < data[j - 1].close) {
                        downVolume += data[j].volume;
                    } else {
                        flatVolume += data[j].volume;
                    }
                }
                
                vr.push((upVolume + flatVolume / 2) / (downVolume + flatVolume / 2 || 1) * 100);
            }
            
            return vr;
        }

        // è®¡ç®—ATR (å¹³å‡çœŸå®æ³¢å¹…)
        function calculateATR(data, period = 14) {
            const tr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    tr.push(data[i].high - data[i].low);
                } else {
                    const high = data[i].high;
                    const low = data[i].low;
                    const prevClose = data[i - 1].close;
                    
                    tr.push(Math.max(
                        high - low,
                        Math.abs(high - prevClose),
                        Math.abs(low - prevClose)
                    ));
                }
            }
            
            const atr = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    atr.push(null);
                } else if (i === period - 1) {
                    const slice = tr.slice(0, period);
                    atr.push(slice.reduce((a, b) => a + b, 0) / period);
                } else {
                    atr.push((atr[i - 1] * (period - 1) + tr[i]) / period);
                }
            }
            
            return atr;
        }

        // è®¡ç®—BRAR (äººæ°”æ„æ„¿æŒ‡æ ‡)
        function calculateBRAR(data, period = 26) {
            const br = [];
            const ar = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    br.push(null);
                    ar.push(null);
                    continue;
                }
                
                let sumHC = 0;  // æœ€é«˜-æ˜¨æ”¶
                let sumCL = 0;  // æ˜¨æ”¶-æœ€ä½
                let sumHO = 0;  // æœ€é«˜-ä»Šå¼€
                let sumOL = 0;  // ä»Šå¼€-æœ€ä½
                
                for (let j = i - period + 1; j <= i; j++) {
                    sumHC += data[j].high - data[j - 1].close;
                    sumCL += data[j - 1].close - data[j].low;
                    sumHO += data[j].high - data[j].open;
                    sumOL += data[j].open - data[j].low;
                }
                
                br.push(sumHC / (sumCL || 1) * 100);
                ar.push((sumHO + sumOL) / (sumHC + sumCL || 1) * 100);
            }
            
            return { br, ar };
        }

        // è®¡ç®—CR (èƒ½é‡æŒ‡æ ‡)
        function calculateCR(data, period = 26) {
            const cr = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period || i === 0) {
                    cr.push(null);
                    continue;
                }
                
                let sumP = 0;
                let sumM = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    const mid = (data[j - 1].high + data[j - 1].low + data[j - 1].close) / 3;
                    sumP += Math.max(0, data[j].high - mid);
                    sumM += Math.max(0, mid - data[j].low);
                }
                
                cr.push(sumP / (sumM || 1) * 100);
            }
            
            return cr;
        }

        // è®¡ç®—MOM (åŠ¨é‡æŒ‡æ ‡)
        function calculateMOM(data, period = 10) {
            const closes = data.map(d => d.close);
            return closes.map((close, i) => {
                if (i < period) return null;
                return close - closes[i - period];
            });
        }

        // è®¡ç®—MFI (èµ„é‡‘æµé‡æŒ‡æ ‡ - Money Flow Index)
        function calculateMFI(data, period = 14) {
            const mfi = [];
            const typicalPrice = data.map(d => (d.high + d.low + d.close) / 3);
            const rawMoneyFlow = data.map((d, i) => typicalPrice[i] * d.volume);
            
            for (let i = 0; i < data.length; i++) {
                if (i < period) {
                    mfi.push(null);
                    continue;
                }
                
                let positiveFlow = 0;
                let negativeFlow = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    if (j === 0) continue;
                    if (typicalPrice[j] > typicalPrice[j - 1]) {
                        positiveFlow += rawMoneyFlow[j];
                    } else if (typicalPrice[j] < typicalPrice[j - 1]) {
                        negativeFlow += rawMoneyFlow[j];
                    }
                }
                
                if (negativeFlow === 0) {
                    mfi.push(100);
                } else {
                    const moneyRatio = positiveFlow / negativeFlow;
                    mfi.push(100 - (100 / (1 + moneyRatio)));
                }
            }
            
            return mfi;
        }

        // è®¡ç®—A/D Line (é›†æ•£çº¿ - Accumulation/Distribution Line)
        function calculateADL(data) {
            const adl = [0];
            
            for (let i = 1; i < data.length; i++) {
                const high = data[i].high;
                const low = data[i].low;
                const close = data[i].close;
                const volume = data[i].volume;
                
                let clv = 0;
                if (high !== low) {
                    clv = ((close - low) - (high - close)) / (high - low);
                }
                
                adl.push(adl[i - 1] + clv * volume);
            }
            
            return adl;
        }

        // è®¡ç®—Ichimoku (ä¸€ç›®å‡è¡¡è¡¨)
        function calculateIchimoku(data) {
            const tenkan = [];  // è½¬æ¢çº¿ (9æ—¥)
            const kijun = [];   // åŸºå‡†çº¿ (26æ—¥)
            const senkouA = []; // å…ˆè¡Œå¸¦A
            const senkouB = []; // å…ˆè¡Œå¸¦B (52æ—¥)
            const chikou = [];  // å»¶è¿Ÿçº¿
            
            for (let i = 0; i < data.length; i++) {
                // è½¬æ¢çº¿ (9æ—¥é«˜ä½ç‚¹ä¸­å€¼)
                if (i < 8) {
                    tenkan.push(null);
                } else {
                    const slice = data.slice(i - 8, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    tenkan.push((high + low) / 2);
                }
                
                // åŸºå‡†çº¿ (26æ—¥é«˜ä½ç‚¹ä¸­å€¼)
                if (i < 25) {
                    kijun.push(null);
                } else {
                    const slice = data.slice(i - 25, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    kijun.push((high + low) / 2);
                }
                
                // å…ˆè¡Œå¸¦A ((è½¬æ¢çº¿+åŸºå‡†çº¿)/2ï¼Œå‘å‰ç§»26æ—¥)
                if (tenkan[i] !== null && kijun[i] !== null) {
                    senkouA.push((tenkan[i] + kijun[i]) / 2);
                } else {
                    senkouA.push(null);
                }
                
                // å…ˆè¡Œå¸¦B (52æ—¥é«˜ä½ç‚¹ä¸­å€¼ï¼Œå‘å‰ç§»26æ—¥)
                if (i < 51) {
                    senkouB.push(null);
                } else {
                    const slice = data.slice(i - 51, i + 1);
                    const high = Math.max(...slice.map(d => d.high));
                    const low = Math.min(...slice.map(d => d.low));
                    senkouB.push((high + low) / 2);
                }
                
                // å»¶è¿Ÿçº¿ (å½“æ—¥æ”¶ç›˜ä»·ï¼Œå‘åç§»26æ—¥)
                chikou.push(data[i].close);
            }
            
            return { tenkan, kijun, senkouA, senkouB, chikou };
        }

        // è®¡ç®—ROC (Rate of Change å˜åŠ¨ç‡æŒ‡æ ‡)
        function calculateROC(data, period = 12) {
            const closes = data.map(d => d.close);
            return closes.map((close, i) => {
                if (i < period) return null;
                return ((close - closes[i - period]) / closes[i - period]) * 100;
            });
        }

        // è®¡ç®—BIAS (ä¹–ç¦»ç‡)
        function calculateBIAS(data, period = 6) {
            const closes = data.map(d => d.close);
            const ma = calculateMA(data, period);
            return closes.map((close, i) => {
                if (!ma[i]) return null;
                return ((close - ma[i]) / ma[i]) * 100;
            });
        }

        // è®¡ç®—PSY (å¿ƒç†çº¿æŒ‡æ ‡)
        function calculatePSY(data, period = 12) {
            const psy = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period) {
                    psy.push(null);
                    continue;
                }
                let upDays = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    if (j > 0 && data[j].close > data[j - 1].close) {
                        upDays++;
                    }
                }
                psy.push((upDays / period) * 100);
            }
            return psy;
        }

        // è®¡ç®—EMV (ç®€æ˜“æ³¢åŠ¨æŒ‡æ ‡)
        function calculateEMV(data, period = 14) {
            const emvValues = [];
            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    emvValues.push(null);
                    continue;
                }
                const midPoint = (data[i].high + data[i].low) / 2;
                const prevMidPoint = (data[i - 1].high + data[i - 1].low) / 2;
                const distanceMoved = midPoint - prevMidPoint;
                const boxRatio = (data[i].volume / 1000000) / (data[i].high - data[i].low);
                emvValues.push(distanceMoved / (boxRatio || 1));
            }
            
            // è®¡ç®—EMVçš„ç§»åŠ¨å¹³å‡
            const emvMA = [];
            for (let i = 0; i < emvValues.length; i++) {
                if (i < period - 1 || emvValues[i] === null) {
                    emvMA.push(null);
                    continue;
                }
                const slice = emvValues.slice(i - period + 1, i + 1).filter(v => v !== null);
                emvMA.push(slice.reduce((a, b) => a + b, 0) / slice.length);
            }
            return emvMA;
        }

        // è®¡ç®—WVAD (å¨å»‰å˜å¼‚ç¦»æ•£é‡)
        function calculateWVAD(data) {
            const wvad = [0];
            for (let i = 1; i < data.length; i++) {
                const range = data[i].high - data[i].low;
                if (range === 0) {
                    wvad.push(wvad[i - 1]);
                    continue;
                }
                const adv = ((data[i].close - data[i].low) - (data[i].high - data[i].close)) / range;
                wvad.push(wvad[i - 1] + adv * data[i].volume);
            }
            return wvad;
        }

        // è®¡ç®—MASS (æ¢…æ–¯çº¿)
        function calculateMASS(data, period = 25) {
            const highLowDiff = data.map(d => d.high - d.low);
            const ema9 = calculateEMAFromArray(highLowDiff, 9);
            const ema9ofEma9 = calculateEMAFromArray(ema9, 9);
            
            const ratio = ema9.map((val, i) => {
                if (!val || !ema9ofEma9[i] || ema9ofEma9[i] === 0) return null;
                return val / ema9ofEma9[i];
            });
            
            const mass = [];
            for (let i = 0; i < ratio.length; i++) {
                if (i < period - 1 || ratio[i] === null) {
                    mass.push(null);
                    continue;
                }
                const slice = ratio.slice(i - period + 1, i + 1).filter(v => v !== null);
                mass.push(slice.reduce((a, b) => a + b, 0));
            }
            return mass;
        }

        // è®¡ç®—DPO (åŒºé—´éœ‡è¡çº¿)
        function calculateDPO(data, period = 20) {
            const closes = data.map(d => d.close);
            const ma = calculateMA(data, period);
            const shift = Math.floor(period / 2) + 1;
            
            return closes.map((close, i) => {
                if (i < period - 1 || !ma[i - shift]) return null;
                return close - ma[i - shift];
            });
        }

        // è®¡ç®—Aroon (é˜¿éš†æŒ‡æ ‡)
        function calculateAroon(data, period = 25) {
            const aroonUp = [];
            const aroonDown = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    aroonUp.push(null);
                    aroonDown.push(null);
                    continue;
                }
                
                const slice = data.slice(i - period + 1, i + 1);
                let highestIdx = 0;
                let lowestIdx = 0;
                let highest = slice[0].high;
                let lowest = slice[0].low;
                
                for (let j = 1; j < slice.length; j++) {
                    if (slice[j].high >= highest) {
                        highest = slice[j].high;
                        highestIdx = j;
                    }
                    if (slice[j].low <= lowest) {
                        lowest = slice[j].low;
                        lowestIdx = j;
                    }
                }
                
                aroonUp.push(((period - (period - 1 - highestIdx)) / period) * 100);
                aroonDown.push(((period - (period - 1 - lowestIdx)) / period) * 100);
            }
            
            return { up: aroonUp, down: aroonDown };
        }

        // è®¡ç®—BBW (å¸ƒæ—å¸¦å®½åº¦)
        function calculateBBW(data, period = 20) {
            const bollinger = calculateBollinger(data, period, 2);
            return bollinger.middle.map((mid, i) => {
                if (!mid || mid === 0) return null;
                return ((bollinger.upper[i] - bollinger.lower[i]) / mid) * 100;
            });
        }

        // è®¡ç®—ENV (åŒ…ç»œçº¿)
        function calculateENV(data, period = 14, percent = 6) {
            const ma = calculateMA(data, period);
            const upper = ma.map(val => val ? val * (1 + percent / 100) : null);
            const lower = ma.map(val => val ? val * (1 - percent / 100) : null);
            return { upper, middle: ma, lower };
        }

        // è®¡ç®—MI (åŠ¨åŠ›æŒ‡æ ‡)
        function calculateMI(data) {
            const mi = [0];
            for (let i = 1; i < data.length; i++) {
                const priceChange = data[i].close - data[i - 1].close;
                mi.push(mi[i - 1] + priceChange);
            }
            return mi;
        }

        // è®¡ç®—DMA (å¹³è¡Œçº¿å·®æŒ‡æ ‡)
        function calculateDMA(data, shortPeriod = 10, longPeriod = 50) {
            const shortMA = calculateMA(data, shortPeriod);
            const longMA = calculateMA(data, longPeriod);
            const dma = shortMA.map((val, i) => {
                if (!val || !longMA[i]) return null;
                return val - longMA[i];
            });
            const ama = calculateEMAFromArray(dma.filter(v => v !== null), 10);
            return { dma, ama };
        }

        // è®¡ç®—EXPMA (æŒ‡æ•°å¹³æ»‘ç§»åŠ¨å¹³å‡)
        function calculateEXPMA(data, period1 = 12, period2 = 50) {
            const closes = data.map(d => d.close);
            return {
                expma1: calculateEMAFromArray(closes, period1),
                expma2: calculateEMAFromArray(closes, period2)
            };
        }

        // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®ï¼ˆå¸¦å®Œæ•´éªŒè¯ï¼‰
        function displayStats(data, indicators) {
            const latest = data[data.length - 1];
            const previous = data[data.length - 2];
            
            // ========== æ•°æ®å®Œæ•´æ€§éªŒè¯ ==========
            console.log('ğŸ“Š ä»·æ ¼æ•°æ®éªŒè¯ï¼š', {
                æœ€æ–°Kçº¿: latest,
                å‰ä¸€Kçº¿: previous,
                æ•°æ®æ¡æ•°: data.length
            });
            
            // éªŒè¯å¿…è¦å­—æ®µ
            const requiredFields = ['open', 'high', 'low', 'close', 'volume'];
            const missingFields = requiredFields.filter(field => 
                latest[field] === null || latest[field] === undefined || isNaN(latest[field])
            );
            
            if (missingFields.length > 0) {
                console.error('âŒ æ•°æ®ç¼ºå¤±å­—æ®µ:', missingFields);
                showError(`æ•°æ®ä¸å®Œæ•´ï¼šç¼ºå°‘${missingFields.join(', ')}`);
                return;
            }
            
            // ========== æ•°æ®åˆç†æ€§éªŒè¯ ==========
            // 1. æœ€é«˜ä»·å¿…é¡»â‰¥æœ€ä½ä»·
            if (latest.high < latest.low) {
                console.error('âŒ æ•°æ®å¼‚å¸¸: æœ€é«˜ä»· < æœ€ä½ä»·', { high: latest.high, low: latest.low });
                showError('æ•°æ®å¼‚å¸¸ï¼šæœ€é«˜ä»·ä¸èƒ½å°äºæœ€ä½ä»·');
                return;
            }
            
            // 2. æ”¶ç›˜ä»·å¿…é¡»åœ¨æœ€é«˜æœ€ä½ä¹‹é—´
            if (latest.close > latest.high || latest.close < latest.low) {
                console.warn('âš ï¸ æ•°æ®è­¦å‘Š: æ”¶ç›˜ä»·è¶…å‡ºå½“æ—¥èŒƒå›´', { 
                    close: latest.close, high: latest.high, low: latest.low 
                });
            }
            
            // 3. å¼€ç›˜ä»·å¿…é¡»åœ¨æœ€é«˜æœ€ä½ä¹‹é—´
            if (latest.open > latest.high || latest.open < latest.low) {
                console.warn('âš ï¸ æ•°æ®è­¦å‘Š: å¼€ç›˜ä»·è¶…å‡ºå½“æ—¥èŒƒå›´', { 
                    open: latest.open, high: latest.high, low: latest.low 
                });
            }
            
            // 4. æˆäº¤é‡å¿…é¡»â‰¥0
            if (latest.volume < 0) {
                console.error('âŒ æ•°æ®å¼‚å¸¸: æˆäº¤é‡ä¸ºè´Ÿæ•°', { volume: latest.volume });
                showError('æ•°æ®å¼‚å¸¸ï¼šæˆäº¤é‡ä¸èƒ½ä¸ºè´Ÿæ•°');
                return;
            }
            
            // ========== ç²¾ç¡®è®¡ç®—ï¼ˆä¿è¯å‡†ç¡®æ€§ï¼‰==========
            // æ¶¨è·Œå¹… = (æœ€æ–°ä»· - æ˜¨æ”¶) / æ˜¨æ”¶ Ã— 100%
            const changePercent = ((latest.close - previous.close) / previous.close * 100);
            
            // æ¶¨è·Œé¢ = æœ€æ–°ä»· - æ˜¨æ”¶
            const changeAmount = latest.close - previous.close;
            
            // æŒ¯å¹… = (æœ€é«˜ä»· - æœ€ä½ä»·) / æ˜¨æ”¶ä»· Ã— 100%
            const amplitude = ((latest.high - latest.low) / previous.close * 100);
            
            // é«˜ä½å·® = æœ€é«˜ä»· - æœ€ä½ä»·
            const priceRange = latest.high - latest.low;
            
            // æˆäº¤é‡è½¬æ¢ä¸ºç™¾ä¸‡å•ä½
            const turnover = (latest.volume / 1000000);
            
            // æˆäº¤é¢ä¼°ç®—ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const turnoverValue = turnover * latest.close;
            
            // ========== éªŒè¯è®¡ç®—ç»“æœ ==========
            console.log('âœ… ä»·æ ¼è®¡ç®—ç»“æœ:', {
                'æœ€æ–°ä»·': latest.close.toFixed(2),
                'æ˜¨æ”¶ä»·': previous.close.toFixed(2),
                'æ¶¨è·Œé¢': changeAmount.toFixed(2),
                'æ¶¨è·Œå¹…': changePercent.toFixed(2) + '%',
                'ä»Šå¼€': latest.open.toFixed(2),
                'æœ€é«˜': latest.high.toFixed(2),
                'æœ€ä½': latest.low.toFixed(2),
                'æŒ¯å¹…': amplitude.toFixed(2) + '%',
                'é«˜ä½å·®': priceRange.toFixed(2),
                'æˆäº¤é‡': turnover.toFixed(2) + 'M',
                'MA5': indicators.ma5[indicators.ma5.length - 1]?.toFixed(2),
                'MA20': indicators.ma20[indicators.ma20.length - 1]?.toFixed(2),
                'MA60': indicators.ma60[indicators.ma60.length - 1]?.toFixed(2)
            });
            
            // æ ¹æ®é¢œè‰²æ–¹æ¡ˆç¡®å®šé¢œè‰²
            const isUp = changePercent > 0;
            const cardClass = isUp ? 'bullish' : 'bearish';
            const cardStyle = isUp ? colorConfig[colorScheme].upBg : colorConfig[colorScheme].downBg;

            const html = `
                <div class="stat-card ${cardClass}" style="background: ${cardStyle};">
                    <div class="stat-label">æœ€æ–°ä»·</div>
                    <div class="stat-value">Â¥${latest.close.toFixed(2)}</div>
                    <div class="stat-change">${isUp ? 'â†‘' : 'â†“'} ${Math.abs(changePercent).toFixed(2)}% (${changeAmount >= 0 ? '+' : ''}${changeAmount.toFixed(2)})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šå¼€</div>
                    <div class="stat-value">Â¥${latest.open.toFixed(2)}</div>
                    <div class="stat-change">æœ€é«˜ Â¥${latest.high.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ˜¨æ”¶</div>
                    <div class="stat-value">Â¥${previous.close.toFixed(2)}</div>
                    <div class="stat-change">æœ€ä½ Â¥${latest.low.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æŒ¯å¹…</div>
                    <div class="stat-value">${amplitude.toFixed(2)}%</div>
                    <div class="stat-change">é«˜ä½å·® Â¥${priceRange.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æˆäº¤é‡</div>
                    <div class="stat-value">${turnover.toFixed(2)}M</div>
                    <div class="stat-change">é‡æ¯” ${indicators.volumeRatio[indicators.volumeRatio.length - 1]?.toFixed(2) || '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">MA5</div>
                    <div class="stat-value">Â¥${indicators.ma5[indicators.ma5.length - 1]?.toFixed(2) || '-'}</div>
                    <div class="stat-change">5æ—¥å‡çº¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">MA20</div>
                    <div class="stat-value">Â¥${indicators.ma20[indicators.ma20.length - 1]?.toFixed(2) || '-'}</div>
                    <div class="stat-change">20æ—¥å‡çº¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">MA60</div>
                    <div class="stat-value">Â¥${indicators.ma60[indicators.ma60.length - 1]?.toFixed(2) || '-'}</div>
                    <div class="stat-change">60æ—¥å‡çº¿</div>
                </div>
            `;
            
            document.getElementById('statsGrid').innerHTML = html;
        }

        // æ˜¾ç¤ºæŠ€æœ¯ä¿¡å·
        function displaySignals(data, indicators) {
            const signals = [];
            const latest = data[data.length - 1];
            const currentRSI = indicators.rsi[indicators.rsi.length - 1];
            const currentMACD = indicators.macd.macd[indicators.macd.macd.length - 1];
            const currentK = indicators.kdj.k[indicators.kdj.k.length - 1];
            const currentD = indicators.kdj.d[indicators.kdj.d.length - 1];
            const ma5 = indicators.ma5[indicators.ma5.length - 1];
            const ma20 = indicators.ma20[indicators.ma20.length - 1];
            const ma60 = indicators.ma60[indicators.ma60.length - 1];

            // è¾…åŠ©å‡½æ•°
            const n = data.length - 1;
            const crossedUp = (a, b) => a[n - 1] > b[n - 1] && a[n - 2] <= b[n - 2];
            const crossedDown = (a, b) => a[n - 1] < b[n - 1] && a[n - 2] >= b[n - 2];
            const slopeUp = arr => arr[n - 1] > arr[n - 2];
            const slopeDown = arr => arr[n - 1] < arr[n - 2];
            const safe = v => (typeof v === 'number' && isFinite(v));

            // è¶‹åŠ¿ä¿¡å·
            let trendText = '';
            if (ma5 > ma20 && ma20 > ma60) {
                signals.push({ text: 'å¤šå¤´æ’åˆ—', type: 'buy' });
                trendText = '<span class="bullish-text">å¼ºåŠ¿ä¸Šæ¶¨</span>';
            } else if (ma5 < ma20 && ma20 < ma60) {
                signals.push({ text: 'ç©ºå¤´æ’åˆ—', type: 'sell' });
                trendText = '<span class="bearish-text">å¼±åŠ¿ä¸‹è·Œ</span>';
            } else {
                signals.push({ text: 'éœ‡è¡æ•´ç†', type: 'neutral' });
                trendText = '<span class="neutral-text">æ¨ªç›˜éœ‡è¡</span>';
            }

            // RSIä¿¡å·
            let rsiText = '';
            if (currentRSI < 30) {
                signals.push({ text: 'RSIè¶…å–', type: 'buy' });
                rsiText = `<span class="bullish-text">${currentRSI.toFixed(2)} (è¶…å–)</span>`;
            } else if (currentRSI > 70) {
                signals.push({ text: 'RSIè¶…ä¹°', type: 'sell' });
                rsiText = `<span class="bearish-text">${currentRSI.toFixed(2)} (è¶…ä¹°)</span>`;
            } else {
                rsiText = `<span class="neutral-text">${currentRSI.toFixed(2)}</span>`;
            }

            // MACDä¿¡å·
            let macdText = '';
            const prevMACD = indicators.macd.macd[indicators.macd.macd.length - 2];
            const dif = indicators.macd.dif;
            const dea = indicators.macd.dea;
            const hist = indicators.macd.macd;
            if (currentMACD > 0 && prevMACD < 0) {
                signals.push({ text: 'MACDé‡‘å‰', type: 'buy' });
                macdText = '<span class="bullish-text">é‡‘å‰</span>';
            } else if (currentMACD < 0 && prevMACD > 0) {
                signals.push({ text: 'MACDæ­»å‰', type: 'sell' });
                macdText = '<span class="bearish-text">æ­»å‰</span>';
            } else if (currentMACD > 0) {
                macdText = '<span class="bullish-text">å¤šå¤´</span>';
            } else {
                macdText = '<span class="bearish-text">ç©ºå¤´</span>';
            }

            // KDJä¿¡å·
            let kdjText = '';
            if (currentK < 20 && currentK > currentD) {
                signals.push({ text: 'KDJä½ä½é‡‘å‰', type: 'buy' });
                kdjText = '<span class="bullish-text">ä½ä½é‡‘å‰</span>';
            } else if (currentK > 80 && currentK < currentD) {
                signals.push({ text: 'KDJé«˜ä½æ­»å‰', type: 'sell' });
                kdjText = '<span class="bearish-text">é«˜ä½æ­»å‰</span>';
            } else if (currentK > 80) {
                kdjText = '<span class="bearish-text">è¶…ä¹°</span>';
            } else if (currentK < 20) {
                kdjText = '<span class="bullish-text">è¶…å–</span>';
            } else {
                kdjText = '<span class="neutral-text">ä¸­æ€§</span>';
            }

            // å¸ƒæ—å¸¦ä¿¡å·
            const upperBB = indicators.bollinger.upper[indicators.bollinger.upper.length - 1];
            const lowerBB = indicators.bollinger.lower[indicators.bollinger.lower.length - 1];
            const middleBB = indicators.bollinger.middle[indicators.bollinger.middle.length - 1];
            
            let bollingerText = '';
            if (latest.close > upperBB) {
                signals.push({ text: 'çªç ´ä¸Šè½¨', type: 'sell' });
                bollingerText = '<span class="bearish-text">ä¸Šè½¨ä¸Šæ–¹</span>';
            } else if (latest.close < lowerBB) {
                signals.push({ text: 'è§¦åŠä¸‹è½¨', type: 'buy' });
                bollingerText = '<span class="bullish-text">ä¸‹è½¨ä¸‹æ–¹</span>';
            } else if (latest.close > middleBB) {
                bollingerText = '<span class="neutral-text">ä¸­è½¨ä¸Šæ–¹</span>';
            } else {
                bollingerText = '<span class="neutral-text">ä¸­è½¨ä¸‹æ–¹</span>';
            }

            // ğŸ”¥ è¶…å¼ºå¤šç»´åº¦æ™ºèƒ½é¢„æµ‹ç³»ç»Ÿï¼ˆ15ä¸ªç»´åº¦æ·±åº¦åˆ†æï¼‰
            const adx = indicators.dmi.adx;
            const pdi = indicators.dmi.pdi;
            const mdi = indicators.dmi.mdi;
            const obv = indicators.obv;
            const atr = indicators.atr;
            const wr = indicators.wr;
            const cci = indicators.cci;
            const mfi = indicators.mfi;
            const roc = indicators.roc;
            const stoch = indicators.stoch;
            
            let strictText = '';
            let bullScore = 0;
            let bearScore = 0;
            const total = 15;
            const details = [];
            const reasons = { bull: [], bear: [] };
            
            // ========== ç»´åº¦1ï¼šå‡çº¿ç³»ç»Ÿï¼ˆå¿…é¡»å¤šå¤´/ç©ºå¤´æ’åˆ—ï¼‰==========
            const bullMA = ma5 > ma20 && ma20 > ma60 && latest.close > ma5;
            const bearMA = ma5 < ma20 && ma20 < ma60 && latest.close < ma5;
            if (bullMA) { 
                bullScore++; 
                details.push('âœ“å‡çº¿å¤šå¤´'); 
                reasons.bull.push(`å‡çº¿å®Œç¾å¤šå¤´æ’åˆ—ï¼ˆMA5>${ma5.toFixed(2)} > MA20>${ma20.toFixed(2)} > MA60>${ma60.toFixed(2)}ï¼‰`);
            }
            if (bearMA) { 
                bearScore++; 
                details.push('âœ“å‡çº¿ç©ºå¤´'); 
                reasons.bear.push(`å‡çº¿å®Œç¾ç©ºå¤´æ’åˆ—ï¼ˆMA5<${ma5.toFixed(2)} < MA20<${ma20.toFixed(2)} < MA60<${ma60.toFixed(2)}ï¼‰`);
            }
            
            // ========== ç»´åº¦2ï¼šMACDå®Œæ•´éªŒè¯ï¼ˆDIF/DEAä½ç½®+æ–¹å‘+æŸ±ä½“ï¼‰==========
            const difCurr = dif[n - 1], deaCurr = dea[n - 1];
            const difPrev = dif[n - 2], deaPrev = dea[n - 2];
            // å¤šå¤´ï¼šDIFå’ŒDEAéƒ½åœ¨é›¶è½´ä¸Šæ–¹ï¼ŒDIF>DEAï¼Œä¸”æŸ±ä½“æ”¾å¤§
            const macdBull = difCurr > 0 && deaCurr > 0 && difCurr > deaCurr && 
                            safe(hist[n - 1]) && safe(hist[n - 2]) && hist[n - 1] > hist[n - 2] && hist[n - 1] > 0;
            // ç©ºå¤´ï¼šDIFå’ŒDEAéƒ½åœ¨é›¶è½´ä¸‹æ–¹ï¼ŒDIF<DEAï¼Œä¸”æŸ±ä½“æ”¾å¤§
            const macdBear = difCurr < 0 && deaCurr < 0 && difCurr < deaCurr && 
                            safe(hist[n - 1]) && safe(hist[n - 2]) && hist[n - 1] < hist[n - 2] && hist[n - 1] < 0;
            if (macdBull) { 
                bullScore++; 
                details.push('âœ“MACDå¤šå¤´'); 
                reasons.bull.push('MACDé›¶è½´ä¸Šæ–¹å¤šå¤´æ’åˆ—ä¸”æŸ±ä½“æ”¾å¤§');
            }
            if (macdBear) { 
                bearScore++; 
                details.push('âœ“MACDç©ºå¤´'); 
                reasons.bear.push('MACDé›¶è½´ä¸‹æ–¹ç©ºå¤´æ’åˆ—ä¸”æŸ±ä½“æ”¾å¤§');
            }
            
            // ========== ç»´åº¦3ï¼šRSIå¼ºåº¦ä¸æ–¹å‘ï¼ˆæ”¾å®½æ¡ä»¶ï¼‰==========
            const rsiPrev = indicators.rsi[n - 2];
            const rsiPrev2 = indicators.rsi[n - 3];
            // å¤šå¤´ï¼šRSIåœ¨45-75å¼ºåŠ¿åŒºé—´ï¼Œä¸”ä¸Šè¡Œï¼ˆæ— éœ€è¿ç»­ï¼‰
            const rsiBull = currentRSI > 45 && currentRSI < 75 && currentRSI > rsiPrev;
            // ç©ºå¤´ï¼šRSIåœ¨25-55å¼±åŠ¿åŒºé—´ï¼Œä¸”ä¸‹è¡Œï¼ˆæ— éœ€è¿ç»­ï¼‰
            const rsiBear = currentRSI < 55 && currentRSI > 25 && currentRSI < rsiPrev;
            if (rsiBull) { 
                bullScore++; 
                details.push('âœ“RSIå¼ºåŠ¿'); 
                reasons.bull.push(`RSIå¼ºåŠ¿åŒº${currentRSI.toFixed(1)}ä¸”è¿ç»­ä¸Šè¡Œ`);
            }
            if (rsiBear) { 
                bearScore++; 
                details.push('âœ“RSIå¼±åŠ¿'); 
                reasons.bear.push(`RSIå¼±åŠ¿åŒº${currentRSI.toFixed(1)}ä¸”è¿ç»­ä¸‹è¡Œ`);
            }
            
            // ========== ç»´åº¦4ï¼šDMIè¶‹åŠ¿å¼ºåº¦ï¼ˆADXâ‰¥25ï¼ŒPDI/MDIå·®è·â‰¥5ï¼‰==========
            const adxCurr = adx[adx.length - 1];
            const pdiCurr = pdi[pdi.length - 1];
            const mdiCurr = mdi[mdi.length - 1];
            const dmiBull = pdiCurr > mdiCurr && (pdiCurr - mdiCurr) >= 5 && adxCurr >= 25;
            const dmiBear = pdiCurr < mdiCurr && (mdiCurr - pdiCurr) >= 5 && adxCurr >= 25;
            if (dmiBull) { 
                bullScore++; 
                details.push('âœ“DMIå¼ºåŠ¿'); 
                reasons.bull.push(`DMIç¡®è®¤ä¸Šæ¶¨è¶‹åŠ¿ï¼ˆADX=${adxCurr.toFixed(0)}, PDI-MDI=${(pdiCurr-mdiCurr).toFixed(0)}ï¼‰`);
            }
            if (dmiBear) { 
                bearScore++; 
                details.push('âœ“DMIå¼±åŠ¿'); 
                reasons.bear.push(`DMIç¡®è®¤ä¸‹è·Œè¶‹åŠ¿ï¼ˆADX=${adxCurr.toFixed(0)}, MDI-PDI=${(mdiCurr-pdiCurr).toFixed(0)}ï¼‰`);
            }
            
            // ========== ç»´åº¦5ï¼šKDJä½ç½®ä¸äº¤å‰ï¼ˆæ”¾å®½é˜ˆå€¼ï¼‰==========
            const kPrev = indicators.kdj.k[n - 2];
            const dPrev = indicators.kdj.d[n - 2];
            // å¤šå¤´ï¼šK>Dæˆ–åˆšåˆšé‡‘å‰ï¼ŒKå€¼åœ¨åˆç†èŒƒå›´
            const kdjBull = (currentK > currentD && currentK < 85) || (currentK > currentD && kPrev <= dPrev);
            // ç©ºå¤´ï¼šK<Dæˆ–åˆšåˆšæ­»å‰ï¼ŒKå€¼åœ¨åˆç†èŒƒå›´
            const kdjBear = (currentK < currentD && currentK > 15) || (currentK < currentD && kPrev >= dPrev);
            if (kdjBull) { 
                bullScore++; 
                details.push('âœ“KDJé‡‘å‰'); 
                reasons.bull.push(`KDJé‡‘å‰ï¼ˆK=${currentK.toFixed(0)}, D=${currentD.toFixed(0)}ï¼‰`);
            }
            if (kdjBear) { 
                bearScore++; 
                details.push('âœ“KDJæ­»å‰'); 
                reasons.bear.push(`KDJæ­»å‰ï¼ˆK=${currentK.toFixed(0)}, D=${currentD.toFixed(0)}ï¼‰`);
            }
            
            // ========== ç»´åº¦6ï¼šå¸ƒæ—å¸¦ä½ç½®ï¼ˆçªç ´ä¸­è½¨ä¸”æœªè§¦åŠæå€¼ï¼‰==========
            const bbWidth = (upperBB - lowerBB) / middleBB * 100;
            // å¤šå¤´ï¼šåœ¨ä¸­è½¨ä¸Šæ–¹ä½†æœªè§¦åŠä¸Šè½¨ï¼Œä¸”å¸¦å®½é€‚ä¸­ï¼ˆ2%-10%ï¼‰
            const bbBull = latest.close > middleBB && latest.close < upperBB && bbWidth > 2 && bbWidth < 10;
            // ç©ºå¤´ï¼šåœ¨ä¸­è½¨ä¸‹æ–¹ä½†æœªè§¦åŠä¸‹è½¨ï¼Œä¸”å¸¦å®½é€‚ä¸­
            const bbBear = latest.close < middleBB && latest.close > lowerBB && bbWidth > 2 && bbWidth < 10;
            if (bbBull) { 
                bullScore++; 
                details.push('âœ“å¸ƒæ—å¸¦å¤š'); 
                reasons.bull.push('ä»·æ ¼åœ¨å¸ƒæ—å¸¦ä¸­è½¨ä¸Šæ–¹ï¼Œæ³¢åŠ¨ç‡é€‚ä¸­');
            }
            if (bbBear) { 
                bearScore++; 
                details.push('âœ“å¸ƒæ—å¸¦ç©º'); 
                reasons.bear.push('ä»·æ ¼åœ¨å¸ƒæ—å¸¦ä¸­è½¨ä¸‹æ–¹ï¼Œæ³¢åŠ¨ç‡é€‚ä¸­');
            }
            
            // ========== ç»´åº¦7ï¼šæˆäº¤é‡ç¡®è®¤ï¼ˆOBVæ–¹å‘ä¸ä»·æ ¼ä¸€è‡´ï¼‰==========
            const obvCurr = obv[obv.length - 1];
            const obvPrev = obv[obv.length - 2];
            const obvPrev2 = obv[obv.length - 3];
            const priceCurr = data[n - 1].close;
            const pricePrev = data[n - 2].close;
            // å¤šå¤´ï¼šä»·æ ¼ä¸Šæ¶¨ä¸”OBVè¿ç»­ä¸Šå‡
            const volumeBull = priceCurr > pricePrev && obvCurr > obvPrev && obvPrev > obvPrev2;
            // ç©ºå¤´ï¼šä»·æ ¼ä¸‹è·Œä¸”OBVè¿ç»­ä¸‹é™
            const volumeBear = priceCurr < pricePrev && obvCurr < obvPrev && obvPrev < obvPrev2;
            if (volumeBull) { 
                bullScore++; 
                details.push('âœ“é‡èƒ½é…åˆ'); 
                reasons.bull.push('ä»·æ¶¨é‡å‡ï¼ŒOBVè¿ç»­ä¸Šè¡Œ');
            }
            if (volumeBear) { 
                bearScore++; 
                details.push('âœ“é‡èƒ½é…åˆ'); 
                reasons.bear.push('ä»·è·Œé‡å¢ï¼ŒOBVè¿ç»­ä¸‹è¡Œ');
            }
            
            // ========== ç»´åº¦8ï¼šæ³¢åŠ¨ç‡è¿‡æ»¤ï¼ˆATRåœ¨åˆç†èŒƒå›´ï¼Œé¿å…å‰§çƒˆæ³¢åŠ¨ï¼‰==========
            const atrCurr = atr[atr.length - 1];
            const atrAvg = atr.slice(-20).reduce((a,b) => a + b, 0) / 20;
            // ATRåœ¨å¹³å‡å€¼çš„0.5-1.5å€èŒƒå›´å†…ï¼ˆé¿å…è¿‡åº¦æ³¢åŠ¨æˆ–è¿‡åº¦å¹³é™ï¼‰
            const atrValid = atrCurr > atrAvg * 0.5 && atrCurr < atrAvg * 1.5;
            if (atrValid) { 
                if (bullScore > bearScore) { bullScore++; details.push('âœ“æ³¢åŠ¨ç‡æ­£å¸¸'); reasons.bull.push('æ³¢åŠ¨é€‚ä¸­'); }
                if (bearScore > bullScore) { bearScore++; details.push('âœ“æ³¢åŠ¨ç‡æ­£å¸¸'); reasons.bear.push('æ³¢åŠ¨é€‚ä¸­'); }
            }
            
            // ========== ç»´åº¦9ï¼šå¨å»‰æŒ‡æ ‡ï¼ˆWRè¶…å–è¶…ä¹°ï¼Œæ”¾å®½æ¡ä»¶ï¼‰==========
            const wrCurr = wr[wr.length - 1];
            // æ”¾å®½WRé˜ˆå€¼
            const wrBull = (wrCurr < -75 && wrCurr > wr[wr.length - 2]) || (wrCurr < -60 && wrCurr > -40); // è¶…å–å›å‡æˆ–ä¸­ä½åå¼º
            const wrBear = (wrCurr > -25 && wrCurr < wr[wr.length - 2]) || (wrCurr > -60 && wrCurr < -40); // è¶…ä¹°å›è½æˆ–ä¸­ä½åå¼±
            if (wrBull) { bullScore++; details.push('âœ“WRè¶…å–å›å‡'); reasons.bull.push(`WR ${wrCurr.toFixed(0)} è¶…å–åå¼¹`); }
            if (wrBear) { bearScore++; details.push('âœ“WRè¶…ä¹°å›è½'); reasons.bear.push(`WR ${wrCurr.toFixed(0)} è¶…ä¹°å›è°ƒ`); }
            
            // ========== ç»´åº¦10ï¼šCCIé¡ºåŠ¿æŒ‡æ ‡ï¼ˆæå€¼åè½¬ï¼‰==========
            const cciCurr = cci[cci.length - 1];
            const cciPrev = cci[cci.length - 2];
            // CCI > +100è¶…ä¹°ï¼Œ< -100è¶…å–
            const cciBull = cciCurr < -100 && cciCurr > cciPrev && cciPrev < -100;
            const cciBear = cciCurr > 100 && cciCurr < cciPrev && cciPrev > 100;
            if (cciBull) { bullScore++; details.push('âœ“CCIè¶…å–å›å‡'); reasons.bull.push(`CCI ${cciCurr.toFixed(0)} åº•éƒ¨åè½¬`); }
            if (cciBear) { bearScore++; details.push('âœ“CCIè¶…ä¹°å›è½'); reasons.bear.push(`CCI ${cciCurr.toFixed(0)} é¡¶éƒ¨åè½¬`); }
            
            // ========== ç»´åº¦11ï¼šMFIèµ„é‡‘æµé‡ï¼ˆé‡ä»·èƒŒç¦»ï¼‰==========
            const mfiCurr = mfi[mfi.length - 1];
            const mfiPrev = mfi[mfi.length - 2];
            // MFIç±»ä¼¼RSIä½†è€ƒè™‘æˆäº¤é‡ï¼Œæ›´å¯é 
            const mfiBull = mfiCurr < 20 && mfiCurr > mfiPrev; // è¶…å–åŒºå›å‡
            const mfiBear = mfiCurr > 80 && mfiCurr < mfiPrev; // è¶…ä¹°åŒºå›è½
            if (mfiBull) { bullScore++; details.push('âœ“MFIèµ„é‡‘å›æµ'); reasons.bull.push(`èµ„é‡‘æµå…¥å¢å¼º MFI ${mfiCurr.toFixed(0)}`); }
            if (mfiBear) { bearScore++; details.push('âœ“MFIèµ„é‡‘æµå‡º'); reasons.bear.push(`èµ„é‡‘æµå‡ºåŠ å‰§ MFI ${mfiCurr.toFixed(0)}`); }
            
            // ========== ç»´åº¦12ï¼šROCå˜åŠ¨ç‡ï¼ˆåŠ¨é‡ç¡®è®¤ï¼‰==========
            const rocCurr = roc[roc.length - 1];
            const rocPrev = roc[roc.length - 2];
            const rocPrev2 = roc[roc.length - 3];
            // ROCè¿ç»­ä¸Šå‡/ä¸‹é™ç¡®è®¤åŠ¨é‡
            const rocBull = rocCurr > 0 && rocCurr > rocPrev && rocPrev > rocPrev2;
            const rocBear = rocCurr < 0 && rocCurr < rocPrev && rocPrev < rocPrev2;
            if (rocBull) { bullScore++; details.push('âœ“ROCåŠ¨é‡åŠ é€Ÿ'); reasons.bull.push('ä¸Šæ¶¨åŠ¨é‡æŒç»­å¢å¼º'); }
            if (rocBear) { bearScore++; details.push('âœ“ROCåŠ¨é‡å‡å¼±'); reasons.bear.push('ä¸‹è·ŒåŠ¨é‡æŒç»­å¢å¼º'); }
            
            // ========== ç»´åº¦13ï¼šStochéšæœºæŒ‡æ ‡ï¼ˆæ”¾å®½äº¤å‰æ¡ä»¶ï¼‰==========
            const stochK = stoch.k[stoch.k.length - 1];
            const stochD = stoch.d[stoch.d.length - 1];
            const stochKPrev = stoch.k[stoch.k.length - 2];
            const stochDPrev = stoch.d[stoch.d.length - 2];
            // æ”¾å®½é˜ˆå€¼ï¼šK>Dä¸”ä½ä½æˆ–åˆšé‡‘å‰=åšå¤šï¼ŒK<Dä¸”é«˜ä½æˆ–åˆšæ­»å‰=åšç©º
            const stochBull = (stochK > stochD && stochK < 50) || (stochK > stochD && stochKPrev <= stochDPrev);
            const stochBear = (stochK < stochD && stochK > 50) || (stochK < stochD && stochKPrev >= stochDPrev);
            if (stochBull) { bullScore++; details.push('âœ“Stochä½ä½é‡‘å‰'); reasons.bull.push('éšæœºæŒ‡æ ‡ä½ä½é‡‘å‰'); }
            if (stochBear) { bearScore++; details.push('âœ“Stoché«˜ä½æ­»å‰'); reasons.bear.push('éšæœºæŒ‡æ ‡é«˜ä½æ­»å‰'); }
            
            // ========== ç»´åº¦14ï¼šä»·æ ¼åŠ¨é‡ï¼ˆé™ä½è¿ç»­å¤©æ•°è¦æ±‚ï¼‰==========
            let consecutiveUp = 0;
            let consecutiveDown = 0;
            for (let i = data.length - 1; i > data.length - 6 && i > 0; i--) {
                if (data[i].close > data[i - 1].close) consecutiveUp++;
                else break;
            }
            for (let i = data.length - 1; i > data.length - 6 && i > 0; i--) {
                if (data[i].close < data[i - 1].close) consecutiveDown++;
                else break;
            }
            // é™ä½åˆ°2å¤©å³å¯
            if (consecutiveUp >= 2) { bullScore++; details.push(`âœ“è¿æ¶¨${consecutiveUp}å¤©`); reasons.bull.push(`è¿ç»­ä¸Šæ¶¨${consecutiveUp}å¤©ï¼ŒåŠ¨é‡å‘å¥½`); }
            if (consecutiveDown >= 2) { bearScore++; details.push(`âœ“è¿è·Œ${consecutiveDown}å¤©`); reasons.bear.push(`è¿ç»­ä¸‹è·Œ${consecutiveDown}å¤©ï¼Œèµ°åŠ¿åå¼±`); }
            
            // ========== ç»´åº¦15ï¼šé‡ä»·é…åˆåº¦ï¼ˆæ”¾å®½æˆäº¤é‡è¦æ±‚ï¼‰==========
            const vol3DayAvg = (data[n - 1].volume + data[n - 2].volume + data[n - 3].volume) / 3;
            const vol10DayAvg = data.slice(-10).reduce((sum, d) => sum + d.volume, 0) / 10;
            const priceUp3Days = data[n - 1].close > data[n - 3].close;
            const priceDown3Days = data[n - 1].close < data[n - 3].close;
            // é™ä½é‡èƒ½æ”¾å¤§è¦æ±‚åˆ°1.1å€
            const volumeExpand = vol3DayAvg > vol10DayAvg * 1.1;
            
            if (priceUp3Days && volumeExpand) { 
                bullScore++; 
                details.push('âœ“ä»·æ¶¨é‡å¢'); 
                reasons.bull.push('ä»·æ ¼ä¸Šæ¶¨ä¸”æˆäº¤é‡æ”¾å¤§ï¼Œå¤šå¤´æ´»è·ƒ');
            }
            if (priceDown3Days && volumeExpand) { 
                bearScore++; 
                details.push('âœ“ä»·è·Œé‡å¢'); 
                reasons.bear.push('ä»·æ ¼ä¸‹è·Œä¸”æˆäº¤é‡æ”¾å¤§ï¼Œç©ºå¤´æ´»è·ƒ');
            }
            
            // ========== æœ€ç»ˆåˆ¤å®šï¼ˆä¼˜åŒ–åçš„çµæ´»åˆ¤å®šç³»ç»Ÿï¼‰==========
            const strongSignal = 8;  // å¼ºä¿¡å·é—¨æ§›é™ä½ä¸º8
            const moderateSignal = 6; // ä¸­ç­‰ä¿¡å·ä¸º6
            const weakSignal = 4;     // å¼±ä¿¡å·ä¸º4
            
            let recommendation = '';
            let confidenceLevel = 0;
            let actionText = '';
            
            // è®¡ç®—ä¼˜åŠ¿å·®è·
            const advantage = bullScore - bearScore;
            
            if (bullScore >= strongSignal && advantage >= 3) {
                // å¼ºçƒˆåšå¤šï¼šæ»¡è¶³8ä¸ªç»´åº¦ä¸”é¢†å…ˆç©ºå¤´3åˆ†ä»¥ä¸Š
                strictText = `<span class="bullish-text">ğŸ”¥ å¼ºçƒˆåšå¤š (${bullScore}/${total})</span>`;
                details.unshift('ğŸ”¥å¼ºçƒˆåšå¤šä¿¡å·');
                confidenceLevel = Math.min(95, Math.round((bullScore / total) * 100 + advantage * 3));
                recommendation = `<strong style="color:#22c55e; font-size:16px">ğŸ“ˆ å¼ºçƒˆå»ºè®®åšå¤š</strong><br/>
                    <div style="margin-top:8px">
                        <span style="color:#22c55e">â— ä¿¡å¿ƒåº¦ï¼š${confidenceLevel}%</span> | 
                        <span style="color:#aaa">æ»¡è¶³ ${bullScore}/${total} ä¸ªæ¡ä»¶</span> | 
                        <span style="color:#22c55e">é¢†å…ˆ +${advantage}</span>
                    </div>
                    <div style="margin-top:8px; padding:8px; background:rgba(34,197,94,0.1); border-radius:6px;">
                        <small style="color:#22c55e; line-height:1.6">
                            æ ¸å¿ƒç†ç”±ï¼š${reasons.bull.slice(0, 3).join('ï¼›')}
                        </small>
                    </div>`;
                actionText = 'å¼ºçƒˆå»ºè®®åšå¤šï¼Œå¯é€‚å½“åŠ ä»“ï¼Œä¸¥æ ¼è®¾ç½®æ­¢æŸ';
            } else if (bearScore >= strongSignal && advantage <= -3) {
                // å¼ºçƒˆåšç©ºï¼šæ»¡è¶³8ä¸ªç»´åº¦ä¸”é¢†å…ˆå¤šå¤´3åˆ†ä»¥ä¸Š
                strictText = `<span class="bearish-text">ğŸ”¥ å¼ºçƒˆåšç©º (${bearScore}/${total})</span>`;
                details.unshift('ğŸ”¥å¼ºçƒˆåšç©ºä¿¡å·');
                confidenceLevel = Math.min(95, Math.round((bearScore / total) * 100 + Math.abs(advantage) * 3));
                recommendation = `<strong style="color:#ef4444; font-size:16px">ğŸ“‰ å¼ºçƒˆå»ºè®®åšç©º</strong><br/>
                    <div style="margin-top:8px">
                        <span style="color:#ef4444">â— ä¿¡å¿ƒåº¦ï¼š${confidenceLevel}%</span> | 
                        <span style="color:#aaa">æ»¡è¶³ ${bearScore}/${total} ä¸ªæ¡ä»¶</span> | 
                        <span style="color:#ef4444">é¢†å…ˆ +${Math.abs(advantage)}</span>
                    </div>
                    <div style="margin-top:8px; padding:8px; background:rgba(239,68,68,0.1); border-radius:6px;">
                        <small style="color:#ef4444; line-height:1.6">
                            æ ¸å¿ƒç†ç”±ï¼š${reasons.bear.slice(0, 3).join('ï¼›')}
                        </small>
                    </div>`;
                actionText = 'å¼ºçƒˆå»ºè®®å‡ä»“æˆ–åšç©ºï¼Œæ§åˆ¶é£é™©';
            } else if (bullScore >= moderateSignal && advantage >= 2) {
                // ä¸­åº¦åšå¤šï¼šæ»¡è¶³6ä¸ªç»´åº¦ä¸”é¢†å…ˆ2åˆ†
                strictText = `<span class="bullish-text">âœ… åšå¤š (${bullScore}/${total})</span>`;
                details.unshift('âœ…åšå¤šä¿¡å·');
                confidenceLevel = Math.round((bullScore / total) * 100 + advantage * 2);
                recommendation = `<strong style="color:#22c55e">ğŸ“ˆ å»ºè®®åšå¤š</strong><br/>
                    <div style="margin-top:6px">
                        <span style="color:#22c55e">â— ä¿¡å¿ƒåº¦ï¼š${confidenceLevel}%</span> | 
                        æ»¡è¶³ ${bullScore}/${total} ä¸ªæ¡ä»¶
                    </div>
                    <small style="color:#aaa">ç†ç”±ï¼š${reasons.bull.slice(0, 2).join('ï¼›')}</small>`;
                actionText = 'å»ºè®®é€‚å½“åšå¤šï¼Œæ§åˆ¶ä»“ä½ï¼Œè®¾ç½®æ­¢æŸ';
            } else if (bearScore >= moderateSignal && advantage <= -2) {
                // ä¸­åº¦åšç©ºï¼šæ»¡è¶³6ä¸ªç»´åº¦ä¸”é¢†å…ˆ2åˆ†
                strictText = `<span class="bearish-text">âœ… åšç©º (${bearScore}/${total})</span>`;
                details.unshift('âœ…åšç©ºä¿¡å·');
                confidenceLevel = Math.round((bearScore / total) * 100 + Math.abs(advantage) * 2);
                recommendation = `<strong style="color:#ef4444">ğŸ“‰ å»ºè®®åšç©º</strong><br/>
                    <div style="margin-top:6px">
                        <span style="color:#ef4444">â— ä¿¡å¿ƒåº¦ï¼š${confidenceLevel}%</span> | 
                        æ»¡è¶³ ${bearScore}/${total} ä¸ªæ¡ä»¶
                    </div>
                    <small style="color:#aaa">ç†ç”±ï¼š${reasons.bear.slice(0, 2).join('ï¼›')}</small>`;
                actionText = 'å»ºè®®é€‚å½“å‡ä»“ï¼Œè°¨æ…åšç©º';
            } else if (bullScore >= weakSignal && bullScore > bearScore) {
                // å¼±å¤šè§‚æœ›
                strictText = `<span style="color:#fbbf24">âš ï¸ åå¤šè§‚æœ› (${bullScore}/${total})</span>`;
                details.unshift('âš ï¸åå¤šä½†ä¿¡å·ä¸è¶³');
                confidenceLevel = Math.round((bullScore / total) * 100);
                recommendation = `<strong style="color:#fbbf24">ğŸ” åå¤šï¼Œå»ºè®®è§‚æœ›</strong><br/>
                    ä¿¡å¿ƒåº¦ï¼š${confidenceLevel}% | æ»¡è¶³ ${bullScore}/${total} ä¸ªæ¡ä»¶ï¼ˆéœ€â‰¥6å¼ºçƒˆï¼Œâ‰¥8æ›´ä½³ï¼‰<br/>
                    <small style="color:#aaa">å»ºè®®ï¼šç­‰å¾…æ›´å¤šåšå¤šä¿¡å·ç¡®è®¤ï¼Œæš‚æ—¶è§‚æœ›</small>`;
                actionText = 'åå¤šä½†ä¿¡å·ä¸è¶³ï¼Œå»ºè®®è§‚æœ›ç­‰å¾…';
            } else if (bearScore >= weakSignal && bearScore > bullScore) {
                // å¼±ç©ºè§‚æœ›
                strictText = `<span style="color:#fbbf24">âš ï¸ åç©ºè§‚æœ› (${bearScore}/${total})</span>`;
                details.unshift('âš ï¸åç©ºä½†ä¿¡å·ä¸è¶³');
                confidenceLevel = Math.round((bearScore / total) * 100);
                recommendation = `<strong style="color:#fbbf24">ğŸ” åç©ºï¼Œå»ºè®®è§‚æœ›</strong><br/>
                    ä¿¡å¿ƒåº¦ï¼š${confidenceLevel}% | æ»¡è¶³ ${bearScore}/${total} ä¸ªæ¡ä»¶ï¼ˆéœ€â‰¥6å¼ºçƒˆï¼Œâ‰¥8æ›´ä½³ï¼‰<br/>
                    <small style="color:#aaa">å»ºè®®ï¼šè€ƒè™‘è½»ä»“å‡æŒï¼Œç­‰å¾…åå¼¹æˆ–æ›´å¤šä¿¡å·</small>`;
                actionText = 'åç©ºä½†ä¿¡å·ä¸è¶³ï¼Œå»ºè®®è°¨æ…';
            } else {
                // è§‚æœ›
                strictText = `<span class="neutral-text">â›” æ–¹å‘ä¸æ˜ï¼Œè§‚æœ› (å¤š${bullScore}/ç©º${bearScore})</span>`;
                details.unshift('â›”æ–¹å‘ä¸æ˜ç¡®');
                confidenceLevel = 0;
                recommendation = `<strong style="color:#9ca3af">â›” æ–¹å‘ä¸æ˜ï¼Œä¸¥æ ¼è§‚æœ›</strong><br/>
                    å¤šç©ºåˆ†æ•°ï¼š${bullScore} vs ${bearScore} ï¼ˆå·®è·${Math.abs(advantage)}ï¼Œéœ€â‰¥2ä¸”å•è¾¹â‰¥6ï¼‰<br/>
                    <small style="color:#aaa">å½“å‰å¤šç©ºåŠ¿å‡åŠ›æ•Œï¼Œæ–¹å‘ä¸æ˜ç¡®ï¼Œå»ºè®®ç©ºä»“è§‚æœ›ï¼Œç­‰å¾…æ˜ç¡®ä¿¡å·</small>`;
                actionText = 'å¤šç©ºä¿¡å·æ··ä¹±ï¼Œå¼ºçƒˆå»ºè®®ç©ºä»“è§‚æœ›';
            }
            
            // å°†è¯¦ç»†ä¿¡æ¯æ·»åŠ åˆ°æ§åˆ¶å°ï¼Œä¾¿äºè°ƒè¯•
            console.log('ğŸ” å¤šç»´åº¦åˆ†æç»“æœ:', {
                å¤šå¤´å¾—åˆ†: bullScore,
                ç©ºå¤´å¾—åˆ†: bearScore,
                ä¿¡å¿ƒåº¦: confidenceLevel + '%',
                å¤šå¤´ç†ç”±: reasons.bull,
                ç©ºå¤´ç†ç”±: reasons.bear,
                æ“ä½œå»ºè®®: actionText,
                è¯¦ç»†: details.join(', ')
            });

            // æ˜¾ç¤ºä¿¡å·
            const signalsHTML = signals.map(s => 
                `<div class="signal ${s.type}">${s.text}</div>`
            ).join('');
            document.getElementById('signals').innerHTML = signalsHTML;

            // æ˜¾ç¤ºæŒ‡æ ‡é¢æ¿ï¼ˆæ·»åŠ è¯¦ç»†æ¨èï¼‰
            const panelHTML = `
                <div style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(102, 126, 234, 0.1)); 
                            padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #4facfe;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #4facfe;">
                        ğŸ¯ æ™ºèƒ½æ“ä½œå»ºè®®
                    </div>
                    <div style="font-size: 14px; line-height: 1.8;">
                        ${recommendation}
                    </div>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">è¶‹åŠ¿æ–¹å‘</span>
                    <span class="indicator-value">${trendText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">RSI(14)</span>
                    <span class="indicator-value">${rsiText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">MACD</span>
                    <span class="indicator-value">${macdText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">KDJ</span>
                    <span class="indicator-value">${kdjText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">å¸ƒæ—å¸¦</span>
                    <span class="indicator-value">${bollingerText}</span>
                </div>
                <div class="indicator-row">
                    <span class="indicator-name">ç»¼åˆä¿¡å·</span>
                    <span class="indicator-value">${strictText}</span>
                </div>
            `;
            document.getElementById('indicatorPanel').innerHTML = panelHTML;
        }

        // ä¸ºæ¯ä¸ªå›¾è¡¨å¡ç‰‡é™„åŠ â€œæ”¾å¤§/è¿˜åŸâ€ä¸â€œä¸‹è½½â€æŒ‰é’®
        function attachChartControls() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const container = card.querySelector('.chart-container');
                if (!container) return;
                if (card.querySelector('.chart-action-bar')) return; // é¿å…é‡å¤

                const bar = document.createElement('div');
                bar.className = 'chart-action-bar';

                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'chart-action-btn';
                toggleBtn.textContent = 'â¤¢ æ”¾å¤§';
                toggleBtn.addEventListener('click', () => {
                    const enlarged = container.classList.toggle('enlarged');
                    toggleBtn.textContent = enlarged ? 'â¤¡ è¿˜åŸ' : 'â¤¢ æ”¾å¤§';
                    // æ»šåŠ¨åˆ°è§†å›¾å¹¶é‡æ–°è®¡ç®—å°ºå¯¸
                    if (enlarged) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    setTimeout(() => resizeOrRedraw(container), 200);
                });

                const saveBtn = document.createElement('button');
                saveBtn.className = 'chart-action-btn';
                saveBtn.textContent = 'ğŸ–¼ ä¸‹è½½';
                saveBtn.addEventListener('click', () => {
                    const canvas = container.querySelector('canvas');
                    if (!canvas) return;
                    try {
                        const url = canvas.toDataURL('image/png', 1.0);
                        if (url && url.length > 100) {
                            const id = canvas.id || 'chart';
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `${currentSymbol || 'chart'}_${id}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                    } catch (e) { console.warn('ä¸‹è½½å¤±è´¥', e); }
                });

                bar.appendChild(toggleBtn);
                bar.appendChild(saveBtn);
                card.appendChild(bar);
            });
        }

        function resizeOrRedraw(container) {
            // Chart.jså›¾è¡¨ï¼šç›´æ¥resize
            const canvas = container.querySelector('canvas');
            if (!canvas) {
                console.warn('æœªæ‰¾åˆ°canvaså…ƒç´ ');
                return;
            }
            
            const id = canvas.id;
            console.log('ğŸ”„ è°ƒæ•´å›¾è¡¨å°ºå¯¸:', id);
            
            // Kçº¿å›¾ç‰¹æ®Šå¤„ç†ï¼šéœ€è¦é‡æ–°ç»˜åˆ¶
            if (id === 'candleCanvas' || container.id === 'candlestickChart') {
                if (stockData && currentIndicators) {
                    setTimeout(() => {
                        drawCandlestickChart(stockData, currentIndicators);
                        console.log('âœ… Kçº¿å›¾å·²é‡ç»˜');
                    }, 100);
                }
                return;
            }
            
            // Chart.jså›¾è¡¨ï¼šè°ƒç”¨resizeæ–¹æ³•
            if (id && id.endsWith('Chart')) {
                const key = id.replace('Chart', '');
                const chart = charts[key];
                if (chart && typeof chart.resize === 'function') {
                    // å¤šæ¬¡å°è¯•resizeï¼Œç¡®ä¿ç”Ÿæ•ˆ
                    setTimeout(() => {
                        chart.resize();
                        console.log('âœ… å›¾è¡¨å·²è°ƒæ•´:', key);
                    }, 100);
                    setTimeout(() => {
                        chart.resize();
                        chart.update('none'); // å¼ºåˆ¶æ›´æ–°
                    }, 300);
                } else {
                    console.warn('æœªæ‰¾åˆ°å›¾è¡¨å®ä¾‹:', key);
                }
            }
        }

        // ç»˜åˆ¶æ‰€æœ‰å›¾è¡¨
        function drawAllCharts(data, indicators) {
            // Kçº¿å’Œè¶‹åŠ¿
            drawCandlestickChart(data, indicators);
            drawBollingerChartLW(data, indicators);
            
            // è¶‹åŠ¿æŒ‡æ ‡
            drawMACDChart(data, indicators);
            drawSARChart(data, indicators);
            drawTRIXChart(data, indicators);
            
            // æ‘†åŠ¨æŒ‡æ ‡
            drawKDJChart(data, indicators);
            drawRSIChart(data, indicators);
            drawWRChart(data, indicators);
            drawCCIChart(data, indicators);
            drawStochChart(data, indicators);
            drawMOMChart(data, indicators);
            drawMFIChart(data, indicators);
            
            // è¶‹å‘æŒ‡æ ‡
            drawDMIChart(data, indicators);
            drawIchimokuChart(data, indicators);
            
            // æˆäº¤é‡æŒ‡æ ‡
            drawVolumeChart(data);
            drawOBVChart(data, indicators);
            drawVolumeRatioChart(data, indicators);
            drawVRChart(data, indicators);
            drawBRARChart(data, indicators);
            drawCRChart(data, indicators);
            drawADLChart(data, indicators);
            
            // æ³¢åŠ¨ç‡æŒ‡æ ‡
            drawATRChart(data, indicators);
            
            // æ–°å¢é«˜çº§æŒ‡æ ‡
            drawROCChart(data, indicators);
            drawBIASChart(data, indicators);
            drawPSYChart(data, indicators);
            drawEMVChart(data, indicators);
            drawAroonChart(data, indicators);
            drawDMAChart(data, indicators);
            drawEXPMAChart(data, indicators);
            
            // å½¢æ€åˆ†æ
            drawSupportResistanceChart(data);
        }

        // Kçº¿å›¾ï¼ˆçœŸæ­£çš„èœ¡çƒ›å›¾ - ä½¿ç”¨Canvasç»˜åˆ¶ï¼‰
        function drawCandlestickChart(data, indicators) {
            const container = document.getElementById('candlestickChart');
            container.innerHTML = '<canvas id="candleCanvas"></canvas>';
            
            const canvas = document.getElementById('candleCanvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®canvaså°ºå¯¸
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // è®¡ç®—ç»˜å›¾åŒºåŸŸ
            const padding = { top: 40, right: 80, bottom: 60, left: 60 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            
            // è®¡ç®—ä»·æ ¼èŒƒå›´
            const allPrices = data.flatMap(d => [d.high, d.low]);
            const maxPrice = Math.max(...allPrices);
            const minPrice = Math.min(...allPrices);
            const priceRange = maxPrice - minPrice;
            
            // è¾…åŠ©å‡½æ•°ï¼šä»·æ ¼è½¬Yåæ ‡
            const priceToY = (price) => {
                return padding.top + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
            };
            
            // è¾…åŠ©å‡½æ•°ï¼šç´¢å¼•è½¬Xåæ ‡
            const indexToX = (index) => {
                const candleWidth = chartWidth / data.length;
                return padding.left + index * candleWidth + candleWidth / 2;
            };
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#0f1429';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#2d3561';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartWidth, y);
                ctx.stroke();
                
                // ä»·æ ¼æ ‡ç­¾
                const price = maxPrice - (priceRange / 5) * i;
                ctx.fillStyle = '#aaa';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(price.toFixed(2), padding.left - 10, y + 4);
            }
            
            // ç»˜åˆ¶Kçº¿
            const candleWidth = Math.max(2, chartWidth / data.length - 2);
            data.forEach((d, i) => {
                const x = indexToX(i);
                const openY = priceToY(d.open);
                const closeY = priceToY(d.close);
                const highY = priceToY(d.high);
                const lowY = priceToY(d.low);
                
                const isUp = d.close >= d.open;
                const color = isUp ? '#22c55e' : '#ef4444';
                
                // ç»˜åˆ¶å½±çº¿ï¼ˆä¸Šä¸‹å½±çº¿ï¼‰
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.stroke();
                
                // ç»˜åˆ¶å®ä½“
                ctx.fillStyle = color;
                const bodyHeight = Math.abs(closeY - openY);
                const bodyY = Math.min(openY, closeY);
                ctx.fillRect(x - candleWidth / 2, bodyY, candleWidth, Math.max(1, bodyHeight));
            });
            
            // ç»˜åˆ¶å‡çº¿
            const maLines = [
                { data: indicators.ma5, color: '#22c55e', label: 'MA5' },
                { data: indicators.ma10, color: '#f59e0b', label: 'MA10' },
                { data: indicators.ma20, color: '#a855f7', label: 'MA20' },
                { data: indicators.ma60, color: '#ec4899', label: 'MA60' }
            ];
            
            maLines.forEach(ma => {
                ctx.strokeStyle = ma.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                let started = false;
                data.forEach((d, i) => {
                    if (ma.data[i] !== null) {
                        const x = indexToX(i);
                        const y = priceToY(ma.data[i]);
                        if (!started) {
                            ctx.moveTo(x, y);
                            started = true;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                });
                ctx.stroke();
            });
            
            // ç»˜åˆ¶å›¾ä¾‹
            let legendX = padding.left;
            const legendY = 20;
            maLines.forEach(ma => {
                ctx.fillStyle = ma.color;
                ctx.fillRect(legendX, legendY - 5, 15, 3);
                ctx.fillStyle = '#aaa';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(ma.label, legendX + 20, legendY);
                legendX += 80;
            });
            
            // ç»˜åˆ¶æ—¥æœŸï¼ˆåªæ˜¾ç¤ºéƒ¨åˆ†ï¼‰
            ctx.fillStyle = '#aaa';
            ctx.font = '11px Arial';
            ctx.textAlign = 'center';
            const dateStep = Math.ceil(data.length / 8);
            for (let i = 0; i < data.length; i += dateStep) {
                const x = indexToX(i);
                const date = data[i].date.substring(5); // åªæ˜¾ç¤ºæœˆ-æ—¥
                ctx.fillText(date, x, canvas.height - padding.bottom + 20);
            }
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#4facfe';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Kçº¿å›¾ä¸å‡çº¿ç³»ç»Ÿ', padding.left, 25);
            
            // ä¿å­˜åˆ°chartså¯¹è±¡
            charts.candlestick = { canvas, redraw: () => drawCandlestickChart(data, indicators) };
            
            // å“åº”å¼
            window.addEventListener('resize', () => {
                if (charts.candlestick && charts.candlestick.redraw) {
                    charts.candlestick.redraw();
                }
            });
        }

        // å¸ƒæ—å¸¦å›¾è¡¨ï¼ˆä½¿ç”¨Chart.jsï¼‰
        function drawBollingerChartLW(data, indicators) {
            const container = document.getElementById('bollingerChart');
            container.innerHTML = '<canvas id="bollingerCanvas"></canvas>';
            
            const ctx = document.getElementById('bollingerCanvas').getContext('2d');
            if (charts.bollinger) charts.bollinger.destroy();

            const dates = data.map(d => d.date);

            charts.bollinger = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'ä¸Šè½¨',
                            data: indicators.bollinger.upper,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'ä¸­è½¨',
                            data: indicators.bollinger.middle,
                            borderColor: '#facc15',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'ä¸‹è½¨',
                            data: indicators.bollinger.lower,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // å…¶ä»–å›¾è¡¨å‡½æ•°ï¼ˆä½¿ç”¨Chart.jsï¼‰
        function drawMACDChart(data, indicators) {
            const ctx = document.getElementById('macdChart').getContext('2d');
            if (charts.macd) charts.macd.destroy();

            const dates = data.map(d => d.date);
            const colors = indicators.macd.macd.map(val => val >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)');

            charts.macd = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'MACD',
                            data: indicators.macd.macd,
                            backgroundColor: colors,
                            borderWidth: 0
                        },
                        {
                            label: 'DIF',
                            data: indicators.macd.dif,
                            type: 'line',
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'DEA',
                            data: indicators.macd.dea,
                            type: 'line',
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        function drawKDJChart(data, indicators) {
            const ctx = document.getElementById('kdjChart').getContext('2d');
            if (charts.kdj) charts.kdj.destroy();

            charts.kdj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'K',
                            data: indicators.kdj.k,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'D',
                            data: indicators.kdj.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'J',
                            data: indicators.kdj.j,
                            borderColor: '#a855f7',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        function drawRSIChart(data, indicators) {
            const ctx = document.getElementById('rsiChart').getContext('2d');
            if (charts.rsi) charts.rsi.destroy();

            charts.rsi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'RSI(6)',
                            data: indicators.rsi6,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'RSI(12)',
                            data: indicators.rsi12,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'RSI(14)',
                            data: indicators.rsi,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        function drawWRChart(data, indicators) {
            const ctx = document.getElementById('wrChart').getContext('2d');
            if (charts.wr) charts.wr.destroy();

            charts.wr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'WR(14)',
                        data: indicators.wr,
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: -100, max: 0 } } }
            });
        }

        function drawCCIChart(data, indicators) {
            const ctx = document.getElementById('cciChart').getContext('2d');
            if (charts.cci) charts.cci.destroy();

            charts.cci = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'CCI(14)',
                        data: indicators.cci,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawDMIChart(data, indicators) {
            const ctx = document.getElementById('dmiChart').getContext('2d');
            if (charts.dmi) charts.dmi.destroy();

            charts.dmi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'PDI',
                            data: indicators.dmi.pdi,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'MDI',
                            data: indicators.dmi.mdi,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'ADX',
                            data: indicators.dmi.adx,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        function drawVolumeChart(data) {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            if (charts.volume) charts.volume.destroy();

            const colors = data.map((d, i) => {
                if (i === 0) return '#4facfe';
                return d.close >= d.open ? '#22c55e' : '#ef4444';
            });

            charts.volume = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'æˆäº¤é‡',
                        data: data.map(d => d.volume),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawOBVChart(data, indicators) {
            const ctx = document.getElementById('obvChart').getContext('2d');
            if (charts.obv) charts.obv.destroy();

            charts.obv = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'OBV',
                        data: indicators.obv,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawVolumeRatioChart(data, indicators) {
            const ctx = document.getElementById('volumeRatioChart').getContext('2d');
            if (charts.volumeRatio) charts.volumeRatio.destroy();

            const colors = indicators.volumeRatio.map(r => {
                if (!r) return '#4facfe';
                return r > 1 ? '#22c55e' : '#ef4444';
            });

            charts.volumeRatio = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'é‡æ¯”',
                        data: indicators.volumeRatio,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        function drawSupportResistanceChart(data) {
            const container = document.getElementById('supportResistanceChart');
            container.innerHTML = '<canvas id="supportResistanceCanvas"></canvas>';
            
            const ctx = document.getElementById('supportResistanceCanvas').getContext('2d');
            if (charts.supportResistance) charts.supportResistance.destroy();

            // è®¡ç®—æ”¯æ’‘å‹åŠ›ä½
            const highs = data.map(d => d.high);
            const lows = data.map(d => d.low);
            const resistance = Math.max(...highs.slice(-20));
            const support = Math.min(...lows.slice(-20));
            
            const dates = data.map(d => d.date);

            charts.supportResistance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            pointRadius: 0
                        },
                        {
                            label: 'å‹åŠ›ä½',
                            data: data.map(() => resistance),
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'æ”¯æ’‘ä½',
                            data: data.map(() => support),
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // å½¢æ€è¯†åˆ«
        function displayPatterns(data) {
            const patterns = [];
            const len = data.length;
            
            // æ£€æµ‹æœ€è¿‘çš„Kçº¿å½¢æ€
            if (len >= 3) {
                const d1 = data[len - 3];
                const d2 = data[len - 2];
                const d3 = data[len - 1];
                
                // æ—©æ™¨ä¹‹æ˜Ÿ
                if (d1.close < d1.open && 
                    Math.abs(d2.close - d2.open) < (d1.open - d1.close) * 0.3 &&
                    d3.close > d3.open &&
                    d3.close > (d1.open + d1.close) / 2) {
                    patterns.push({ name: 'æ—©æ™¨ä¹‹æ˜Ÿ', type: 'buy', desc: 'åº•éƒ¨åè½¬ä¿¡å·ï¼Œé¢„ç¤ºä¸Šæ¶¨' });
                }
                
                // é»„æ˜ä¹‹æ˜Ÿ
                if (d1.close > d1.open && 
                    Math.abs(d2.close - d2.open) < (d1.close - d1.open) * 0.3 &&
                    d3.close < d3.open &&
                    d3.close < (d1.open + d1.close) / 2) {
                    patterns.push({ name: 'é»„æ˜ä¹‹æ˜Ÿ', type: 'sell', desc: 'é¡¶éƒ¨åè½¬ä¿¡å·ï¼Œé¢„ç¤ºä¸‹è·Œ' });
                }
            }
            
            // é”¤å­çº¿
            if (len >= 1) {
                const d = data[len - 1];
                const body = Math.abs(d.close - d.open);
                const lowerShadow = Math.min(d.open, d.close) - d.low;
                const upperShadow = d.high - Math.max(d.open, d.close);
                
                if (lowerShadow > body * 2 && upperShadow < body * 0.3) {
                    patterns.push({ name: 'é”¤å­çº¿', type: 'buy', desc: 'åº•éƒ¨åè½¬ä¿¡å·' });
                }
                
                if (upperShadow > body * 2 && lowerShadow < body * 0.3) {
                    patterns.push({ name: 'å€’é”¤å­çº¿', type: 'sell', desc: 'é¡¶éƒ¨åè½¬ä¿¡å·' });
                }
            }
            
            let html = '';
            if (patterns.length > 0) {
                html = patterns.map(p => `
                    <div class="signal ${p.type}" style="display: block; margin-bottom: 10px; padding: 15px;">
                        <strong>${p.name}</strong><br>
                        <span style="font-size: 13px; opacity: 0.9;">${p.desc}</span>
                    </div>
                `).join('');
            } else {
                html = '<div class="info-box"><p>æš‚æœªè¯†åˆ«åˆ°æ˜æ˜¾çš„Kçº¿å½¢æ€</p></div>';
            }
            
            document.getElementById('patternResults').innerHTML = html;
            
            // è¶‹åŠ¿åˆ†æ
            const ma20 = calculateMA(data, 20);
            const trend = ma20[ma20.length - 1] > ma20[ma20.length - 20] ? 'ä¸Šå‡' : 'ä¸‹é™';
            document.getElementById('trendAnalysis').innerHTML = `
                <div class="info-box">
                    <h3>è¶‹åŠ¿æ–¹å‘</h3>
                    <p>å½“å‰20æ—¥å‡çº¿å‘ˆ<strong>${trend}è¶‹åŠ¿</strong></p>
                    <p>MA20: ${ma20[ma20.length - 1]?.toFixed(2)}</p>
                </div>
            `;
        }

        // ç»˜åˆ¶SARå›¾è¡¨
        function drawSARChart(data, indicators) {
            const ctx = document.getElementById('sarChart').getContext('2d');
            if (charts.sar) charts.sar.destroy();

            charts.sar = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'SAR',
                            data: indicators.sar,
                            borderColor: '#f59e0b',
                            borderWidth: 0,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b',
                            showLine: false
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶TRIXå›¾è¡¨
        function drawTRIXChart(data, indicators) {
            const ctx = document.getElementById('trixChart').getContext('2d');
            if (charts.trix) charts.trix.destroy();

            charts.trix = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'TRIX',
                        data: indicators.trix,
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶Stochå›¾è¡¨
        function drawStochChart(data, indicators) {
            const ctx = document.getElementById('stochChart').getContext('2d');
            if (charts.stoch) charts.stoch.destroy();

            charts.stoch = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: '%K',
                            data: indicators.stoch.k,
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: '%D',
                            data: indicators.stoch.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        // ç»˜åˆ¶ATRå›¾è¡¨
        function drawATRChart(data, indicators) {
            const ctx = document.getElementById('atrChart').getContext('2d');
            if (charts.atr) charts.atr.destroy();

            charts.atr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'ATR(14)',
                        data: indicators.atr,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶VRå›¾è¡¨
        function drawVRChart(data, indicators) {
            const ctx = document.getElementById('vrChart').getContext('2d');
            if (charts.vr) charts.vr.destroy();

            charts.vr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'VR',
                        data: indicators.vr,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶BRARå›¾è¡¨
        function drawBRARChart(data, indicators) {
            const ctx = document.getElementById('brarChart').getContext('2d');
            if (charts.brar) charts.brar.destroy();

            charts.brar = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'BR',
                            data: indicators.brar.br,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'AR',
                            data: indicators.brar.ar,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶CRå›¾è¡¨
        function drawCRChart(data, indicators) {
            const ctx = document.getElementById('crChart').getContext('2d');
            if (charts.cr) charts.cr.destroy();

            charts.cr = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'CR',
                        data: indicators.cr,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶MOMå›¾è¡¨
        function drawMOMChart(data, indicators) {
            const ctx = document.getElementById('momChart').getContext('2d');
            if (charts.mom) charts.mom.destroy();

            charts.mom = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'MOM(10)',
                        data: indicators.mom,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶MFIå›¾è¡¨
        function drawMFIChart(data, indicators) {
            const ctx = document.getElementById('mfiChart').getContext('2d');
            if (charts.mfi) charts.mfi.destroy();

            charts.mfi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'MFI(14)',
                        data: indicators.mfi,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        // ç»˜åˆ¶ADLå›¾è¡¨
        function drawADLChart(data, indicators) {
            const ctx = document.getElementById('adlChart').getContext('2d');
            if (charts.adl) charts.adl.destroy();

            charts.adl = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'A/D Line',
                        data: indicators.adl,
                        borderColor: '#14b8a6',
                        backgroundColor: 'rgba(20, 184, 166, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶Ichimokuå›¾è¡¨
        function drawIchimokuChart(data, indicators) {
            const ctx = document.getElementById('ichimokuChart').getContext('2d');
            if (charts.ichimoku) charts.ichimoku.destroy();

            charts.ichimoku = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'è½¬æ¢çº¿',
                            data: indicators.ichimoku.tenkan,
                            borderColor: '#ef4444',
                            borderWidth: 1.5,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'åŸºå‡†çº¿',
                            data: indicators.ichimoku.kijun,
                            borderColor: '#3b82f6',
                            borderWidth: 1.5,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'å…ˆè¡Œå¸¦A',
                            data: indicators.ichimoku.senkouA,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 1,
                            fill: '+1',
                            pointRadius: 0
                        },
                        {
                            label: 'å…ˆè¡Œå¸¦B',
                            data: indicators.ichimoku.senkouB,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 1,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶ROCå›¾è¡¨
        function drawROCChart(data, indicators) {
            const ctx = document.getElementById('rocChart').getContext('2d');
            if (charts.roc) charts.roc.destroy();
            
            charts.roc = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'ROC(12)',
                        data: indicators.roc,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶BIASå›¾è¡¨
        function drawBIASChart(data, indicators) {
            const ctx = document.getElementById('biasChart').getContext('2d');
            if (charts.bias) charts.bias.destroy();
            
            charts.bias = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'BIAS(6)',
                        data: indicators.bias,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶PSYå›¾è¡¨
        function drawPSYChart(data, indicators) {
            const ctx = document.getElementById('psyChart').getContext('2d');
            if (charts.psy) charts.psy.destroy();
            
            charts.psy = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'PSY(12)',
                        data: indicators.psy,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        // ç»˜åˆ¶EMVå›¾è¡¨
        function drawEMVChart(data, indicators) {
            const ctx = document.getElementById('emvChart').getContext('2d');
            if (charts.emv) charts.emv.destroy();
            
            charts.emv = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'EMV(14)',
                        data: indicators.emv,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶Aroonå›¾è¡¨
        function drawAroonChart(data, indicators) {
            const ctx = document.getElementById('aroonChart').getContext('2d');
            if (charts.aroon) charts.aroon.destroy();
            
            charts.aroon = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Aroon Up',
                            data: indicators.aroon.up,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Aroon Down',
                            data: indicators.aroon.down,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: { ...getChartOptions(), scales: { ...getChartOptions().scales, y: { ...getChartOptions().scales.y, min: 0, max: 100 } } }
            });
        }

        // ç»˜åˆ¶DMAå›¾è¡¨
        function drawDMAChart(data, indicators) {
            const ctx = document.getElementById('dmaChart').getContext('2d');
            if (charts.dma) charts.dma.destroy();
            
            charts.dma = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'DMA',
                            data: indicators.dma.dma,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'AMA',
                            data: indicators.dma.ama,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // ç»˜åˆ¶EXPMAå›¾è¡¨
        function drawEXPMAChart(data, indicators) {
            const ctx = document.getElementById('expmaChart').getContext('2d');
            if (charts.expma) charts.expma.destroy();
            
            charts.expma = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: data.map(d => d.close),
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'EXPMA(12)',
                            data: indicators.expma.expma1,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'EXPMA(50)',
                            data: indicators.expma.expma2,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: getChartOptions()
            });
        }

        // é€šç”¨å›¾è¡¨é…ç½®
        function getChartOptions(yAxisConfig = {}) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: { 
                            color: '#aaa', 
                            font: { size: 12 },
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 13 },
                        bodyFont: { size: 12 },
                        padding: 12,
                        displayColors: true
                    }
                },
                scales: {
                    x: {
                        grid: { 
                            color: '#2d3561',
                            drawBorder: false
                        },
                        ticks: { 
                            color: '#aaa', 
                            maxTicksLimit: 15, 
                            font: { size: 11 },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        grid: { 
                            color: '#2d3561',
                            drawBorder: false
                        },
                        ticks: { 
                            color: '#aaa', 
                            font: { size: 11 },
                            precision: 2,
                            callback: function(value) {
                                return value.toFixed(2);
                            }
                        },
                        ...yAxisConfig
                    }
                }
            };
        }
    </script>
</body>
</html>
